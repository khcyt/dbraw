const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof kh_global.window&&"undefined"===typeof kh_global.process&&kh_global.self;const cf="kh_components";const mf="kh_components_draggable_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof kh_global.window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof kh_global.process?"node.js":"undefined"!==typeof kh_global.self?kh_global.self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import{isValid,isEmpty}from"/contrib/jsm/kh_earlybird.js";import{JSON8MergePatch,Error}from"/contrib/jsm/kh_classes.js";import{getRandomArbitrary}from"/contrib/jsm/kh_functions.js";const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,()=>name);import{vjs,Rect}from"/contrib/jsm/kh_vanilla.js";import{Component}from"/contrib/jsm/kh_components_base.js";class DraggableComponent extends Component{static flag="draggable";base(component_base){if(isValid(component_base)&&!(component_base instanceof Draggable))throw new Error({msg:["invalid-argument","draggable",arguments[0]]});return super.base(component_base)}}export class Draggable extends DraggableComponent{#id_=getRandomArbitrary()|0;#ns_=`${mf}.${this.#id_}`;#options_;#Șdom_;static#def_classes_={draggable:"kh-drg-element",dragging:"dragging"};constructor(draggable_element_or_selector,{classes=Draggable.#def_classes_,native=false}={}){super();this.#options_=JSON8MergePatch.apply(JSON8MergePatch.apply({classes:Draggable.#def_classes_},{classes}),arguments[1]??{});draggable_element_or_selector=vjs(draggable_element_or_selector,true)?.[0];if(!isValid(draggable_element_or_selector))throw new Error({msg:["invalid-argument","draggable_element"]});this.#Șdom_=draggable_element_or_selector;this.base(this);this.glue(this);this.Șdom.classList.add(this.options.classes.draggable);const position=vjs.style(this.Șdom,"position");if("fixed"==position)throw new Error({msg:["param-not-match","position","fixed","param-expected","absolute/relative"]});if("absolute"!=position){kh_log.warn?.(T9`draggable may not work for ${vjs.attr(draggable_element_or_selector,"id")??draggable_element_or_selector}`)}if(true==native)return;const curRect=()=>{const cur_client_size=vjs.outerSize(this.Șdom);const cur_client_rect=new Rect({x:0,y:0,...cur_client_size});cur_client_rect.removeStyle(this.Șdom,[Rect.styleFlag.sF_padding,Rect.styleFlag.sF_border]);const cur_rect_wm=vjs.outerRect(this.Șdom,true);return new Rect({x:cur_rect_wm.x,y:cur_rect_wm.y,width:cur_client_rect.width,height:cur_client_rect.height})};vjs.on("pointerdown",event=>{if(0!=event.button)return;let last_pos={x:event.clientX,y:event.clientY};const cur_rect=curRect();kh_log.trace?.(T9`pointerdown@${Draggable.flag} last_pos(${last_pos}), cur Rect({${cur_rect.x}, ${cur_rect.width}})`);const othis=this;function onmove(event){const{clientX:x,clientY:y}=event;const cur_rect=curRect();const new_rect=DOMRect.fromRect(cur_rect);let delta={x:x-last_pos.x,y:y-last_pos.y};new_rect.x+=delta.x;new_rect.y+=delta.y;last_pos={x,y};const style={};style.left=`${new_rect.left}px`;style.right="revert";style.top=`${new_rect.top}px`;style.bottom="revert";vjs.style(othis.Șdom,style)}vjs.on(`pointermove.${this.#ns_}`,onmove,window);vjs.one(`pointerup.${this.#ns_}`,event=>{kh_log.trace?.(T9`event ${event.type} received`);vjs.off(`.${this.#ns_}`,undefined,undefined)},window)},this.Șdom)}get Șdom(){return this.#Șdom_}get options(){return this.#options_}}export class DragDrop extends Draggable{static#def_classes_={draggable:"kh-drgdrp-element",dragging:""};constructor(dragdrop_container_or_selector,{classes=DragDrop.#def_classes_,draggables_selector,ondragstart,ondragend,ondragover,ondrop}={}){super(dragdrop_container_or_selector,JSON8MergePatch.apply(JSON8MergePatch.apply({classes:DragDrop.#def_classes_,native:true},{classes}),arguments[1]??{}));const is_function=Function.isFunction(draggables_selector);const draggables=!is_function?vjs(this.Șdom,draggables_selector,true)||[]:undefined;if(!is_function&&isEmpty(draggables))return;const dragstart=Function.isFunction(ondragstart)?ondragstart:event=>event.target.classList.add(this.options.classes.dragging);const dragend=Function.isFunction(ondragend)?ondragend:event=>event.target.classList.remove(this.options.classes.dragging);if(1==draggables?.length){const dragstart=Function.isFunction(ondragstart)?ondragstart:event=>event.target.classList.add(this.options.classes.dragging);const dragend=Function.isFunction(ondragend)?ondragend:event=>event.target.classList.remove(this.options.classes.dragging);vjs.on("dragstart",dragstart,draggables[0]);vjs.on("dragend",dragend,draggables[0])}else{const dragstart=Function.isFunction(ondragstart)?ondragstart:(event,draggable)=>draggable.classList.add(this.options.classes.dragging);const dragend=Function.isFunction(ondragend)?ondragend:(event,draggable)=>draggable.classList.remove(this.options.classes.dragging);vjs.onc("dragstart",(event,draggable)=>{draggable??=event.target;return dragstart(event,draggable)},this.Șdom,draggables_selector);vjs.onc("dragend",(event,draggable)=>{draggable??=event.target;return dragend?.(event,draggable)},this.Șdom,draggables_selector)}vjs.on("dragover",event=>ondragover?.(event),this.Șdom);vjs.on("drop",event=>ondrop?.(event),this.Șdom)}}kh_global.LoadedScripts.get(mf).resolve(ms);