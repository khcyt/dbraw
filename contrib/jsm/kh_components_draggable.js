const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_components";const mf="kh_components_draggable_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import*as kh_js_e from"/contrib/jsm/kh_earlybird.js";import*as kh_js_c from"/contrib/jsm/kh_classes.js";import*as kh_js_f from"/contrib/jsm/kh_functions.js";const kh_js=Object.assign({...kh_js_e},{...kh_js_c},{...kh_js_f});const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,(()=>name));import{vjs,Rect}from"/contrib/jsm/kh_vanilla.js";import*as vjs2 from"/contrib/jsm/kh_vanilla2.js";Object.assign(vjs,{...vjs2});import{Component,class_from_orient}from"/contrib/jsm/kh_components_base.js";export class Draggable extends Component{#id_=kh_js.getRandomArbitrary()|0;#ns_=`${mf}.${this.#id_}`;#options_;#Șdom_;static flag="draggable";base(){if(0!==arguments.length&&!(arguments[0]instanceof Draggable))throw new Error({msg:["invalid-argument","draggable",arguments[0]]});return super.base(...arguments??[])}static#def_classes_={draggable:"kh-drg-element",dragging:"dragging"};constructor(draggable_element_or_selector,{classes=Draggable.#def_classes_,native=false}={}){super();this.#options_=kh_js.JSON8MergePatch.apply(kh_js.JSON8MergePatch.apply({classes:Draggable.#def_classes_},{classes}),arguments[1]??{});draggable_element_or_selector=vjs(draggable_element_or_selector,true)?.[0];if(!kh_js.isValid(draggable_element_or_selector))throw new kh_js.Error({msg:["invalid-argument","draggable_element"]});this.#Șdom_=draggable_element_or_selector;this.base(this);this.glue(this);this.Șdom.classList.add(this.options.classes.draggable);const position=vjs.style(this.Șdom,"position");if("fixed"==position)throw new kh_js.Error({msg:["param-not-match","position","fixed","param-expected","absolute/relative"]});if("absolute"!=position){kh_log.warn?.(T9`draggable may not work for ${vjs.attr(draggable_element_or_selector,"id")??draggable_element_or_selector}`)}if(true==native)return;const curRect=()=>{const cur_client_size=vjs.outerSize(this.Șdom);const cur_client_rect=new Rect({x:0,y:0,...cur_client_size});cur_client_rect.removeStyle(this.Șdom,[Rect.styleFlag.sF_padding,Rect.styleFlag.sF_border]);const cur_rect_wm=vjs.outerRect(this.Șdom,true);return new Rect({x:cur_rect_wm.x,y:cur_rect_wm.y,width:cur_client_rect.width,height:cur_client_rect.height})};vjs.on("pointerdown",(event=>{if(0!=event.button)return;let last_pos={x:event.clientX,y:event.clientY};const cur_rect=curRect();kh_log.trace?.(T9`pointerdown@${Draggable.flag} last_pos(${last_pos}), cur Rect({${cur_rect.x}, ${cur_rect.width}})`);const othis=this;function onmove(event){const{clientX:x,clientY:y}=event;const cur_rect=curRect();const new_rect=DOMRect.fromRect(cur_rect);let delta={x:x-last_pos.x,y:y-last_pos.y};new_rect.x+=delta.x;new_rect.y+=delta.y;last_pos={x,y};const style={};style.left=`${new_rect.left}px`;style.right="revert";style.top=`${new_rect.top}px`;style.bottom="revert";vjs.style(othis.Șdom,style)}vjs.on(`pointermove.${this.#ns_}`,onmove,window);vjs.one(`pointerup.${this.#ns_}`,(event=>{kh_log.trace?.(T9`event ${event.type} received`);vjs.off(`.${this.#ns_}`,undefined,undefined)}),window)}),this.Șdom)}get Șdom(){return this.#Șdom_}get options(){return this.#options_}}export class DragDrop extends Draggable{static#def_classes_={draggable:"kh-drgdrp-element"};constructor(dragdrop_container_or_selector,{classes=DragDrop.#def_classes_,draggables_selector,ondragstart,ondragend,ondragover,ondrop}={}){super(dragdrop_container_or_selector,kh_js.JSON8MergePatch.apply(kh_js.JSON8MergePatch.apply({classes:DragDrop.#def_classes_,native:true},{classes}),arguments[1]??{}));const is_function="function"===typeof draggables_selector;const draggables=!is_function?vjs(this.Șdom,draggables_selector,true)||[]:undefined;if(!is_function&&kh_js.isEmpty(draggables))return;const dragstart="function"==typeof ondragstart?ondragstart:event=>event.target.classList.add(this.options.classes.dragging);const dragend="function"==typeof ondragend?ondragend:event=>event.target.classList.remove(this.options.classes.dragging);if(1==draggables?.length){const dragstart="function"==typeof ondragstart?ondragstart:event=>event.target.classList.add(this.options.classes.dragging);const dragend="function"==typeof ondragend?ondragend:event=>event.target.classList.remove(this.options.classes.dragging);vjs.on("dragstart",dragstart,draggables[0]);vjs.on("dragend",dragend,draggables[0])}else{const dragstart="function"==typeof ondragstart?ondragstart:(event,draggable)=>draggable.classList.add(this.options.classes.dragging);const dragend="function"==typeof ondragend?ondragend:(event,draggable)=>draggable.classList.remove(this.options.classes.dragging);vjs.onc("dragstart",((event,draggable)=>{draggable??=event.target;return dragstart(event,draggable)}),this.Șdom,draggables_selector);vjs.onc("dragend",((event,draggable)=>{draggable??=event.target;return dragend?.(event,draggable)}),this.Șdom,draggables_selector)}vjs.on("dragover",(event=>ondragover?.(event)),this.Șdom);vjs.on("drop",(event=>ondrop?.(event)),this.Șdom)}}kh_global.LoadedScripts.get(mf).resolve(ms);