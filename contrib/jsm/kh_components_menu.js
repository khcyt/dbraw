const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof kh_global.window&&"undefined"===typeof kh_global.process&&kh_global.self;const cf="kh_components";const mf="kh_components_menu_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof kh_global.window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof kh_global.process?"node.js":"undefined"!==typeof kh_global.self?kh_global.self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import{isValid,isEmpty,isNumber,getTypeName}from"/contrib/jsm/kh_earlybird.js";import{Error,JSON8MergePatch}from"/contrib/jsm/kh_classes.js";import{getRandomArbitrary,defer}from"/contrib/jsm/kh_functions.js";const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,()=>name);import{vjs}from"/contrib/jsm/kh_vanilla.js";import*as vjs2 from"/contrib/jsm/kh_vanilla2.js";Object.assign(vjs,{...vjs2});import{Component,class_from_orient}from"/contrib/jsm/kh_components_base.js";import{tooltip as kh_tooltip}from"/contrib/jsm/kh_web_html_tooltip.js";class MenuComponent extends Component{static flag="menu";base(component_base){if(isValid(component_base)&&!(component_base instanceof Menu))throw new Error({msg:["invalid-argument","menu",arguments[0]]});return super.base(component_base)}}const use_popup_api=Function.isFunction(HTMLElement.prototype.showPopover)&&true;const must_popup_positioned=use_popup_api&&!CSS.supports("bottom:anchor(top)")||false;export class Menu extends MenuComponent{#id_=getRandomArbitrary()|0;#ns_=`${mf}.${this.#id_}`;#parent_;#Șmenu_nav_;#options_;static#def_classes_={menu:"menu-nav",title:"menu-title",group:"menu-group",item:"menu-item",label:"menu-label"};static#def_roles_={menu:"menu",title:"menutitle",group:"menugroup",item:"menuitem",label:"menulabel",popup:"popup-menu"};constructor(parent,{id,classz,classes=Menu.#def_classes_,roles=Menu.#def_roles_,orientation="horizontal",title,tagName="nav",connect_items=true}={}){super();const further_argz=arguments[1];this.#options_=JSON8MergePatch.apply(JSON8MergePatch.apply({classes:Menu.#def_classes_,roles:Menu.#def_roles_},{id,classes,roles,orientation,title,tagName}),further_argz??{});this.#parent_=vjs(parent)?.[0];this.#Șmenu_nav_=vjs.create(tagName,{id,class:`${this.#options_.classes.menu}${!isEmpty(classz)?` ${classz}`:""}`});this.base(this);this.glue(this);this.role(this.#options_.roles.menu);if(!isEmpty(title)){this.#Șmenu_nav_.append(vjs.create("h2",{class:this.#options_.classes.title,text:title,attr:{role:this.options.roles.title},data:{role:this.options.roles.title}}))}this.group();if(isValid(this.#parent_)){const old_menu=!isEmpty(id)?vjs(this.#parent_,`#${id}`,false):undefined;if(isValid(old_menu)){const attr_names=old_menu.getAttributeNames().filter(an=>-1==["id","class"].indexOf(an)).map(an=>[an,undefined]);const attrs=vjs.attr(old_menu,Object.fromEntries(attr_names));vjs.attr(this.#Șmenu_nav_,attrs);this.#parent_.replaceChild(this.#Șmenu_nav_,old_menu)}else this.#parent_.append(this.#Șmenu_nav_)}if(true==connect_items){vjs.onc(`pointerdown.${this.ns}`,this.#clickHandler.bind(this),this.Șdom,`[role="${this.options.roles.item}"] [role="${this.options.roles.label}"]`);vjs.onc(`toggle.${this.ns}`,this.#clickHandler.bind(this),this.Șdom,`[role="${this.options.roles.group}"][popover]`,{capture:true})}this.clone=function(parent){const new_menu=new Menu(parent,further_argz);this.childGroup()?.clone(new_menu);return new_menu}}group(item,opts){return new Menu.Group(this,item,{sub_popup:item?.subPopup(),...opts??{}})}item(item_or_group,opts){return new Menu.Item(this,item_or_group,opts)}add(child_title_or_group,relay=true){if(!isValid(child_title_or_group))throw new Error({msg:["invalid-argument","title-or-group"]});if(child_title_or_group instanceof Menu.Group){if(-1==[...this.Șdom.children].indexOf(child_title_or_group.Șdom))this.Șdom.append(child_title_or_group.Șdom)}else{if(isValid(child_title_or_group))throw new Error({msg:["invalid-type","title-or-group",getTypeName(child_title_or_group)]})}if(relay)child_title_or_group.parent(this,false)}remove(child_title_or_group,relay=true,detach=true){if(!isValid(child_title_or_group))throw new Error({msg:["invalid-argument","title-or-group"]});if(-1!=[...this.Șdom.children].indexOf(child_title_or_group.Șdom)){detach?this.Șdom.removeChild(child_title_or_group.Șdom):child_title_or_group.Șdom.remove()}if(relay)child_title_or_group.parent(undefined,false)}empty(detach=true){[...this.Șdom.children].forEach(child=>{const child_title_or_group=this.glue(child);this.remove(child_title_or_group,true,detach)})}get parent(){return this.#parent_}get Șdom(){return this.#Șmenu_nav_}get Știtle(){return vjs(this.#Șmenu_nav_,":scope > h2",false)}get Șgroup(){return vjs(this.#Șmenu_nav_,":scope > ul",false)??vjs(this.#Șmenu_nav_,":scope > div > ul",false)}get options(){return this.#options_}childGroup(){return this.glue(this.Șgroup)}get ns(){return this.#ns_}#clickHandler(event){try{let menu_item,menu_label;const target=event.target;if("toggle"==event.type){menu_item=this.glue(target.parentElement)}else{const btn=Menu.Label.label_tag_==target.tagName?target.parentElement:target;menu_label=this.glue(btn);menu_item=menu_label?.parent()}if(!isValid(menu_item))return kh_log.error?.(T9`wrong menu structure`);kh_log.trace?.(T9`menu listener(${event.type}) /${menu_item.label_value()}/`);if(true==menu_item.childGroup()?.isPopup){if(use_popup_api&&("toggle"!==event.type||"open"!=event.newState||!must_popup_positioned))return;const ns=`${this.ns}-pop`;vjs.off(`.${ns}`);if(!use_popup_api){const previous_entry=vjs.data(menu_item.base().Șdom,this.#options_.roles.popup);if(isValid(previous_entry)&&previous_entry.popup_menu.isOpen){vjs.data(menu_item.base().Șdom,this.#options_.roles.popup,null);if(previous_entry.menu_item==menu_item)return previous_entry.popup_menu.hidePopup()}}(use_popup_api?Promise.resolve({info:undefined}):import("/contrib/jsm/kh_components_popup.js")).then(async({info})=>{const position=vjs.offset(menu_item.Șdom);const menu_item_rect=vjs.boundingRect(menu_item.Șdom);position.y+=menu_item_rect.height;const colors=vjs.style(menu_item.Șdom,{backgroundColor:undefined,color:undefined});const body_scroll_sz=vjs.scrollSize(vjs.body);let popup_menu,promise;if(!use_popup_api){({popup:popup_menu,promise}=info?.({options:{prevent_dialog:true,prevent_modal:true,prevent_fullscreen:true,hide_icon:true,popup_stay:false,get_back:true,popup_role:this.#options_.roles.popup,popup_class:vjs.attr(this.Șdom,"id")||this.role()},message:menu_item.childGroup().Șdom,logger:kh_log,async:true,position}));vjs.onc(`pointerdown.${ns}`,event=>{this.#clickHandler.call(this,event);popup_menu.hidePopup()},popup_menu.Șdom,`[role="${this.options.roles.item}"] [role="${this.options.roles.label}"]`);vjs.cssvar(popup_menu.Șdom,{"--notify-color-bg":colors.backgroundColor,"--notify-color-fg":colors.color});vjs.one(`resize.${ns}`,event=>popup_menu.hidePopup(),window);promise.then(()=>{vjs.off(`resize.${ns}`)});vjs.data(menu_item.base().Șdom,this.#options_.roles.popup,{popup_menu,menu_item})}else{const target=event.target;popup_menu=this.glue(target);position.top=position.y=menu_item_rect.y+menu_item_rect.height;vjs.style(target,{position:"fixed",left:`${position.left}px`,top:`${position.top}px`});vjs.onc(`pointerdown.${ns}`,event=>{this.#clickHandler.call(this,event);popup_menu.Șdom.hidePopover()},popup_menu.Șdom,`[role="${this.options.roles.item}"] [role="${this.options.roles.label}"]`)}const body_scroll_sz2=vjs.scrollSize(vjs.body);const is_on_screen=vjs.isOnScreen(popup_menu.Șdom,"detail");if(body_scroll_sz.height!=body_scroll_sz2.height||!is_on_screen.vertical){if(use_popup_api&&must_popup_positioned){const popup_menu_rect=vjs.boundingRect(popup_menu.Șdom);position.top=position.y=menu_item_rect.y-popup_menu_rect.height;vjs.style(popup_menu.Șdom,{top:`${position.y}px`})}else{position.y=body_scroll_sz.height-vjs.offset(menu_item.Șdom).y;vjs.style(popup_menu.Șdom,{top:null,bottom:`${position.y}px`})}popup_menu.Șdom.classList.add("to-top")}if(body_scroll_sz.width!=body_scroll_sz2.width||!is_on_screen.horizontal){if(use_popup_api&&must_popup_positioned){const popup_menu_rect=vjs.boundingRect(popup_menu.Șdom);position.left=position.x=menu_item_rect.x-popup_menu_rect.width;vjs.style(popup_menu.Șdom,{left:`${position.x}px`})}else{position.left=position.x=body_scroll_sz.width-vjs.offset(menu_item.Șdom).x-vjs.size(menu_label.Șdom).width;vjs.style(popup_menu.Șdom,{left:null,right:`${position.x}px`})}popup_menu.Șdom.classList.add("to-left")}}).catch(error=>{kh_log.error?.(T9`error during execute memu handler => ${error}`)})}else{const handler=vjs.data(menu_item.Șdom,"onclick");return handler?.(event,menu_item)}}catch(error){kh_log.error?.(T9`error during execute memu handler => ${error}`)}}static fromObject(lvc,content){return new Menu(undefined,{classes:lvc.getAttribute("classes"),roles:lvc.getAttribute("roles"),title:lvc.getAttribute("title"),tagName:lvc.getAttribute("tagName")})}static Group=class _Group extends MenuComponent{#Șdom_;#item_;#is_popup_;constructor(menu,parent_item,{sub_popup,base_popup=false}={}){super();const further_argz=arguments[2];if(!(parent_item instanceof Menu.Item)&&isValid(parent_item)){parent_item=Component.glue(parent_item,Menu);if(!isValid(parent_item))throw new Error({msg:["invalid-argument","item"]})}menu??=parent_item?.base?.();if(!isValid(menu))throw new Error({msg:["invalid-argument","menu"]});this.#is_popup_=sub_popup??base_popup;const is_root=!isValid(parent_item);if(!this.#is_popup_||!use_popup_api){this.#Șdom_=vjs.create("ul",{class:`${menu.options.classes.group} ${is_root?class_from_orient(menu.options.orientation):class_from_orient("vertical")}`,style:{display:this.#is_popup_?`none`:null}})}else{const id=`group-${getRandomArbitrary()|0}`;const id_item=!is_root?vjs.attr(parent_item.Șdom,"id"):undefined;this.#Șdom_=vjs.div({class:`${menu.options.classes.group}`,style:{display:null},id,popover:"",anchor:id_item});vjs.create("ul",{class:`${is_root?class_from_orient(menu.options.orientation):class_from_orient("vertical")}`},this.#Șdom_)}this.base(menu);this.glue(this);this.role(menu.options.roles.group);if(!is_root)this.parent(parent_item);else menu.add(this);this.clone=function(parent){const for_menu=parent instanceof Menu?parent:parent instanceof Menu.Item?parent.base():undefined;const for_item=parent instanceof Menu.Item?parent:undefined;if(!isValid(for_menu))throw new Error("invalid-argument","clone-target","menu");const new_group=for_menu.group(for_item,further_argz);this.items().map(item=>item.clone(new_group));return new_group}}parent(item_or_menu,relay=true){if(0==arguments.length)return this.#item_??this.base();if(item_or_menu instanceof Menu.Item){if(this.#item_!=item_or_menu){if(relay)this.#item_?.remove(this,false);this.#item_=item_or_menu;if(relay)this.#item_.add(this,false)}}else if(this.options.roles.menu==item_or_menu?.role()){if(this.base()!=item_or_menu){this.base(item_or_menu)}}else{if(!isValid(item_or_menu))throw new Error({msg:["invalid-argument","item_or_menu",item_or_menu]});if(relay)this.#item_?.remove(this,false);this.#item_=undefined}}remove(item,relay=true,detach=true){if(-1!=[...this.#Șdom_group.children].indexOf(item.Șdom)){detach?this.#Șdom_group.removeChild(item.Șdom):item.Șdom.remove()}if(relay)item.parent(undefined,false)}add(item,relay=true){if(-1==[...this.#Șdom_group.children].indexOf(item.Șdom))this.#Șdom_group.append(item.Șdom);if(relay)item.parent(this,false)}empty(detach=true){[...this.#Șdom_group.children].forEach(child=>{const item=this.glue(child);this.remove(item,true,detach)})}get Șdom(){return this.#Șdom_}set Șdom(Șdom_){this.#Șdom_=Șdom_}get isPopup(){return this.#is_popup_}items(){return[...this.#Șdom_group.children].map(child=>this.glue(child)).filter(isValid)}get#Șdom_group(){const node_wtith_items="UL"==this.#Șdom_.tagName?this.#Șdom_:this.#Șdom_.children[0];kh_log.assert?.("UL"==node_wtith_items.tagName,"wrong structure","UL","expected");return node_wtith_items}};static Label=class _Label extends MenuComponent{#Șdom_;#item_;static#label_type_="span";static label_tag_=document.createElement(_Label.#label_type_).tagName;constructor(menu,item,{label,icon}){super();const further_argz=arguments[2];if(!(item instanceof Menu.Item)&&isValid(item)){item=this.glue(item);if(!isValid(item))throw new Error({msg:["invalid-argument","item"]})}menu??=item?.base?.();if(!isValid(menu))throw new Error({msg:["invalid-argument","menu"]});this.#Șdom_=vjs.create("button",{type:"button",class:menu.options.classes.label,dataMenuIcon:icon??null});this.base(menu);this.glue(this);this.role(menu.options.roles.label);if(!isEmpty(label)){const Șlabel=vjs.create(_Label.#label_type_,{text:label});this.#Șdom_.append(Șlabel)}this.parent(item)}get Șdom(){return this.#Șdom_}get#Șlabel(){return vjs(this.#Șdom_,`:scope > ${_Label.#label_type_}`,false)}item(){return this.#item_}get value(){return this.#Șdom_.textContent}set value(label){(this.#Șlabel??this.Șdom).textContent=label}parent(item,relay=true){if(0==arguments.length)return this.#item_;if(this.#item_!=item){if(relay)this.#item_?.remove(this,false);this.#item_=item;if(relay)this.#item_?.add(this,false)}}};static Item=class _Item extends MenuComponent{#Șdom_;#parent_group_;#child_group_;#label_;#sub_popup_;constructor(menu,parent_item_or_group,{label,icon,data,onclick,is_parent=false,tooltip,enabled=true,attr={}}={}){super();const further_argz=arguments[2];if(!(parent_item_or_group instanceof Menu.Item)&&!(parent_item_or_group instanceof Menu.Group)&&isValid(parent_item_or_group)){parent_item_or_group=this.glue(parent_item_or_group);if(!isValid(parent_item_or_group))throw new Error({msg:["invalid-argument","item-or-grroup"]})}menu??=parent_item_or_group?.base?.();if(!isValid(menu))throw new Error({msg:["invalid-argument","menu"]});this.#sub_popup_=further_argz?.sub_popup;const piog_role=parent_item_or_group?.role?.();const parent_group=menu.options.roles.group==piog_role?parent_item_or_group:parent_item_or_group?.childGroup()??(!isValid(parent_item_or_group)?menu.childGroup():undefined)??menu.group(parent_item_or_group,further_argz);this.#Șdom_=vjs.create("li",{data:{data,onclick},title:tooltip,id:`item-${getRandomArbitrary()|0}`,...attr,class:`${menu.options.classes.item} kh-vlayout kh-not-grow kh-align-start`+(!isEmpty(tooltip)?` ${kh_tooltip?.class_icon_auto}-after direct`:"")+(!isEmpty(further_argz.class)?` ${further_argz.class}`:"")});this.base(menu);this.glue(this);this.role(menu.options.roles.item);new Menu.Label(menu,this,{label:label||data?.toString?.(),icon});this.isParent(is_parent);this.parent(parent_group);this.enabled=enabled;this.clone=function(parent){if(!(parent instanceof Menu)&&!(parent instanceof Menu.Item)&&!(parent instanceof Menu.Group)){throw new Error("invalid-argument","clone-target","menu or item or group","expected")}const for_menu=parent instanceof Menu?parent:parent.base();if(!isValid(for_menu))throw new Error("invalid-argument","clone-target","menu");const new_item=for_menu.item(parent instanceof Menu?undefined:parent,further_argz);this.childGroup()?.clone(new_item);return new_item}}parent(parent_group,relay=true){if(0==arguments.length)return this.#parent_group_;if(this.#parent_group_!=parent_group){if(relay)this.#parent_group_?.remove(this,false);this.#parent_group_=parent_group;if(relay)this.#parent_group_?.add(this,false)}}add(child_group_or_label_or_item,relay=true){if(!isValid(child_group_or_label_or_item))throw new Error({msg:["invalid-argument","group-or-label"]});if(child_group_or_label_or_item instanceof Menu.Label){if(-1==[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom))this.Șdom.prepend(child_group_or_label_or_item.Șdom);this.#label_=child_group_or_label_or_item}else if(child_group_or_label_or_item instanceof Menu.Group){if(-1==[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom))this.Șdom.append(child_group_or_label_or_item.Șdom);this.#child_group_=child_group_or_label_or_item;if(this.#sub_popup_&&use_popup_api){const id_group=vjs.attr(this.#child_group_.Șdom,"id");vjs.attr(this.#label_.Șdom,{popovertarget:id_group,_commandfor_:id_group})}}else if(child_group_or_label_or_item instanceof Menu.Item){if(!this.isParent())this.isParent(true);return this.#child_group_.add(child_group_or_label_or_item)}else{if(!isValid(child_group_or_label_or_item))throw new Error({msg:["invalid-type","group-or-label",getTypeName(child_group_or_label_or_item)]})}if(relay)child_group_or_label_or_item.parent(this,false)}remove(child_group_or_label_or_item,relay=true,detach=true){if(!isValid(child_group_or_label_or_item))throw new Error({msg:["invalid-argument","group-or-label"]});if(child_group_or_label_or_item instanceof Menu.Label){if(-1!=[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom)){detach?this.Șdom.removeChild(child_group_or_label_or_item.Șdom):child_group_or_label_or_item.Șdom.remove()}this.#label_=undefined}else if(child_group_or_label_or_item instanceof Menu.Group){if(-1!=[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom)){detach?this.Șdom.removeChild(child_group_or_label_or_item.Șdom):child_group_or_label_or_item.Șdom.remove()}this.#child_group_=undefined}else if(child_group_or_label_or_item instanceof Menu.Item){return this.#child_group_?.remove(child_group_or_label_or_item)}else{if(!isValid(child_group_or_label_or_item))throw new Error({msg:["invalid-type","group-or-label",getTypeName(child_group_or_label_or_item)]})}if(relay)child_group_or_label_or_item.parent(undefined,false)}isParent(is_parent){if(undefined==is_parent)return isValid(this.#child_group_);if(true==is_parent){if(!isValid(this.#child_group_))this.base().group(this)}else{if(isValid(this.#child_group_))this.remove(this.#child_group_,true,false)}}get Șdom(){return this.#Șdom_}label(){return this.#label_}label_value(){return this.#label_.value}childGroup(){return this.#child_group_}subPopup(){return this.#sub_popup_}get enabled(){return!this.Șdom.classList.contains("disabled")}set enabled(_enabled){_enabled?this.Șdom.classList.remove("disabled"):this.Șdom.classList.add("disabled")}}}export class ContextMenu extends Menu{static#def_classes_={menu:"context-menu-nav",title:"context-menu-title",group:"context-menu-group",item:"context-menu-item",label:"context-menu-label"};static#def_roles_={menu:"context-menu",title:"menutitle",group:"menugroup",item:"menuitem",label:"menulabel"};constructor({id,classz,classes=ContextMenu.#def_classes_,roles=ContextMenu.#def_roles_,orientation="vertical",title,tagName="nav",isOpen=false}={}){const further_argz=arguments[0];const options=JSON8MergePatch.apply(JSON8MergePatch.apply({classes:ContextMenu.#def_classes_,roles:ContextMenu.#def_roles_,connect_items:false},{id,classz,classes,roles,orientation,title,tagName}),further_argz??{});super(undefined,options);if(!isOpen)this.Șdom.classList.add("hidden")}show({x,y},event_trigger,data,should_stay=false){const othis=this;vjs.onc(`pointerdown.${this.ns}`,event=>{try{const btn=Menu.Label.label_tag_==event.target.tagName?event.target.parentElement:event.target;const menu_label=this.glue(btn);const menu_item=menu_label?.parent();if(!isValid(menu_item))return kh_log.error?.(T9`wrong menu structure`);kh_log.trace?.(T9`context menu listener /${menu_item.label_value()}/ for ${data.label_value()??data}`);const handler=vjs.data(menu_item.Șdom,"onclick");return handler?.(event_trigger,data,event,menu_item)}finally{othis.hide(should_stay);event.stopImmediatePropagation();return false}},this.Șdom,`[role="${this.options.roles.item}"] [role="${this.options.roles.label}"]`);kh_tooltip?.auto_create(this.Șdom);if(!isValid(this.Șdom.parentNode))vjs.body.append(this.Șdom);else should_stay=true;if(isNumber(x,false))x=`${x}px`;if(isNumber(y,false))y=`${y}px`;vjs.style(this.Șdom,{left:x,top:y});this.Șdom.classList.remove("hidden");defer(200).then(()=>{vjs.one(`pointerdown.${this.ns}`,pd_event=>{kh_log.debug?.(T9`pointerdown`);othis.hide(should_stay)},document);vjs.one(`blur.${this.ns}`,blur_event=>{kh_log.debug?.(T9`blur`);othis.hide(should_stay)},window)})}hide(should_stay=true){vjs.off(`.${this.ns}`,undefined,this.Șdom);this.Șdom.classList.add("hidden");if(!should_stay)this.Șdom.parentNode?.removeChild(this.Șdom)}static fromObject(lvc,content){return new ContextMenu({classes:lvc.getAttribute("classes"),roles:lvc.getAttribute("roles"),title:lvc.getAttribute("title"),tagName:lvc.getAttribute("tagName"),isOpen:lvc.getAttribute("isOpen")})}}kh_global.LoadedScripts.get(mf).resolve(ms);