const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_components";const mf="kh_components_menu_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);let jsm_prefix;let common_prefix;if("undefined"!==typeof process){jsm_prefix=`file:///${kh_global.kh.pathes.get("own-module")}`;common_prefix=`file:///${kh_global.kh.pathes.get("common")}`}else{jsm_prefix=nodeFN2ZK(`/contrib/jsm`)}const kh_js={...await import(`${jsm_prefix}/kh_earlybird${VERSION}.js`),...await import(`${jsm_prefix}/kh_functions${VERSION}.js`),...await import(`${jsm_prefix}/kh_classes${VERSION}.js`),...await import(`${jsm_prefix}/kh_ui_lid${VERSION}.js`)};const name=MF`${mf}`;const print_level=undefined;const{Logger}=await import(`${jsm_prefix}/kh_log${VERSION}.js`);const kh_log=new Logger(print_level,(()=>name));const{vjs}=await import(`${jsm_prefix}/kh_vanilla${VERSION}.js`);Object.assign(vjs,{...await import(`${jsm_prefix}/kh_vanilla2${VERSION}.js`)});const{Component,class_from_orient}={...await import(`${jsm_prefix}/kh_components_base${VERSION}.js`)};const{tooltip:kh_tooltip}=await import(`${jsm_prefix}/kh_web_html${VERSION}.js`);class MenuComponent extends Component{static flag="menu";base(){if(0!==arguments.length&&!(arguments[0]instanceof Menu))throw new Error({msg:["invalid-argument","menu",arguments[0]]});return super.base(...arguments??[])}}export class Menu extends MenuComponent{#id_=kh_js.getRandomArbitrary()|0;#ns_=`${mf}.${this.#id_}`;#parent_;#Șmenu_nav_;#options_;static#def_classes_={menu:"menu-nav",title:"menu-title",group:"menu-group",item:"menu-item",label:"menu-label"};static#def_roles_={menu:"menu",title:"menutitle",group:"menugroup",item:"menuitem",label:"menulabel",popup:"popup-menu"};constructor(parent,{id,classz,classes=Menu.#def_classes_,roles=Menu.#def_roles_,orientation="horizontal",title,tagName="nav",connect_items=true}={}){super();this.#options_=kh_js.JSON8MergePatch.apply(kh_js.JSON8MergePatch.apply({classes:Menu.#def_classes_,roles:Menu.#def_roles_},{id,classes,roles,orientation,title,tagName}),arguments[1]??{});this.#parent_=vjs(parent)?.[0];this.#Șmenu_nav_=vjs.create(tagName,{id,class:`${this.#options_.classes.menu}${!kh_js.isEmpty(classz)?` ${classz}`:""}`});this.base(this);this.glue(this);this.role(this.#options_.roles.menu);if(!kh_js.isEmpty(title)){this.#Șmenu_nav_.append(vjs.create("h2",{class:this.#options_.classes.title,text:title,attr:{role:this.options.roles.title},data:{role:this.options.roles.title}}))}this.group();if(kh_js.isValid(this.#parent_)){const old_menu=!kh_js.isEmpty(id)?vjs(this.#parent_,`#${id}`,false):undefined;if(kh_js.isValid(old_menu))this.#parent_.replaceChild(this.#Șmenu_nav_,old_menu);else this.#parent_.append(this.#Șmenu_nav_)}if(true==connect_items){vjs.onc(`pointerdown.${this.ns}`,this.#clickHandler.bind(this),this.Șdom,`[role="${this.options.roles.item}"] [role="${this.options.roles.label}"]`)}}group(item,opts){return new Menu.Group(this,item,{sub_popup:item?.subPopup(),...opts??{}})}item(item_or_group,opts){return new Menu.Item(this,item_or_group,opts)}add(child_title_or_group,relay=true){if(!kh_js.isValid(child_title_or_group))throw new kh_js.Error({msg:["invalid-argument","title-or-group"]});if(child_title_or_group instanceof Menu.Group){if(-1==[...this.Șdom.children].indexOf(child_title_or_group.Șdom))this.Șdom.append(child_title_or_group.Șdom)}else{if(kh_js.isValid(child_title_or_group))throw new kh_js.Error({msg:["invalid-type","title-or-group",kh_js.getTypeName(child_title_or_group)]})}if(relay)child_title_or_group.parent(this,false)}get parent(){return this.#parent_}get Șdom(){return this.#Șmenu_nav_}get Știtle(){return vjs(this.#Șmenu_nav_,":scope > h2",false)}get Șgroup(){return vjs(this.#Șmenu_nav_,":scope > ul",false)}get options(){return this.#options_}childGroup(){return this.glue(this.Șgroup)}get ns(){return this.#ns_}#clickHandler(event){try{const btn="LABEL"==event.target.tagName?event.target.parentNode:event.target;const menu_label=this.glue(btn);const menu_item=menu_label?.parent();if(!kh_js.isValid(menu_item))return kh_log.error?.(T9`wrong menu structure`);kh_log.trace?.(T9`menu listener /${menu_item.label_value()}/`);if(true==menu_item.childGroup()?.isPopup){const ns=`${this.ns}-pop`;vjs.off(ns);const previous_entry=vjs.data(menu_item.base().Șdom,this.#options_.roles.popup);if(kh_js.isValid(previous_entry)&&previous_entry.popup_menu.isOpen){vjs.data(menu_item.base().Șdom,this.#options_.roles.popup,null);if(previous_entry.menu_item==menu_item)return previous_entry.popup_menu.hidePopup()}import(`${jsm_prefix}/kh_components_popup${VERSION}.js`).then((async({info})=>{const position=vjs.offset(menu_item.Șdom);position.y+=vjs.boundingRect(menu_item.Șdom).height;const colors=vjs.style(menu_item.Șdom,{backgroundColor:undefined,color:undefined});const body_scroll_sz=vjs.scrollSize(vjs.body);const{popup:popup_menu,promise}=info({options:{prevent_dialog:true,prevent_modal:true,prevent_fullscreen:true,hide_icon:true,popup_stay:true,get_back:true,popup_role:this.#options_.roles.popup,popup_class:vjs.attr(this.Șdom,"id")||this.role()},message:menu_item.childGroup().Șdom,logger:kh_log,async:true,position});vjs.onc(`pointerdown.${ns}`,(event=>{this.#clickHandler.call(this,event);popup_menu.hidePopup()}),popup_menu.Șdom,`[role="${this.options.roles.item}"] [role="${this.options.roles.label}"]`);vjs.cssvar(popup_menu.Șdom,{"--notify-color-bg":colors.backgroundColor,"--notify-color-fg":colors.color});vjs.one(`resize.${ns}`,(event=>popup_menu.hidePopup()),window);promise.then((()=>{vjs.off(`resize.${ns}`)}));vjs.data(menu_item.base().Șdom,this.#options_.roles.popup,{popup_menu,menu_item});const body_scroll_sz2=vjs.scrollSize(vjs.body);const is_on_screen=vjs.isOnScreen(popup_menu.Șdom,"detail");if(body_scroll_sz.height!=body_scroll_sz2.height||!is_on_screen.vertical){position.y=body_scroll_sz.height-vjs.offset(menu_item.Șdom).y;vjs.style(popup_menu.Șdom,{top:null,bottom:`${position.y}px`});popup_menu.Șdom.classList.add("to-top")}if(body_scroll_sz.width!=body_scroll_sz2.width||!is_on_screen.horizontal){position.x=body_scroll_sz.width-vjs.offset(menu_item.Șdom).x-vjs.size(menu_label.Șdom).width;vjs.style(popup_menu.Șdom,{left:null,right:`${position.x}px`});popup_menu.Șdom.classList.add("to-left")}}))}else{const handler=vjs.data(menu_item.Șdom,"onclick");return handler?.(event,menu_item)}}catch(error){kh_log.error?.(T9`error during execute memu handler => ${error}`)}}static fromObject(lvc,content){return new Menu({classes:lvc.getAttribute("classes"),roles:lvc.getAttribute("roles"),title:lvc.getAttribute("title"),tagName:lvc.getAttribute("tagName")})}static Group=class _Group extends MenuComponent{#Șdom_;#item_;#is_popup_;constructor(menu,parent_item,{sub_popup,base_popup=false}={}){super();if(!(parent_item instanceof Menu.Item)&&kh_js.isValid(parent_item)){parent_item=parent_item.data("menu");if(!kh_js.isValid(parent_item))throw new kh_js.Error({msg:["invalid-argument","item"]})}menu??=parent_item?.menu?.();if(!kh_js.isValid(menu))throw new kh_js.Error({msg:["invalid-argument","menu"]});this.#is_popup_=sub_popup??base_popup;const is_root=!kh_js.isValid(parent_item);this.#Șdom_=vjs.create("ul",{class:`${menu.options.classes.group} ${is_root?class_from_orient(menu.options.orientation):class_from_orient("vertical")}`,style:{display:this.#is_popup_?`none`:null}});this.base(menu);this.glue(this);this.role(menu.options.roles.group);if(!is_root)this.parent(parent_item);else menu.add(this)}parent(item_or_menu,relay=true){if(0==arguments.length)return this.#item_??this.base();if(item_or_menu instanceof Menu.Item){if(this.#item_!=item_or_menu){if(relay)this.#item_?.remove(this,false);this.#item_=item_or_menu;if(relay)this.#item_.add(this,false)}}else if(this.options.roles.menu==item_or_menu?.role()){if(this.base()!=item_or_menu){this.base(item_or_menu)}}else{if(!kh_js.isValid(item_or_menu))throw new kh_js.Error({msg:["invalid-argument","item_or_menu",item_or_menu]});if(relay)this.#item_?.remove(this,false);this.#item_=undefined}}remove(item,relay=true,detach=true){if(-1!=[...this.Șdom.children].indexOf(item.Șdom)){detach?this.Șdom.removeChild(item.Șdom):item.Șdom.remove()}if(relay)item.parent(null,false)}add(item,relay=true){if(-1==[...this.Șdom.children].indexOf(item.Șdom))this.Șdom.append(item.Șdom);if(relay)item.parent(this,false)}get Șdom(){return this.#Șdom_}get isPopup(){return this.#is_popup_}};static Label=class _Label extends MenuComponent{#Șdom_;#item_;constructor(menu,item,{label,icon}){super();if(!(item instanceof Menu.Item)&&kh_js.isValid(item)){item=this.glue(item);if(!kh_js.isValid(item))throw new kh_js.Error({msg:["invalid-argument","item"]})}menu??=item?.menu?.();if(!kh_js.isValid(menu))throw new kh_js.Error({msg:["invalid-argument","menu"]});this.#Șdom_=vjs.create("button",{type:"button",class:menu.options.classes.label,dataMenuIcon:icon??null});this.base(menu);this.glue(this);this.role(menu.options.roles.label);if(!kh_js.isEmpty(label)){const Șlabel=vjs.create("label",{text:label});this.#Șdom_.append(Șlabel)}this.parent(item)}get Șdom(){return this.#Șdom_}get#Șlabel(){return vjs(this.#Șdom_,":scope > label",false)}item(){return this.#item_}get value(){return this.#Șdom_.textContent}set value(label){(this.#Șlabel??this.Șdom).textContent=label}parent(item,relay=true){if(0==arguments.length)return this.#item_;if(this.#item_!=item){if(relay)this.#item_?.remove(this,false);this.#item_=item;if(relay)this.#item_?.add(this,false)}}};static Item=class _Item extends MenuComponent{#Șdom_;#parent_group_;#child_group_;#label_;#sub_popup_;constructor(menu,parent_item_or_group,{label,icon,data,onclick,is_parent=false,tooltip,enabled=true,attr={}}={}){super();const further_argz=arguments[2];if(!(parent_item_or_group instanceof Menu.Item)&&!(parent_item_or_group instanceof Menu.Group)&&kh_js.isValid(parent_item_or_group)){parent_item_or_group=this.glue(parent_item_or_group);if(!kh_js.isValid(parent_item_or_group))throw new kh_js.Error({msg:["invalid-argument","item-or-grroup"]})}menu??=parent_item_or_group?.menu?.();if(!kh_js.isValid(menu))throw new kh_js.Error({msg:["invalid-argument","menu"]});this.#sub_popup_=further_argz?.sub_popup;const miog_role=parent_item_or_group?.role?.();const parent_group=menu.options.roles.group==miog_role?parent_item_or_group:parent_item_or_group?.childGroup()??(!kh_js.isValid(parent_item_or_group)?menu.childGroup():undefined)??menu.group(parent_item_or_group,further_argz);this.#Șdom_=vjs.create("li",{data:{data,onclick},title:tooltip,...attr,class:`${menu.options.classes.item} kh-vlayout kh-not-grow kh-align-start`+(!kh_js.isEmpty(tooltip)?` ${kh_tooltip?.class_icon_auto}-after direct`:"")});this.base(menu);this.glue(this);this.role(menu.options.roles.item);new Menu.Label(menu,this,{label:label||data?.toString?.(),icon});this.isParent(is_parent);this.parent(parent_group);this.enabled=enabled}parent(parent_group,relay=true){if(0==arguments.length)return this.#parent_group_;if(this.#parent_group_!=parent_group){if(relay)this.#parent_group_?.remove(this,false);this.#parent_group_=parent_group;if(relay)this.#parent_group_.add(this,false)}}add(child_group_or_label_or_item,relay=true){if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-argument","group-or-label"]});if(child_group_or_label_or_item instanceof Menu.Label){if(-1==[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom))this.Șdom.prepend(child_group_or_label_or_item.Șdom);this.#label_=child_group_or_label_or_item}else if(child_group_or_label_or_item instanceof Menu.Group){if(-1==[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom))this.Șdom.append(child_group_or_label_or_item.Șdom);this.#child_group_=child_group_or_label_or_item}else if(child_group_or_label_or_item instanceof Menu.Item){if(!this.isParent())this.isParent(true);return this.#child_group_.add(child_group_or_label_or_item)}else{if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-type","group-or-label",kh_js.getTypeName(child_group_or_label_or_item)]})}if(relay)child_group_or_label_or_item.parent(this,false)}remove(child_group_or_label_or_item,relay=true,detach=true){if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-argument","group-or-label"]});if(child_group_or_label_or_item instanceof Menu.Label){if(-1!=[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom)){detach?this.Șdom.removeChild(child_group_or_label_or_item.Șdom):child_group_or_label_or_item.Șdom.remove()}this.#label_=undefined}else if(child_group_or_label_or_item instanceof menu.group){if(-1!=[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom)){detach?this.Șdom.removeChild(child_group_or_label_or_item.Șdom):child_group_or_label_or_item.Șdom.remove()}this.#child_group_=undefined}else if(child_group_or_label_or_item instanceof Menu.Item){return this.#child_group_?.remove(child_group_or_label_or_item)}else{if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-type","group-or-label",kh_js.getTypeName(child_group_or_label_or_item)]})}if(relay)child_group_or_label_or_item.parent(undefined,false)}isParent(is_parent){if(undefined==is_parent)return kh_js.isValid(this.#child_group_);if(true==is_parent){if(!kh_js.isValid(this.#child_group_))this.base().group(this)}else{if(kh_js.isValid(this.#child_group_))this.remove(this.#child_group_,true,false)}}get Șdom(){return this.#Șdom_}label(){return this.#label_}label_value(){return this.#label_.value}childGroup(){return this.#child_group_}subPopup(){return this.#sub_popup_}get enabled(){return this.Șdom.classList.has("disabled")}set enabled(_enabled){_enabled?this.Șdom.classList.remove("disabled"):this.Șdom.classList.add("disabled")}}}export class ContextMenu extends Menu{static#def_classes_={menu:"context-menu-nav",title:"context-menu-title",group:"context-menu-group",item:"context-menu-item",label:"context-menu-label"};static#def_roles_={menu:"context-menu",title:"menutitle",group:"menugroup",item:"menuitem",label:"menulabel"};constructor({id,classz,classes=ContextMenu.#def_classes_,roles=ContextMenu.#def_roles_,orientation="vertical",title,tagName="nav",isOpen=false}={}){const options=kh_js.JSON8MergePatch.apply(kh_js.JSON8MergePatch.apply({classes:ContextMenu.#def_classes_,roles:ContextMenu.#def_roles_,connect_items:false},{id,classz,classes,roles,orientation,title,tagName}),arguments[1]??{});super(undefined,options);if(!isOpen)this.Șdom.classList.add("hidden")}show({x,y},event_trigger,data,should_stay=false){const othis=this;vjs.onc(`pointerdown.${this.ns}`,(event=>{try{const btn="LABEL"==event.target.tagName?event.target.parentNode:event.target;const menu_label=this.glue(btn);const menu_item=menu_label?.parent();if(!kh_js.isValid(menu_item))return kh_log.error?.(T9`wrong menu structure`);kh_log.trace?.(T9`context menu listener /${menu_item.label_value()}/ for ${data.label_value()??data}`);const handler=vjs.data(menu_item.Șdom,"onclick");return handler?.(event_trigger,data,event,menu_item)}finally{othis.hide(should_stay);event.stopImmediatePropagation();return false}}),this.Șdom,`[role="${this.options.roles.item}"] [role="${this.options.roles.label}"]`);kh_tooltip?.auto_create(this.Șdom);if(!kh_js.isValid(this.Șdom.parentNode))vjs.body.append(this.Șdom);else should_stay=true;if(kh_js.isNumber(x,false))x=`${x}px`;if(kh_js.isNumber(y,false))y=`${y}px`;vjs.style(this.Șdom,{left:x,top:y});this.Șdom.classList.remove("hidden");kh_js.defer(200).then((()=>{vjs.one(`pointerdown.${this.ns}`,(pd_event=>{kh_log.debug?.(T9`pointerdown`);othis.hide(should_stay)}),document);vjs.one(`blur.${this.ns}`,(blur_event=>{kh_log.debug?.(T9`blur`);othis.hide(should_stay)}),window)}))}hide(should_stay=true){vjs.off(`.${this.ns}`,undefined,this.Șdom);this.Șdom.classList.add("hidden");if(!should_stay)this.Șdom.parentNode?.removeChild(this.Șdom)}static fromObject(lvc,content){return new ContextMenu({classes:lvc.getAttribute("classes"),roles:lvc.getAttribute("roles"),title:lvc.getAttribute("title"),tagName:lvc.getAttribute("tagName"),isOpen:lvc.getAttribute("isOpen")})}}kh_global.LoadedScripts.get(mf).resolve(ms);