const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="kh_components";const mf="kh_components_tree_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import*as kh_js_e from"/contrib/jsm/kh_earlybird.js";import*as kh_js_c from"/contrib/jsm/kh_classes.js";import*as kh_js_f from"/contrib/jsm/kh_functions.js";const kh_js=Object.assign({...kh_js_e},{...kh_js_c},{...kh_js_f});const Hammer=(await import(LP`${"@egjs/hammerjs/dist/hammer.esm.js"}`)).default;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,(()=>name));import{vjs}from"/contrib/jsm/kh_vanilla.js";import{Component}from"/contrib/jsm/kh_components_base.js";const name=MF`${mf}`;["naver/hammer.js"].forEach((used=>kh_js.Copyright.used.add(used)));class TreeComponent extends Component{static flag="tree";base(){if(0!==arguments.length&&!(arguments[0]instanceof Tree))throw new Error({msg:["invalid-argument","tree",arguments[0]]});return super.base(...arguments??[])}}export class Tree extends TreeComponent{#Ștree_element_;#options_;#hammer_;static#def_classes_={tree_element:"tree-element",title:"tree-title",container:"tree-container",root_group:"tree-group",nested_group:"tree-group-nested",item:"tree-item",label:"tree-item-label",caret:"tree-item-caret"};static#def_roles_={tree:"tree",group:"treegroup",item:"treeitem",label:"treelabel"};constructor(tree_element,{classes=Tree.#def_classes_,roles=Tree.#def_roles_,group_open_std=false}={}){super();this.#options_=kh_js.JSON8MergePatch.apply(kh_js.JSON8MergePatch.apply({classes:Tree.#def_classes_,roles:Tree.#def_roles_},{classes,roles,group_open_std}),arguments[1]??{});this.#Ștree_element_=vjs(tree_element)[0];this.glue(this);this.role(this.#options_.roles.tree);this.base(this);vjs.class(this.Șdom,{[this.#options_.classes.tree_element]:true,lined:this.options.lined||null});if(2>this.#Ștree_element_.children.length){if(1>this.#Ștree_element_.children.length){this.#Ștree_element_.append(document.createElement("span"))}if("SPAN"==this.#Ștree_element_.children[0].tagName||this.#Ștree_element_.children[0].classList.contains(this.#options_.classes.title)){this.#Ștree_element_.append(document.createElement("div"))}else{this.#Ștree_element_.prepend(document.createElement("span"))}}this.Știtle.classList.add(this.#options_.classes.title);this.Școntainer.classList.add(this.#options_.classes.container);vjs.empty(this.Școntainer);delete Hammer.defaults.cssProps.userSelect;vjs.data(this.Școntainer,"hammmer")?.destroy();this.#hammer_=new Hammer.Manager(this.Școntainer,{recognizers:[[Hammer.Press,{time:500}]]});vjs.data(this.Școntainer,"hammmer",this.#hammer_);const tree_this=this;function clickhandler(item,event){event=kh_js.getDOMEvent(event);if(!kh_js.isValid(item)||!kh_js.isValid(event))return;if(true===item.childGroup()?.hitTest({x:(event.clientX??event.pageX)|0,y:(event.clientY??event.pageY)|0}))return;const is_parent=item.isParent();if(true!=is_parent)return;const is_open=item.Șdom.classList.contains("open");let n_childs=item.childGroup()?.childItems()?.length??0;vjs.trigger("should_open",item.Șdom,{is_open});item.Șdom.classList.toggle("open");item.childGroup()?.toggleHidden()}function single_click(event){const dom_event=kh_js.getDOMEvent(event);const item=tree_this.glue(dom_event.target);if(!kh_js.isValid(item)||!(item instanceof Tree.Item))return;try{clickhandler(item,dom_event)}finally{}}function double_click(event){const dom_event=kh_js.getDOMEvent(event);const item=tree_this.glue(dom_event.target);if(!kh_js.isValid(item)||!(item instanceof Tree.Label))return;try{clickhandler(item.item(),dom_event)}finally{}}if(!kh_js.isTouch()){vjs.off(`.${mf}`,undefined,this.Școntainer);vjs.onc(`pointerdown.${mf}`,single_click,this.Școntainer,`[role="${this.options.roles.item}"]`);vjs.onc(`dblclick.${mf}`,double_click,this.Școntainer,`[role="${this.options.roles.item}"] > [role="${this.options.roles.label}"]`)}else{const singleTap=new Hammer.Tap({event:"singletap"});const doubleTap=new Hammer.Tap({event:"doubletap",taps:2});this.#hammer_.add([doubleTap,singleTap]);doubleTap.recognizeWith(singleTap);singleTap.requireFailure([doubleTap]);this.#hammer_.on("singletap",single_click);this.#hammer_.on("doubletap",double_click)}vjs.onc("contextmenu",false,this.Școntainer,`[role="${this.options.roles.group}"],[role="${this.options.roles.item}"],[role="${this.options.roles.item}"] > [role="${this.options.roles.label}"]`)}group(tree_item){return new Tree.Group(this,tree_item)}item(tree_item_or_group,opts){return new Tree.Item(this,tree_item_or_group,opts)}get Șdom(){return this.#Ștree_element_}get Știtle(){return this.Șdom.children[0]}get Școntainer(){return this.Șdom.children[1]}get options(){return this.#options_}get hammer(){return this.#hammer_}rootGroup(){return this.glue(vjs(this.Școntainer,`:scope > [role="${this.#options_.roles.group}"]`,false))}rootItem(){return this.rootGroup()?.childItem(0)}#fromObject(data,tree_item_or_group,filter_key=(key=>false)){if(!kh_js.isValid(data))return data;if(kh_js.isBuiltIn(data))data={"":data};const entries=Object.entries(data);entries.forEach((([key,value])=>{if(true==filter_key?.(key))return;if(Array.isArray(value)){const n_test=Math.min(value.length,32);const array_test=value.slice(0,n_test);const array_as_builtin=-1==array_test.indexOf((v=>!kh_js.isPrimitive(v)));if(array_as_builtin)value=array_test.join(",")+",..."}if(kh_js.isString(value)&&1024+3<value.length)value=value.substring(0,1024)+"...";if(kh_js.isBuiltIn(value))return this.item(tree_item_or_group,{label:T9`${key}${0!=key.length?" : ":""}${value}`,data:value,is_parent:false});else{const item=this.item(tree_item_or_group,{label:key,data:value});this.#fromObject(value,item,filter_key)}}))}static fromObject(data,parent,options,filter_key){if(!kh_js.isValid(data))return data;const tree=new Tree(parent,options);tree.#fromObject(data,undefined,filter_key);return tree}static Group=class _Group extends TreeComponent{#Șdom_;#item_;constructor(tree,parent_item){super();if(!(parent_item instanceof Tree.Item)&&kh_js.isValid(parent_item)){parent_item=this.glue(parent_item);if(!kh_js.isValid(parent_item))throw new kh_js.Error({msg:["invalid-argument","item"]})}tree??=parent_item?.tree?.();if(!kh_js.isValid(tree))throw new kh_js.Error({msg:["invalid-argument","tree"]});const is_root=!kh_js.isValid(parent_item);this.#Șdom_=vjs.create("ul",{class:(is_root?tree.options.classes.root_group:tree.options.classes.nested_group)+(true!==tree.options.group_open_std&&!is_root?" hidden":"")});this.base(tree);this.glue(this);this.role(tree.options.roles.group);if(kh_js.isValid(parent_item))this.parent(parent_item);else tree.Școntainer?.append(this.Șdom)}get Șdom(){return this.#Șdom_}isRoot(){return undefined==this.#item_}parent(item,relay=true){if(0==arguments.length)return this.#item_;if(this.#item_!=item){if(relay)this.#item_?.remove(this,false);this.#item_=item;if(relay)this.#item_?.add(this,false)}}add(item,relay=true){if(!(item instanceof Tree.Item))return;if(-1==[...this.Șdom.children].indexOf(item.Șdom)){if(this.isRoot())this.remove(this.childItem(0));this.Șdom.append(item.Șdom)}if(relay)item.parent(this,false)}remove(item,relay=true,detach=true){if(!(item instanceof Tree.Item))return;if(-1!=[...this.Șdom.children].indexOf(item.Șdom)){detach?this.Șdom.removeChild(item.Șdom):item.Șdom.remove()}if(relay)item.parent(null,false)}childItems(){return[...this.Șdom.children].map((child=>this.glue(child))).filter(kh_js.isValid)}childItem(index){return this.childItems()[index]}toggleHidden(){this.#Șdom_.classList.toggle("hidden")}setHidden(hidden){if(false==hidden)this.#Șdom_.classList.remove("hidden");else this.#Șdom_.classList.add("hidden")}get isHidden(){return this.#Șdom_.classList.contains("hidden")}hitTest({x,y,test_only_for_margin=false}={}){const bR=vjs.boundingRect(this.Șdom);const bRm=vjs.boundingRect(this.Șdom,true);kh_log.trace?.(T9`boundingRect= ${bR} <=> ${bRm} / ${bR.inside({x,y})} <=> ${bRm.inside({x,y})} `);const inside=bRm.inside({x,y});return inside&&(!test_only_for_margin||!bR.inside({x,y}))}}}Tree.Label=class _Label extends TreeComponent{#Șdom_;#item_;constructor(tree,item,{label,icon}){super();if(!(item instanceof Tree.Item)&&kh_js.isValid(item)){item=this.glue(item);if(!kh_js.isValid(item))throw new kh_js.Error({msg:["invalid-argument","item"]})}tree??=item?.tree?.();if(!kh_js.isValid(tree))throw new kh_js.Error({msg:["invalid-argument","tree"]});this.#Șdom_=vjs.create("span",{class:tree.options.classes.label,text:label,dataTreeIcon:icon});this.base(tree);this.glue(this);this.role(tree.options.roles.label);this.parent(item)}get Șdom(){return this.#Șdom_}item(){return this.#item_}get value(){return this.#Șdom_.textContent}set ticker(t){this.#Șdom_.setAttribute("data-tree-ticker",t)}parent(item,relay=true){if(0==arguments.length)return this.#item_;if(this.#item_!=item){if(relay)this.#item_?.remove(this,false);this.#item_=item;if(relay)this.#item_?.add(this,false)}}};Tree.Item=class _Item extends TreeComponent{#Șdom_;#parent_group_;#child_group_;#label_;constructor(tree,parent_item_or_group,{label,icon,data,is_parent=true}={}){super();const further_argz=arguments[2];if(!(parent_item_or_group instanceof _Item)&&!(parent_item_or_group instanceof Tree.Group)&&kh_js.isValid(parent_item_or_group)){parent_item_or_group=this.glue(parent_item_or_group);if(!kh_js.isValid(parent_item_or_group))throw new kh_js.Error({msg:["invalid-argument","item-or-grroup"]})}tree??=parent_item_or_group?.tree?.();if(!kh_js.isValid(tree))throw new kh_js.Error({msg:["invalid-argument","tree"]});const tiog_role=parent_item_or_group?.role?.();const parent_group=tree.options.roles.group==tiog_role?parent_item_or_group:parent_item_or_group?.childGroup()??tree.group(parent_item_or_group);this.#Șdom_=vjs.create("li",{data:{data},class:tree.options.classes.item+!kh_js.isEmpty(further_argz.class)?` ${further_argz.class}`:""});this.base(tree);this.glue(this);this.role(tree.options.roles.item);new Tree.Label(tree,this,{label:label||data?.toString?.(),icon});this.isParent(is_parent);this.parent(parent_group)}parentItem(){return this.parent()?.parent()}parent(parent_group,relay=true){if(0==arguments.length)return this.#parent_group_;if(this.#parent_group_!=parent_group){if(relay)this.#parent_group_?.remove(this,false);this.#parent_group_=parent_group;if(relay)this.#parent_group_.add(this,false)}}add(child_group_or_label_or_item,relay=true){if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-argument","group-or-label"]});if(child_group_or_label_or_item instanceof Tree.Label){if(-1==[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom))this.Șdom.prepend(child_group_or_label_or_item.Șdom);this.#label_=child_group_or_label_or_item}else if(child_group_or_label_or_item instanceof Tree.Group){if(-1==[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom))this.Șdom.append(child_group_or_label_or_item.Șdom);this.#child_group_=child_group_or_label_or_item}else if(child_group_or_label_or_item instanceof Tree.Item){if(!this.isParent())this.isParent(true);kh_log.assert?.(true==relay,"ckeck relay status or reimplement direct add item to item");return this.#child_group_.add(child_group_or_label_or_item)}else{if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-type","group-or-label",kh_js.getTypeName(child_group_or_label_or_item)]})}if(relay)child_group_or_label_or_item.parent(this,false)}remove(child_group_or_label_or_item,relay=true,detach=true){if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-argument","group-or-label"]});if(child_group_or_label_or_item instanceof Tree.Label){if(-1!=[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom)){detach?this.Șdom.removeChild(child_group_or_label_or_item.Șdom):child_group_or_label_or_item.Șdom.remove()}this.#label_=undefined}else if(child_group_or_label_or_item instanceof Tree.Group){if(-1!=[...this.Șdom.children].indexOf(child_group_or_label_or_item.Șdom)){detach?this.Șdom.removeChild(child_group_or_label_or_item.Șdom):child_group_or_label_or_item.Șdom.remove()}this.#child_group_=undefined}else if(child_group_or_label_or_item instanceof _Item){return this.#child_group_?.remove(child_group_or_label_or_item)}else{if(!kh_js.isValid(child_group_or_label_or_item))throw new kh_js.Error({msg:["invalid-type","group-or-label",kh_js.getTypeName(child_group_or_label_or_item)]})}if(relay)child_group_or_label_or_item.parent(undefined,false)}isParent(is_parent){if(undefined==is_parent)return this.Șdom.classList.contains(this.options.classes.caret);if(true==is_parent){this.#Șdom_.classList.add(this.options.classes.caret)}else{this.#Șdom_.classList.remove(this.options.classes.caret);this.#child_group_?.setHidden(true)}}get Șdom(){return this.#Șdom_}next(){return this.glue(this.Șdom.nextSibling)}prev(){return this.glue(this.Șdom.previousSibling)}isOpen(){return this.Șdom.classList.contains("open")}label(){return this.#label_}label_value(){return this.#label_.value}label_ticker(t){this.#label_.Șdom.nextSibling?.remove();if(!kh_js.isValid(t)){this.#label_.ticker=""}else{if(t instanceof Element){this.#label_.ticker="";this.Șdom.append(t)}else return this.#label_.ticker=t}}childGroup(){return this.#child_group_}data(){return vjs.data(this.Șdom,"data")}};kh_global.LoadedScripts.get(mf).resolve(ms);