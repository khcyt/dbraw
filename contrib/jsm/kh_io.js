const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof kh_global.window&&"undefined"===typeof kh_global.process&&kh_global.self;const cf="kh_io";const mf="kh_io_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof kh_global.window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof kh_global.process?"node.js":"undefined"!==typeof kh_global.self?kh_global.self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import{isEmpty,isPlainObject,isNode,isValid,isNumber}from"/contrib/jsm/kh_earlybird.js";import{Error,StringMap}from"/contrib/jsm/kh_classes.js";import{cloneObject}from"/contrib/jsm/kh_functions.js";const name=kh_global.MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,()=>name);const{STATUS_CODES}="undefined"!==typeof kh_global.process?{...await import("node:http")}:{};if("undefined"!==typeof kh_global.process){}else{}const IOStringMap=function(){const ism=new StringMap({"connection-timeout":{de:"Zeitüberschreitung in der Verbindung",en:"connection timeout"},"connection-failure":{de:"Verbindungfehler",en:"connection failure"},"connection-request-failed":{de:"Verbindung konnte nicht hergestellt werden",en:"connection request failed"},"not.connected":{de:"Nicht verbunden",en:"not connected"},connected:{de:"Verbunden über",en:"connected to"}});StringMap.getGlobalMap().addEntries(ism);return ism}();export function HTTPError(err_class){return class extends err_class{constructor(...argz){super(...argz)}toJSON(){if("status"in this){this["HTTP-Status"]??=this.status;if(isNode())this["HTTP-Message"]??=STATUS_CODES?.[this.status]}return super.toJSON()}}}export class Util{static async fetchData(http_method="GET",url="",data={},_fetch_options={}){const fetch_options=cloneObject(_fetch_options,{transfer:[_fetch_options.signal].filter(o=>isValid(o))});const get_native=true==fetch_options.get_native;const get_json=true==fetch_options.get_json;const send_json=false!=fetch_options.send_json;const on_error_set="on_error"in fetch_options;const on_error=fetch_options.on_error;const signal=fetch_options.signal;const timeout=fetch_options.timeout;const timeout_signal=isNumber(timeout,true)&&-1!=timeout?AbortSignal.timeout(timeout):undefined;fetch_options.signal=isValid(signal)&&isValid(timeout_signal)?AbortSignal.any([signal,timeout_signal]):signal||timeout_signal;delete fetch_options.get_json;delete fetch_options.send_json;delete fetch_options.get_native;delete fetch_options.on_error;let headers="GET"==http_method||null===data?{}:{"Content-Type":send_json?"application/json":"application/octet-stream"};return kh_global.fetch(url,{method:http_method,mode:"cors",cache:"default",credentials:"same-origin",redirect:"follow",referrer:"",referrerPolicy:"strict-origin-when-cross-origin",body:"GET"==http_method?undefined:!send_json?data:JSON.stringify(data),...fetch_options,headers:{...headers,...fetch_options.headers}}).then(async response=>{if(false==response.ok&&"ignore"!=on_error)throw new(HTTPError(Error))({status:response.status,statusText:response.statusText,msg:[response.statusText],response});return get_native?Promise.resolve(response):get_json?response.json():response.text()}).catch(error=>on_error_set?Promise.resolve("error"==on_error?error:on_error):Promise.reject(error))}static async fetchData2(http_method="GET",url,data={},fetch_options={}){const can_fail=fetch_options.can_fail;delete fetch_options.can_fail;return Util.fetchData(http_method,url,data,{get_json:true,on_error:"ignore",...fetch_options}).then(json=>{if(isValid(json.error))throw json;if(400<=json.status)throw json;return Promise.resolve(json)}).catch(error=>{kh_log.trace?.(T9`Error is signaled, decision is made based on can_fail ${can_fail}, ${error}`);return can_fail?Promise.resolve(error):Promise.reject(error)})}static async ownIP(){return Util.fetchData(undefined,"/client-ip",undefined,{get_json:true}).then(json=>json.error?Promise.reject(json):Promise.resolve(json)).catch(error=>Util.fetchData(undefined,"https://jsonip.com/?callback",undefined,{get_json:true})).then(json=>Promise.resolve(json.ip)).catch(error=>Promise.reject(new Error({error,msg:["data-not-determined","own IP"]})))}static getQueryString(o){if(isEmpty(o))return"";return Object.entries(o).map(entry=>{let value=entry[1];if(isPlainObject(value)){value=JSON.stringify(value)}return`${encodeURIComponent(entry[0])}=${encodeURIComponent(value)}`}).join("&")}static parseQueryString(query,as_object){if(query?.startsWith("?"))query=query.substring(1);if(!isValid(as_object))return new URLSearchParams(query);if(isEmpty(query))return as_object?{}:[];const ret=query.split("&").map(sub_q=>sub_q.split("=").map(s=>decodeURIComponent(s)));return as_object?Object.fromEntries(ret):ret}static ip4_rex=/^(([01]?\d\d?|2[0-4]\d|25[0-5])\.){3}([01]?\d\d?|2[0-4]\d|25[0-5])$/;static ip6_rex=/^(?:(?:[a-fA-F\d]{1,4}:){7}(?:[a-fA-F\d]{1,4}|:)|(?:[a-fA-F\d]{1,4}:){6}(?:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}|:[a-fA-F\d]{1,4}|:)|(?:[a-fA-F\d]{1,4}:){5}(?::(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}|(?::[a-fA-F\d]{1,4}){1,2}|:)|(?:[a-fA-F\d]{1,4}:){4}(?:(?::[a-fA-F\d]{1,4}){0,1}:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}|(?::[a-fA-F\d]{1,4}){1,3}|:)|(?:[a-fA-F\d]{1,4}:){3}(?:(?::[a-fA-F\d]{1,4}){0,2}:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}|(?::[a-fA-F\d]{1,4}){1,4}|:)|(?:[a-fA-F\d]{1,4}:){2}(?:(?::[a-fA-F\d]{1,4}){0,3}:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}|(?::[a-fA-F\d]{1,4}){1,5}|:)|(?:[a-fA-F\d]{1,4}:){1}(?:(?::[a-fA-F\d]{1,4}){0,4}:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}|(?::[a-fA-F\d]{1,4}){1,6}|:)|(?::(?:(?::[a-fA-F\d]{1,4}){0,5}:(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)(?:\\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]\d|\d)){3}|(?::[a-fA-F\d]{1,4}){1,7}|:)))(?:%[0-9a-zA-Z]{1,})?$/gm;static email_rex=/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/g;static isIPv4(input){return this.ip4_rex.test(input)}static isIPv6(input){return this.ip6_rex.test(input)}static isIP(input){if(Util.isIPv4(input))return 4;if(Util.isIPv6(input))return 6;return 0}static isEMail(input){return this.email_rex.test(input.trim())}}if(isNode()){import("node:net").then(({isIPv4,isIPv6,isIP})=>{Util.isIPv4=isIPv4;Util.isIPv6=isIPv6;Util.isIP=isIP})}export{IOStringMap};kh_global.LoadedScripts.get(mf).resolve(ms);