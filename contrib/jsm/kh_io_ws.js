const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof kh_global.window&&"undefined"===typeof kh_global.process&&kh_global.self;const cf="kh_io";const mf="kh_io_ws_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof kh_global.window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof kh_global.process?"node.js":"undefined"!==typeof kh_global.self?kh_global.self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import{isValid,isEmpty,isString,isObject,isNode,isBrowser,isiOS,Deferred}from"/contrib/jsm/kh_earlybird.js";import{Error,EnumValue}from"/contrib/jsm/kh_classes.js";import{defer,yieldToMain,getRandomArbitrary,getTimestamp,WindowArgs}from"/contrib/jsm/kh_functions.js";const name=MF`${mf}`;const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,()=>name);import{HTTPError}from"/contrib/jsm/kh_io.js";import{vjs}from"/contrib/jsm/kh_vanilla.js";if("undefined"!==typeof kh_global.process){kh_global.WebSocket=(await import("/node-modules/ws/index.js")).default.WebSocket}else{}export const enumSocket=Object.freeze({mt_socket_status_:new EnumValue("socket_status",1<<0>>>0),mt_app_status_:new EnumValue("app_status",1<<1>>>0),mt_broadcast_:new EnumValue("broadcast",1<<2>>>0),mt_app_settings_:new EnumValue("app_settings",1<<3>>>0),mt_watchdog_:new EnumValue("watchdog",1<<4>>>0),mt_send_back_:new EnumValue("send_back",1<<5>>>0),mt_next_val_:6,attr_request_id_:new EnumValue("request_id",1<<16>>>0),attr_msg_type_:new EnumValue("msg_"+WindowArgs.type,1<<17>>>0),attr_msg_sub_type_:new EnumValue("msg_sub_"+WindowArgs.type,1<<18>>>0),attr_value_:new EnumValue(WindowArgs.value,1<<19>>>0),attr_result_:new EnumValue("attr_result_",1<<20>>>0),attr_timepoint_:new EnumValue("attr_timepoint_",1<<21>>>0),attr_private_:new EnumValue("attr_private_",1<<22>>>0),attr_next_val_:23,valueOf:(obj,ema)=>EnumValue.valueOf(obj,ema,enumSocket)});export class WebSocket extends kh_global.WebSocket{constructor(url,protocols,options){super(url,isString(protocols)||Array.isArray(protocols)?protocols:undefined,!isBrowser()?isObject(protocols)?protocols:options:undefined);if(isObject(protocols)){options=protocols;protocols=undefined}this.options_=options||{};this.options_.heartbeat_intervall||=3e4;this.options_.throw_send_on_close??=true;if(isValid(this.options_.binaryType))this.binaryType=this.options_.binaryType;this.result_promises_=new Map;const enumSocket=this.enumSocket;const othis=this;if(isBrowser()){this.addEventListener("open",()=>{othis.addEventListener("ping",e=>Function.isFunction(othis.onping)?othis.onping(e.data||e):42);othis.addEventListener("pong",e=>Function.isFunction(othis.onpong)?othis.onpong(e.data||e):42);othis.binaryType=this.options_.binaryType||"blob";if(othis.options.pong_sender)othis.heartbeat();if(isObject(othis.options.msg?.open)){defer(500).then(()=>othis.send_text(othis.options.msg.open))}if(isBrowser()){vjs?.on("beforeunload",()=>{if(othis.isOpen()){if(isValid(othis.options.msg?.unload)){let msg_unload=othis.options.msg.unload;if(Array.isArray(msg_unload)){msg_unload=msg_unload.map(msg=>Function.isFunction(msg)?msg():msg).filter(msg=>isValid(msg))}othis.send_text(msg_unload)}othis.close()}},window)}})}if(isBrowser()){this.addEventListener("message",e=>{let msgs=e.data??"";if("ping"===msgs||"pong"===msgs){return othis.dispatchEvent(new MessageEvent(msgs,{data:e}))}if("pp"===msgs)return;yieldToMain().then(()=>{msgs=JSON.parse(e.data);if(!Array.isArray(msgs))msgs=[msgs];msgs.forEach(msg=>{if(isString(msg)){if("ping"===msg||"pong"===msg){return othis.dispatchEvent(new MessageEvent(msg))}if("pp"===msg)return}else{const msg_type=enumSocket.valueOf(msg,enumSocket.attr_msg_type_);const msg_sub_type=enumSocket.valueOf(msg,enumSocket.attr_msg_sub_type_);kh_log.debug?.(T9`ws message_data => ${msg_type} - ${msg_sub_type} - ${msg[enumSocket.attr_value_]} - ${msg[enumSocket.attr_result_]} - ${msg[enumSocket.attr_request_id_]}`);switch(msg_type){case enumSocket.mt_send_back_:{msg=msg[enumSocket.attr_value_];othis.send(isString(msg)&&msg||JSON.stringify(msg));break}default:othis.resolve_request(msg)}}})}).catch(error=>{kh_log.info?.(T9`unexpected error or ws message with unknown data format / ${e.data} / ${error}`)})})}this.addEventListener("close",e=>{kh_log.debug?.(T9`web socket ${othis.shortName(true)} is closed - ${e.code||"??"} - ${e.reason||"???"} - clean= ${e.wasClean?"true":"false"}`);othis.clearTimeout()});this.addEventListener("error",e=>{kh_log.error?.(T9`web socket ${othis.shortName(true)} has error - ${e}`);othis.clearTimeout()});this.pingTimeout_=undefined}resolve_request(msg){this.result_promises_.get(msg[this.enumSocket.attr_request_id_])?.resolve(msg)}reject_request(msg,error){this.result_promises_.get(msg[this.enumSocket.attr_request_id_])?.reject(error??msg)}isOpen(){return WebSocket.OPEN==this.readyState}isReady(){return WebSocket.CONNECTING==this.readyState||WebSocket.OPEN==this.readyState}isClosed(){return!this.isReady()}room(){const url_split=this.url.split("/");return(isBrowser()?url_split[4]:url_split[2])||""}shortName(force_with_room=false){const url_split=this.url.split("/");return((isBrowser()?url_split[3]:url_split[1])||"")+(force_with_room||this.options_.with_room?`/${this.room()}`:"")||this.url}name(){return this.shortName(true)}send_text(text,callback){if(isEmpty(text))return;text=isString(text)?text:JSON.stringify(text);if(this.isClosed()&&true==this.options_.throw_send_on_close){const error=new(HTTPError(Error))({status:406,msg:"websocket not open"});if(Function.isFunction(callback)&&isNode())return callback(error);else throw error}super.send(text,callback)}send_binary(data,callback){if(!isValid(data))return;if(this.isClosed()&&true==this.options_.throw_send_on_close){const error=new(HTTPError(Error))({status:406,msg:"socket not open"});if(isValid(callback)&&isNode())return callback(error);else throw error}if(isNode()){super.send(data,{binary:true},callback)}else super.send(data)}send_request(msg,timeout=3e4){msg[this.enumSocket.attr_request_id_]??=WebSocketUtil.nextRequestId();msg[this.enumSocket.attr_timepoint_]??=getTimestamp();const promise=new Deferred(timeout,true,new Error({msg:["timeout",this.shortName(true)],data:msg}));this.result_promises_.set(msg[this.enumSocket.attr_request_id_],promise);this.send_text(msg);const othis=this;return promise.finally(()=>othis.result_promises_.delete(msg[this.enumSocket.attr_request_id_]))}heartbeat(){this.clearTimeout();const othis=this;const latence=Math.max(1e3,this.options_.heartbeat_intervall/30);this.pingTimeout_=kh_global.setTimeout(()=>othis.close(),this.options_.heartbeat_intervall+latence)}clearTimeout(){if(isValid(this.pingTimeout_)&&-1!=this.pingTimeout_){kh_global.clearTimeout(this.pingTimeout_);this.pingTimeout=-1}}set heartbeatIntervall(intv){const new_intv=+intv||3e4;const intv_change=this.options.heartbeat_intervall!==new_intv;this.options.heartbeat_intervall=new_intv;if(intv_change){this.heartbeat()}}ping(callback){if(this.options.ping_sender)this.isAlive_=false;else kh_log.warn?.("unexpected ping-request");this.send_text("ping",callback)}pong(callback){if(this.options.ping_sender)kh_log.warn?.("unexpected pong-request");this.send_text("pong",callback)}onpong(...argz){if(!this.options.ping_sender)kh_log.warn?.("unexpected pong receive");else this.isAlive_=true}onping(...argz){if(this.options.ping_sender)kh_log.warn?.("unexpected ping receive");else{this.heartbeat();this.pong()}}get options(){return this.options_}get enumSocket(){return this.options?.enumSocket||cs.enumSocket}addUnloadMsg(msg,append=true){this.options.msg??={};this.options.msg.unload??=[];if(!Array.isArray(this.options.msg.unload))this.options.msg.unload=[this.options.msg.unload];if(append)this.options.msg.unload.push(msg);else this.options.msg.unload.splice(0,0,msg)}suspend(msg){if(isValid(msg)||isObject(this.options.msg?.suspend))this.send_text(msg||this.options.msg.suspend);this.clearTimeout()}resume(msg){if(isValid(msg)||isObject(this.options.msg?.resume))this.send_text(msg||this.options.msg.resume);this.heartbeat()}static create_and_open(url,protocols,options){return new Promise((resolve,reject)=>{const ws=new WebSocket(url,protocols,options);let open_f,error_f;ws.addEventListener("open",open_f=()=>{kh_log.trace?.(T9`web socket ${ws.shortName(true)} is open, promise will fulfilled`);open_f&&ws.removeEventListener("open",open_f);error_f&&ws.removeEventListener("error",error_f);resolve({socket:ws,config:ws.options})});ws.addEventListener("error",error_f=error=>{kh_log.error?.(T9`web socket ${ws.shortName(true)} is in error state => ${error}`);open_f&&ws.removeEventListener("open",open_f);error_f&&ws.removeEventListener("error",error_f);reject(new Error({cause:error}))})})}static create_and_connect(app_context,{room="/",options={},protocols,pong_sender=true,msg_handler}={}){return new Promise(function(resolve,reject){const ws_url_obj=WebSocketUtil.name_builder_simple({room,id_as_path:true});if(!isValid(ws_url_obj))reject(new Error({msg:["operation-fails","ws URL Builder"]}));if(!isValid(msg_handler))kh_log.warn?.(T9`msg-handler parameter is missing. If you really don't want to set the parameter, set it to false.`);const enumSocket=app_context.enumSocket||options.enumSocket||cs.enumSocket;return WebSocket.create_and_open(ws_url_obj.url,protocols,{msg:{open:{[enumSocket.attr_msg_type_]:enumSocket.mt_socket_status_,[enumSocket.attr_value_]:"accepted"},unload:{[enumSocket.attr_msg_type_]:enumSocket.mt_socket_status_,[enumSocket.attr_value_]:"closed"},suspend:{[enumSocket.attr_msg_type_]:enumSocket.mt_socket_status_,[enumSocket.attr_msg_sub_type_]:enumSocket.mt_watchdog_,[enumSocket.attr_value_]:"suspend"},resume:{[enumSocket.attr_msg_type_]:enumSocket.mt_socket_status_,[enumSocket.attr_msg_sub_type_]:enumSocket.mt_watchdog_,[enumSocket.attr_value_]:"resume"}},pong_sender,...options}).then(async({socket,config})=>{socket["uuid"]=ws_url_obj.room;socket["#ws_url_obj"]=ws_url_obj;app_context["kh-ws"]=socket;Function.isFunction(msg_handler)&&socket.addEventListener("message",msg_handler.bind(app_context,socket));return resolve({socket,config})}).catch(error=>reject(error))})}}export class WebSocketUtil{static name_builder({endpoint,secure=true,ep_prefix,room_prefix="$ws-",room,id=`${Math.random()*1e4+1>>>0}`.padStart(5,"0")}={}){if(isEmpty(endpoint))throw new Error({msg:["param-invalid","endpoint","for build websocket name"]});if(isEmpty(ep_prefix))throw new Error({msg:["param-invalid","ep_prefix","for build websocket name"]});if(!ep_prefix.startsWith("/"))ep_prefix="/"+ep_prefix;if(!ep_prefix.endsWith("/"))ep_prefix=ep_prefix+"/";if(!isEmpty(room_prefix)&&!room_prefix.endsWith("-"))room_prefix=room_prefix+"-";return"ws"+(false===secure||isiOS()?"":"s")+"://"+endpoint+ep_prefix+(room||room_prefix+("#"===id?.charAt(0)?id.substring(1):id))}static name_builder_simple({room="$ws-",id=`${Math.random()*1e4+1>>>0}`.padStart(5,"0"),use_pathname=true,use_id,id_as_path=false}={}){if(2<window.location.pathname.length&&-1!=room.indexOf(window.location.pathname.slice(1,-1)))use_pathname=false;let ws_url=`${window.location.origin??""}${use_pathname&&window.location.pathname||""}`.replace("http","ws");if(isEmpty(ws_url))return undefined;if(!ws_url.endsWith("/"))ws_url+="/";const pos_qm=room.indexOf("?");const room_query=-1!=pos_qm?room.substring(pos_qm):"";if(-1!=pos_qm)room=room.substring(0,pos_qm);if(room.endsWith("/")){if(true!==use_id)use_id=false;room=room.slice(0,-1)}if("/"==room.charAt(0)){room=room.substring(1)}if(false!==use_id){if(!isEmpty(room)&&!room.endsWith("-")&&true!=id_as_path)room=room+"-";room=`${room}${!isEmpty(room)?true!==id_as_path?"-":"/":""}${id}`}if(!room.endsWith("/"))room+="/";return{url:`${ws_url}${room}${room_query??""}`,room,id,query:room_query}}static nextRequestId=function(){let request_id=getRandomArbitrary(0,1<<28)>>>0;return function(){return++request_id}}()}Object.assign(cs,{enumSocket});kh_global.LoadedScripts.get(mf).resolve(ms);