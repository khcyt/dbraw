const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;if(asWorker&&as_module){const query=self.location?.search||self.query;query?.slice(1).split("&").map((parameter=>parameter.split("="))).forEach((([key,value])=>{key=decodeURIComponent(key);value=decodeURIComponent(value);kh_global[key]=value}));if(!kh_global.VERSION){const url=import.meta.url;const p_kh=url.indexOf("/kh_");const p1=-1!=p_kh?url.indexOf(".",p_kh+1):-1;const p2=-1!=p1?url.indexOf(".js",p1):-1;kh_global.VERSION??=-1!=p1&&-1!=p2?url.substring(p1,p2):""}kh_global.nodeFN2ZK??=path=>path}const cf="kh_worker";const mf="kh_worker_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);import*as kh_js_e from"/contrib/jsm/kh_earlybird.js";import*as kh_js_c from"/contrib/jsm/kh_classes.js";import*as kh_js_f from"/contrib/jsm/kh_functions.js";const kh_js=Object.assign({...kh_js_e},{...kh_js_c},{...kh_js_f});import*as kh_io from"/contrib/jsm/kh_io.js";const print_level=undefined;import{Logger}from"/contrib/jsm/kh_log.js";const kh_log=new Logger(print_level,(()=>name));const name=MF`${mf}`;export function bindPostMessage(worker_or_self){if(!kh_js.isValid(worker_or_self)||true===worker_or_self.postMessageBound)return;const ori_pM=worker_or_self.postMessage;worker_or_self.postMessage=function(){let argz=[...arguments||[]];if(0==argz.length)return;if(1==argz.length&&argz[0]instanceof Error){argz[0]={msg:"msg-error",id:worker_or_self.name||worker_or_self.id,data:JSON.stringify(argz[0])}}ori_pM.apply(worker_or_self,argz)}.bind(worker_or_self);worker_or_self.postMessageBound=true}self.onerror??=!asWorker||function onerror(error){kh_log.error?.(T9`error in worker thread= ${error}`)};self.onmessageerror??=!asWorker||function onmessageerror(event){kh_log.error?.(T9`message error in worker thread= ${event}`)};!asWorker||self.addEventListener("message",(function onmessage(event){try{bindPostMessage(kh_global);let event_data=event.data;if(kh_js.isString(event_data)){try{event_data=JSON.parse(event_data)}catch{}}if(kh_js.isString(event_data)){throw new kh_js.Error("invalid-argument","event_data")}else{if(kh_js.isEmpty(event_data.id))throw new kh_js.Error("invalid-argument","param-not-determined","id");if(kh_js.isValid(kh_global.name)&&kh_global.name!==event_data.id)throw new kh_js.Error("param-not-match","id/name",[kh_global.name,event_data.id]);switch(event_data.msg){case"msg-error":{kh_log.error?.(T9`receive error in worker thread/${kh_global.name}/, error => ${event_data.data}`);break}default:break}}}catch(error){kh_log.error?.(T9`error in onmessage handler worker thread/${kh_global.name}/, error => ${error}`);event.stopImmediatePropagation();return kh_global.postMessage(error)}}));const Worker=asWorker||class Worker extends kh_global.Worker{#worker_loaded_;#id_;constructor({url,id=`ww-${(kh_js.getRandomArbitrary(0,1e4)>>>0).toString().padStart(4,"0")}`,globals={VERSION},timeout_load=1e4}={}){super(kh_js.getWorkerScriptURL(`${import.meta.resolve(url)}${!kh_js.isEmpty(globals)?`?${kh_io.Util.getQueryString(globals)}`:""}`),{type:"module",name:id});this.#id_=id;this.#worker_loaded_=new kh_js.Deferred(timeout_load);bindPostMessage(this);this.addEventListener("message",this.#onmessage.bind(this));this.addEventListener("error",this.#onerror.bind(this));this.addEventListener("messageerror",this.#onmessageerror.bind(this))}get id(){return this.#id_}get worker_loaded(){return this.#worker_loaded_}#onmessage(event){let event_data=event.data;if(kh_js.isString(event_data)){try{event_data=JSON.parse(event_data)}catch{}}if(kh_js.isString(event_data)){}else{if(kh_js.isEmpty(event_data.id))return this.postMessage(new kh_js.Error("must specify id"));switch(event_data.msg){case"worker-loaded":{kh_log.trace?.(T9`Script for WebWorker Object/${event_data.id}/ is loaded`);this.worker_loaded?.resolve(true);event.stopImmediatePropagation();break}case"msg-error":{kh_log.error?.(T9`receive error in WebWorker Object/${event_data.id} => ${event_data.data}`);break}default:break}}}#onerror(error){kh_log.error?.(T9`error in WebWorker Object/${this.id}, error= ${error}`)}#onmessageerror(event){kh_log.error?.(T9`message error in WebWorker Object/${this.id}, error event= ${event}`)}};export{Worker};kh_global.LoadedScripts.get(mf).resolve(ms);