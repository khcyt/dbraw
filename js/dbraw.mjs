const kh_global=Function("return globalThis;")()||Function("return this;")()||Function("return self;")();const as_module=undefined==this;const asWorker="undefined"===typeof window&&"undefined"===typeof process&&self;const cf="dbraw";const mf="dbraw_esm";kh_global.kh??={};kh_global.kh.context??="undefined"!==typeof window?kh_global.parent==kh_global?"window":"iframe":"undefined"!==typeof process?"node.js":"undefined"!==typeof self?self.name??"worker":"unknown";kh_global.kh.storage??={};const cs=kh_global.kh.storage[cf]??={cf,ms:new Set};const ms=kh_global.kh.storage[mf]??={mf,cs};cs.ms.add(ms);let jsm_prefix;if("undefined"!==typeof process){jsm_prefix=`file:///${kh_global.kh.pathes.get("own-module")}`}else{jsm_prefix=`/contrib/jsm`}const kh_js={...await import(`${jsm_prefix}/kh_earlybird${VERSION}.js`),...await import(`${jsm_prefix}/kh_functions${VERSION}.js`),...await import(`${jsm_prefix}/kh_classes${VERSION}.js`),...await import(`${jsm_prefix}/kh_classes2${VERSION}.js`)};const kh_io={...await import(`${jsm_prefix}/kh_io${VERSION}.js`),...await import(`${jsm_prefix}/kh_io_ws${VERSION}.js`)};const kh_cms={...await import(`${jsm_prefix}/kh_cms${VERSION}.js`)};const kh_cb={...await import(`${jsm_prefix}/kh_components_base${VERSION}.js`)};const{vjs}={...await import(`${jsm_prefix}/kh_vanilla${VERSION}.js`)};Object.assign(vjs,await import(`${jsm_prefix}/kh_vanilla2${VERSION}.js`));const print_level=undefined;const{Logger}=await import(`${jsm_prefix}/kh_log${VERSION}.js`);const kh_log=new Logger(print_level,(()=>name));const{dialog:kh_dialog,info:kh_info}=await import(`${jsm_prefix}/kh_components_popup${VERSION}.js`);const{copyright_dialog:kh_copyright_dialog,tooltip:kh_tooltip,popup:kh_popup}=await import(`${jsm_prefix}/kh_web_html${VERSION}.js`);const{Tabs}=await import(`${jsm_prefix}/kh_components_tabs${VERSION}.js`);Object.assign(cs,{...await import(`./dbraw_types${VERSION}.mjs`),...await import(`./dbraw_strings${VERSION}.mjs`),...await import(`./dbraw_algo${VERSION}.mjs`)});const name=MF`${mf}`;["font/arvo","font/priciono"].forEach((used=>kh_js.Copyright.used.add(used)));cs.uni_flag=false;kh_production_start_remove();kh_production_end_remove();const autoSave=false;const autoSaveIntervall=3e4;let modified=false;let jo_teamnames_list;cs.jo_all_events=undefined;cs.jo_cur_event=undefined;class Table_UIContext{#table_element_;constructor(table_element){this.#table_element_=vjs(table_element)?.[0];if(!kh_js.isValid(this.#table_element_))throw new cs.Error("param-not-determined","table_element")}get table_element(){return this.#table_element_}}Table_UIContext.row_selector_='div[class*="kh-table-row-"]';Table_UIContext.col_selector_='div[class*="kh-table-col-"]';const module_shims=kh_js.getWorkerScriptURL.shim_lib(true);kh_global.esmsInitOptions={shimMode:true,mapOverrides:true};const maps=vjs('[type="importmap"]',true);maps.forEach((map=>{document.body.appendChild(Object.assign(document.createElement("script"),{type:"importmap-shim",innerHTML:JSON.stringify(JSON.parse(map.innerHTML))}))}));await import(module_shims);export async function onReady(jq){try{let string_tables=[cs.strings];kh_production_start_remove();if(cs.uni_flag)string_tables.push(cs.strings2);kh_production_end_remove();await kh_cms.onReadyStd(cs,{string_tables,watch_hideit:'[id^="dbraw-page"]',logger:kh_log});ms.panels_selector=U`div[id*="${"id.tab.page.stem"}"]`;createTabs();const urlParams=new URLSearchParams(window.location.search);const year=urlParams.get("year")??"CUR_YEAR";let selected_event=Number.parseInt(urlParams.get("event"))??0;let tab_no=Number.parseInt(urlParams.get("tabno"))??0;if(0>tab_no||6<tab_no)tab_no=0;false&&kh_io.Util.fetchData(undefined,`/app-settings`,undefined,{get_json:true}).then((app_settings=>cs.app_settings=app_settings||{}));cs.jo_all_events=await getEventData(`/~data/events/data/${year}${window.location.search}`);if(cs.jo_all_events&&"error"in cs.jo_all_events){const error=cs.jo_all_events.error;delete error.stack;kh_log.error?.(T9`error: ${cs.unzip(error.detail)} - ${cs.unzip("dbraw.basevoc.err.maybe.data.not.exists")} | ${year}`);throw new cs.Error(error)}kh_log.trace?.(T9`Event Data: ${cs.jo_all_events}`);if(!cs.uni_flag){let event_keys=JSON.stringify(Object.keys(cs.jo_all_events.events));event_keys=[...event_keys.matchAll(/\d\d?/g)];event_keys=event_keys.map((match=>match[0]));const languages=["de","en"];const std_names=cs.strings["dbraw.basevoc.great.race"];const event_names=event_keys.map((event_key=>{if(true===cs.jo_all_events.events[event_key]["event-hidden"])return undefined;const event_name=cs.jo_all_events.events[event_key]["event-name"]||{};let name4lang={};languages.forEach((lang=>name4lang[lang]=event_name[lang]||event_name||std_names[lang]?.[event_key]||`Event ${event_key}`));return{event_key,event_names:name4lang}})).filter((event_name=>kh_js.isValid(event_name)));event_names.forEach((event_key_and_names=>{const event_key=event_key_and_names.event_key;const name4lang=event_key_and_names.event_names;Object.entries(name4lang).forEach((n4l_entry=>std_names[n4l_entry[0]][event_key]=n4l_entry[1]))}));kh_js.StringMap.getGlobalMap().addEntries({"dbraw.basevoc.great.race":std_names});const select_box=getEventSelector();if(kh_js.isValid(select_box)){vjs.data(select_box,"kh-cms-processed").delete("value");vjs.empty(select_box);kh_cms.processTemplateContent(select_box)}if(selected_event>=std_names[languages[0]].length)selected_event=0}else{vjs.cssvar(undefined,"--esv-red-triple"," 0 175 195");vjs.cssvar(undefined,"--color-esv-red","rgb(0 175 195)")}if(0>selected_event)selected_event=0;if(autoSave)kh_global.setInterval((()=>saveEventData("/~data/events/CUR_EVENT/data",true,cs.jo_cur_event)),autoSaveIntervall);const s_event_change=cs.unzip("event.event.change");vjs.on("change",(event=>vjs.trigger(s_event_change,cs.getMainWindow(),{event,getOrigin:()=>event})),getEventSelector());vjs.on(s_event_change,onEventChange,cs.getMainWindow());vjs.one(s_event_change,(event=>{if(0!=tab_no)setTimeout((()=>activateTabPanel(tab_no)),500)}),cs.getMainWindow());vjs.on(cs.unzip("event.order.holded.competition.change"),renewCompetitionOrderList,cs.getMainWindow());getEventSelector().selectedIndex=selected_event;vjs.trigger(s_event_change,cs.getMainWindow());kh_cms.processTemplateContent(null,["fulfill"]).then((()=>kh_tooltip.auto_create_text(cs.getMainWindow())));vjs.on(cs.unzip("event.button.click"),onButtonClick,cs.getMainWindow());vjs.on(cs.unzip("event.clear.report"),onClearReport,cs.getMainWindow());vjs.on(cs.unzip("event.fill.handsout"),onFillHandsout,cs.getMainWindow());vjs.on(U`${"event.show.dialog.lpc"}`,showDialog_LPC,cs.getMainWindow());vjs.on(U`${"event.switch.led"}`,switchStatusLED,cs.getMainWindow());vjs.on(U`${"event.time.table"}`,onTimeTable,cs.getMainWindow());vjs.on(U`${"event.time.cost"}`,onTimeCostChange,cs.getMainWindow());vjs.on(U`${"event.min.per.cat"}`,onMinPerCatChange,cs.getMainWindow());vjs.attr('link[rel="icon"]',"href",U`${"dbraw.app.icon.large"}`);vjs.attr('link[rel="shortcut icon"]',"href",U`${"dbraw.app.icon.small"}`);vjs.onc("contextmenu",false,cs.getMainWindow(),"*");vjs.onc("pointerdowm",(event=>2==event.button?false:undefined),cs.getMainWindow(),"*",{capture:true});vjs.on("keydown",(event=>{if("P"==event.key.toUpperCase()&&event.ctrlKey){printCurrentPage(event,[event,null,cs.app_settings.print_type]);event.preventDefault()}}),window);vjs.style(U`[data-name="${"dbraw.app.copyright.link.name"}"]`,{zIndex:1e3});connect_to_server()}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error)}}async function getEventData(file_name="/~data/events/data/CUR_YEAR"){try{let json=cs.prepareData(await kh_io.Util.fetchData(undefined,file_name,undefined,{get_json:true}));kh_production_start_remove();if(cs.uni_flag){let event_data=file_name.endsWith("data")?json:json.events["0"];let v1=cs.unzip("dbraw.basevoc.boat");if(kh_js.isValid(v1))event_data["categories"]["boat"]=v1;v1=cs.unzip("dbraw.basevoc.league");if(kh_js.isValid(v1))event_data["categories"]["league"]=v1;v1=cs.unzip("dbraw.basevoc.aliases");if(kh_js.isValid(v1))event_data["categories"]["aliases"]=v1}kh_production_end_remove();return json}catch(e){kh_log.error?.("Error request data",e,"fetching ",file_name);return undefined}}async function saveEventData(file_name,from_auto_save,event_data,broadcast){if(!WriteRights())return;if(kh_js.isString(broadcast)||Array.isArray(broadcast)||kh_js.isObject(broadcast)&&kh_js.isValid(broadcast.page)){broadcast={[cs.enumSocket.attr_msg_type_]:cs.enumSocket.mt_app_status_,[cs.enumSocket.attr_msg_sub_type_]:cs.enumSocket.mt_refresh_view_,[cs.enumSocket.attr_value_]:broadcast}}kh_io.Util.fetchData2("POST",file_name,Object.assign(event_data||cs.jo_all_events,{auto_save:from_auto_save||cs.app_settings.force_auto_save||cs.uni_flag,broadcast})).then((data=>{cs.setStatus(U`${"dbraw.basevoc.msg.save.data.success"}`.format(file_name,data),"inf",5e3);if(!from_auto_save)modified=false})).catch((error=>{kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(U`${"dbraw.basevoc.err.save.data.failed"}`.format(error),"err",1e4)}))}function setModified(set_modified=true,save=true,event_data="CUR_EVENT",broadcast){if(true===set_modified||false===set_modified)modified=set_modified;if(kh_js.isValid(set_modified)&&save){if("CUR_EVENT"===event_data)event_data=cs.jo_cur_event;const one_event=kh_js.isValid(event_data)&&kh_js.isValid(event_data["event-name"]);saveEventData(one_event?"/~data/events/CUR_EVENT/data":"/~data/events/data",false,event_data,broadcast)}return modified||false}function canSendFinalResults(is_finalrun=true){const now=new Date;const saveTime=new Date(`${cs.jo_cur_event["event-date"]} ${cs.jo_cur_event.timetable.at(-1).start} ${cs.jo_cur_event.timezone??"GMT+0200"}`);return!is_finalrun||now>=saveTime}function inlineEditing(elem_or_selector){const elements=vjs(elem_or_selector);if(!kh_js.isValid(elements)){kh_log.warn?.(T9`invalid elem parameter (from ${elem_or_selector}) for inline Editing`);return false}kh_log.trace?.(T9`${elements} is preparing for inline Editing`);elements.forEach((element=>{let modus=element.tagName;if("INPUT"==modus&&"button"==element.type)modus="BUTTON";switch(modus){case"INPUT":{element.setAttribute("readonly",true);vjs.on("contextmenu",(event=>{WriteRights()&&element.removeAttribute("readonly");return false}),element);vjs.on("blur",(event=>{element.setAttribute("readonly",true);return false}),element);break}case"SELECT":{vjs.on("mousedown",false,element);vjs.on("contextmenu",(event=>{WriteRights()&&vjs("mousedown",false,element);return false}),element);vjs.on("blur",(event=>{vjs.on("mousedown",false,element);return true}),element);break}case"BUTTON":{const class_disabled=U`${"class.disabled"}`;element.classList.add(class_disabled);vjs.on("contextmenu",(event=>{if(WriteRights()&&element.classList.contains(class_disabled)){element.classList.remove(class_disabled);kh_global.setTimeout((()=>{element.classList.add(class_disabled)}),3e4)}return false}),element);vjs.on("pointerdown",(event=>{if(event.target!=element)return;if(element.classList.contains(class_disabled)){event.stopImmediatePropagation();return false}}),element);break}default:kh_log.error?.(cs.unzip("unknown-type-for"),"inlineEditing",element.tagName);break}}));return false}function getEventSelector(event_or_elem){event_or_elem=event_or_elem?.details?.event.target??event_or_elem?.target??event_or_elem?.[0]??event_or_elem;return"SELECT"===event_or_elem?.tagName?event_or_elem:kh_js.isString(event_or_elem)?vjs(event_or_elem,false):vjs("#"+cs.strings["id.event.selector"],false)}const getEventTitle=event_or_elem=>{const select_box=getEventSelector(event_or_elem);if(kh_js.isEmpty(select_box))return undefined;return select_box.options[select_box.selectedIndex].text};const getEventKey=event_or_elem=>{const select_box=getEventSelector(event_or_elem);if(kh_js.isEmpty(select_box))return undefined;return select_box.selectedIndex};async function onEventChange(event){try{let event_key=getEventKey(event);if(!kh_js.isValid(event_key))throw new cs.Error("param-not-determined","event_key");let event_title=getEventTitle(event);if(!kh_js.isValid(event_title))throw new cs.Error("param-not-determined","event_title");if(!cs.jo_all_events)throw new cs.Error("param-not-determined","event_data");let event_data;try{const resp=await kh_io.Util.fetchData2("PUT",`/~data/events/${event_key}`,{status:"selected"});kh_log.debug?.("response for selection was",resp);event_data=cs.jo_cur_event=cs.jo_all_events["events"][event_key]=await getEventData(`/~data/events/${event_key}/data`)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return}let date_box=vjs(U`#${"id.event.datebox"}`,false);if(kh_js.isValid(date_box)&&kh_js.isString(event_data["event-date"]))date_box.value=event_data["event-date"];const elems_must_reset=vjs(`.${cs.unzip("class.reset.event.change")}`,true);elems_must_reset?.forEach((elem=>vjs.data(elem,"kh-cms-processed").delete("create")));vjs.empty(elems_must_reset);event_data.categories.boat.real_length=event_data.categories.boat.filter((boat=>!kh_js.isEmpty(boat))).length;event_data.categories.league.real_length=event_data.categories.league.filter((league=>!kh_js.isEmpty(league))).length;refreshTabs();kh_cms.processTemplateContent(`.${cs.unzip("class.race.paramz")}`);event_data.timetable=event_data.timetable||[];let content=event_data.timetable.map((tt_entry=>new kh_cms.LVC({label:tt_entry.name,attributes:{time_start:tt_entry.start,time_end:tt_entry.end,ui_model:U2`templ.timetable.line`}})));vjs.data(U`#${"id.time.table"}`,"content",content);vjs.attr(U`#${"id.time.table"}`,"data-content",JSON.stringify(content));const forerun_tabs=[...Array(event_data.foreruns.length)].map(((v,i)=>U`${"id.tab.page.forerun"}_${i+1}`));refreshView([...forerun_tabs,U`${"id.tab.page.finalrun"}`],true);if(!kh_js.isString(event_title))kh_log.error?.(cs.unzip("@(param-not-determined)"),"event Title")}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error)}}function createTabs(){const panel_id_stem=cs.unzip("id.tab.page.stem");const panels_selector=function(tabs){return vjs(tabs?.Șdom??document,ms.panels_selector,true)};const id_getter=function(tab_comp,index){if(tab_comp instanceof Tabs.Panel)return undefined;if(tab_comp instanceof Tabs.Tab){if(-1==index)return;const Șpanels=panels_selector(tab_comp);const panel=Șpanels[index];const p_id=panel.getAttribute("id");const id_postfix=p_id.substring(panel_id_stem.length);return`tab-${id_postfix}`}};const Șpanels=panels_selector();const panelsParent=Șpanels[0].parentNode;const tabs_ui=new Tabs(panelsParent,{id_getter,panels_selector});vjs.on("tabsactivated",onTabActivated,panelsParent);let tab_p=tabs_ui.Șlist;let Șmenu=vjs.NodeFromTemplate("app-menu");tab_p[kh_js.isMobile()?"prepend":"append"](...Șmenu);kh_cms.processTemplateContent(tab_p);if(kh_js.isMobile()||kh_js.isTouch()){tab_p.classList.add("kh-flayout","kh-not-grow");if(kh_js.isMobile()){vjs.style(Șmenu,{minWidth:"90%",maxWidth:"95%",padding:0})}else if(kh_js.isTouch()){vjs.style(Șmenu,{minWidth:"30em",maxWidth:"95%",padding:0});vjs.style(vjs(Șmenu,"fieldset",false),"minHeight","4em")}}vjs.data(Șpanels[0],"dbraw-panel-was-activated",true);if(!kh_js.isValid(vjs(tab_p,U`:scope > .${"class.status.led"}`,false))){vjs.style(tab_p,{position:"relative"});tab_p.append(vjs.create(`span`,{class:U`${"class.status.led"} ${"class.status.led.not.connected"}`}))}respect_enabled_tabs()}function refreshTabs(){const event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let Șpanels=vjs(ms.panels_selector,true);const panelsParent=Șpanels[0].parentNode;const tabs_component=Tabs.glue(panelsParent,Tabs);const tabs_list=tabs_component.list();const Ștab_lis=tabs_list.Șlis;const Șteamlist_tab=Ștab_lis.find((tab=>tab.matches(U`[id*="${"title.page.teamlist"}"]`.toLowerCase())));const Șfinalrun_tab=Ștab_lis.find((tab=>tab.matches(U`[id*="${"title.page.finalrun"}"]`.toLowerCase())));const teamlist_tab_index=Tabs.glue(Șteamlist_tab,Tabs)?.index;let finalrun_tab_index=Tabs.glue(Șfinalrun_tab,Tabs)?.index;const n_delete=finalrun_tab_index-teamlist_tab_index-1;const Șteamlist_panel=Șpanels.find((page=>page.matches(U`[id="${"id.tab.page.teamlist"}"]`)));const Șfinalrun_panel=Șpanels.find((page=>page.matches(U`[id="${"id.tab.page.finalrun"}"]`)));const teamlist_panel_index=Tabs.glue(Șteamlist_panel,Tabs)?.index;let finalrun_panel_index=Tabs.glue(Șfinalrun_panel,Tabs)?.index;for(let i=0;i<n_delete;++i)tabs_component.removeTab(teamlist_tab_index+1,true);finalrun_tab_index=teamlist_tab_index+1;Șpanels=vjs(ms.panels_selector,true);const s_forerun=cs.unzip("title.page.forerun");const no_frmt=cs.unzip("dbraw.format.no");for(let i=0;i<event_data.paramz.n_forerun;++i){const page_id=U`${"id.tab.page.forerun"}_${i+1}`;const page_title=`${s_forerun} ${no_frmt(i+1)}`;const forerun_page=vjs.create("div",{id:page_id,title:page_title,dataSeriesNo:i,dataHeatType:"forerun"});forerun_page.setAttribute("data-content",JSON.stringify(Object.fromEntries([[kh_js.WindowArgs.ui_model,U2`templ.heatlist`]])));const tab=tabs_component.insertTab(finalrun_tab_index+i,forerun_page);forerun_page.setAttribute("data-fulfill",`${tab.Șdom.getAttribute("id")}.click`)}tabs_component.active(0);Șpanels=vjs(ms.panels_selector,true);kh_cms.processTemplateContent(vjs(panelsParent,U`:scope > [id*="${"id.tab.page.forerun"}"]`,true),null,"async");respect_enabled_tabs()}function activateTabPanel(tab_or_panel_or_id_or_index){const Șpanels=vjs(ms.panels_selector,true);if(kh_js.isEmpty(Șpanels))throw new cs.Error("param-not-determined","id.tab.page.stem");const panelsParent=Șpanels[0].parentNode;const tabs_component=Tabs.glue(panelsParent,Tabs);let tab;if(kh_js.isDOMElement(tab_or_panel_or_id_or_index)){tab_or_panel_or_id_or_index=Tabs.glue(tab_or_panel_or_id_or_index,Tabs)}else{if(kh_js.isString(tab_or_panel_or_id_or_index)){const element=vjs(panelsParent,tab_or_panel_or_id_or_index,false);if(kh_js.isValid(element))tab_or_panel_or_id_or_index=Tabs.glue(element);else tab_or_panel_or_id_or_index=parseInt(tab_or_panel_or_id_or_index)||undefined}if(kh_js.isNumber(tab_or_panel_or_id_or_index)){tab_or_panel_or_id_or_index=tabs_component.all_tabs(tab_or_panel_or_id_or_index)}}if(tab_or_panel_or_id_or_index instanceof Tabs.Tab)tab=tab_or_panel_or_id_or_index;else if(tab_or_panel_or_id_or_index instanceof Tabs.Panel)tab=tab_or_panel_or_id_or_index.tab();if(!kh_js.isValid(tab)||tab.isHidden)return;tabs_component.active(tab);vjs.trigger("click",tab.Șdom)}function onTabActivated(event){const ui=event.detail;if(!kh_js.isEmpty(ui.newPanel))vjs.data(ui.newPanel.Șdom,"dbraw-panel-was-activated",true);vjs.postEvent("activate",ui.oldPanel.Șdom,false);vjs.postEvent("activate",ui.newPanel.Șdom,true)}function respect_enabled_tabs(){const Șpanels=vjs(ms.panels_selector,true);if(kh_js.isEmpty(Șpanels))throw new cs.Error("param-not-determined","id.tab.page.stem");const panelsParent=Șpanels[0].parentNode;const tabs_component=Tabs.glue(panelsParent,Tabs);if(Array.isArray(cs.app_settings?.enabled_tabs)){const tabs=tabs_component.all_tabs();const page_stem=cs.unzip(`id.tab.page.stem`);let tab_index_active=tabs_component.active();cs.app_settings.enabled_tabs.forEach((tab_stem=>{tab_stem=cs.unzip(`id.tab.page.${tab_stem}`);tab_stem=tab_stem.substring(page_stem.length);while(true){const enabled_tab=tabs.find((tab=>-1!=tab.Șdom.getAttribute("id").indexOf(tab_stem)));if(kh_js.isValid(enabled_tab))tabs.splice(tabs.findIndex((tab=>tab==enabled_tab)),1);else break}}));tabs.forEach((tab=>tab.setHidden(true)));if(true==tabs_component.all_tabs(tab_index_active)?.isHidden){tabs_component.active(tabs_component.all_tabs().find((tab=>!tab.isHidden)))}}}function getPanel(panel_id_or_index_or_special="active"){const dom_element=vjs(panel_id_or_index_or_special)?.[0];if(kh_js.isValid(dom_element)){return dom_element.closest(ms.panels_selector)}else{const Șpanels=vjs(ms.panels_selector,true);const panelsParent=Șpanels[0].parentNode;const tabs_component=Tabs.glue(panelsParent,Tabs);if("active"==panel_id_or_index_or_special){panel_id_or_index_or_special=tabs_component.active()}if(kh_js.isNumber(panel_id_or_index_or_special,true)){return tabs_component.Șpanels[panel_id_or_index_or_special]}else return tabs_component.Șpanels.filter((panel=>panel.matches(`[id*="${panel_id_or_index_or_special}"]`)))?.[0]}}class TeamTable_UIContext extends Table_UIContext{constructor(table_element){super(table_element)}team_from_input(event,can_create=false){let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let team_no=Number.parseInt(vjs(event.target.closest(TeamTable_UIContext.row_selector_),U`:scope > .${"class.team.table.teamno.col"} > span:first-child`,false)?.textContent.trim())>>>0;let team=event_data.teams.findByNo(team_no);if(kh_js.isValid(team)||!can_create)return team;const n_insert=team_no-event_data.teams.length;const teams_insert=[...Array(n_insert)].map(((v,i)=>new cs.Team({no:event_data.teams.length+i+1})));event_data.teams=cs.Team.getTeamList([...event_data.teams,...teams_insert],undefined,undefined,false);return this.team_from_input(event,false)}on_cell_key(event){let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let col=event.target,row=col.parentNode,nrows=this.table_element.children.length,ncols=row.children.length;switch(event.key){case"x":case"X":{if(!WriteRights())break;const cell=event.target;if("X"!==cell.textContent){const team=this.team_from_input(event);if(kh_js.isEmpty(team.name()))return;cell.textContent="X";const cat=vjs.data(cell,"cat");team.addCat(cat);this.sumAboveTeamTable(vjs.index(col));setModified(true,true,undefined,TeamTable_UIContext.page_id_)}break}case"Backspace":case"Delete":case" ":{if(!WriteRights())break;const cell=event.target;if(""!==cell.textContent){cell.textContent="";const team=this.team_from_input(event);const cat=vjs.data(cell,"cat");team.removeCat(cat);this.sumAboveTeamTable(vjs.index(col));setModified(true,true,undefined,TeamTable_UIContext.page_id_)}event.preventDefault();break}case"Enter":case"ArrowUp":case"ArrowDown":case"ArrowLeft":case"ArrowRight":{if("ArrowUp"==event.key&&2<vjs.index(row)){row.previousElementSibling.children[vjs.index(col)].focus()}else if(("ArrowDown"==event.key||"Enter"==event.key)&&nrows-3>vjs.index(row)){row.nextElementSibling.children[vjs.index(col)].focus()}else if("ArrowLeft"==event.key&&2<vjs.index(col)){col.previousElementSibling.focus()}else if("ArrowRight"==event.key&&ncols-2>vjs.index(col)){col.nextElementSibling.focus()}break}default:break}}add_teams(...teams){const results=teams.map((team=>jo_teamnames_list?.add(team)));if(-1!=results.indexOf(true)){TeamNamesList.toServer(jo_teamnames_list).then((res=>TeamNamesList.assign2DOM(jo_teamnames_list,U`#${"id.datalist.select.teams"}`))).catch((error=>{kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error)}))}}on_team_name_change(event){this.team_from_input(event,true).gname=event.target.value;event.target.value=this.team_from_input(event).name();const row_parent=event.target.closest(TeamTable_UIContext.row_selector_);if(kh_js.isEmpty(event.target.value))vjs(row_parent,U`:scope > .${"class.team.table.considered.col"}`,true)?.forEach((cell=>cell.textContent=""));const fn=kh_js.isEmpty(event.target.value)?DOMTokenList.prototype.remove:DOMTokenList.prototype.add;vjs(row_parent,U`:scope > .${"class.team.table.teamno.col"}`,true)?.forEach((cell=>fn.call(cell.classList,U`${"class.icon.element.pale"}`)));let tabs2refresh=[TeamTable_UIContext.page_id_,...[...Array(cs.jo_cur_event.paramz.n_forerun)].map(((v,i)=>U`${"id.tab.page.forerun"}_${i+1}`)),U`${"id.tab.page.finalrun"}`];setModified(true,true,undefined,tabs2refresh);refreshView(tabs2refresh);if(!kh_js.isEmpty(event.target.value))this.add_teams(event.target.value)}on_team_pay_change(event){vjs.attr(event.target,"value",event.target.value);const team=this.team_from_input(event);if(!kh_js.isValid(team))return;team.pay=0==event.target.value?"":event.target.value;setModified(true,true,undefined,TeamTable_UIContext.page_id_)}on_contextmenu_considered_col(event){const cell=event.target;if(!kh_js.isEmpty(cell.textContent)){const cat=vjs.data(cell,"cat");const team=this.team_from_input(event);const alias=team&&!kh_js.isEmpty(team.aliases_)?team.aliases_[cat]:undefined;if(!kh_js.isEmpty(alias)){let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");kh_popup.show({message:U`${"dbraw.basevoc.popup.alias.1"} «${cs.getCompetitionNameFromMask(event_data,cat)}» ${"dbraw.basevoc.popup.alias.2"} «${alias}»`,title:U`${"dbraw.basevoc.popup.alias.title"}`,options:{duration:"PT5S"}})}}return false}on_alias_dialog_ok_click(alias_dialog,team,col){const event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let modified=false;let alias_list=[];vjs(alias_dialog,"input",true).forEach(((inp,idx)=>{console.assert(idx==vjs.index(inp.parentNode),"must be idx== vjs.index(inp)");const each_lvc=kh_cms.attribute(inp,"each",true);if(inp.value!=each_lvc.value){team.set_alias(event_data.categories["holded-competition"][idx],inp.value);if(!kh_js.isEmpty(inp.value)&&inp.value!=team.name())alias_list.push(inp.value);modified=true;const row=col.closest(Table_UIContext.row_selector_);row.children[idx+2].setAttribute("title",kh_js.isEmpty(inp.value)?inp.value:team.name())}}));if(modified){event_data.teams=cs.Team.getTeamList(event_data.teams,undefined,undefined,false);let tabs2refresh=[TeamTable_UIContext.page_id_,...[...Array(cs.jo_cur_event.paramz.n_forerun)].map(((v,i)=>U`${"id.tab.page.forerun"}_${i+1}`)),U`${"id.tab.page.finalrun"}`];setModified(true,true,undefined,tabs2refresh);refreshView(tabs2refresh)}this.add_teams(...alias_list);return modified}on_teamno_col_click(event){const team=this.team_from_input(event);const dialog=vjs.NodeFromTemplate("alias-dialog")?.[0];if(!kh_js.isValid(dialog))throw new cs.Error("param-not-determined","dialog","alias-dialog");const uicontext_this=this;let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");const id_data_list=U`${"id.datalist.select.teams"}`;const input_list=event_data.categories["holded-competition"].map((competition=>new kh_cms.LVC({label:cs.getCompetitionNameFromMask(event_data,competition),value:team.aliases?.[competition]??"",attributes:{ui_model:"input-line",hp_style:"font-size:0.8em;",data_list:id_data_list,flex_basis_title:JSON.stringify({string:"`40%`"}),flex_basis_input:JSON.stringify({string:"`60%`"}),competition}})));vjs.data(dialog,"content",input_list);vjs.attr(dialog,"data-content","");kh_dialog({options:{popup_class:U`${"class.alias.dialog"}`,hide_icon:true,action_text:U`${"button-accept"}`},title:U`${"dbraw.basevoc.alias.dialog.title"} ${team.name()}`,message:dialog,logger:kh_log,async:true}).promise.then((res=>{if("ok"==res){uicontext_this.on_alias_dialog_ok_click(dialog,team,event.target)}}));kh_cms.processTemplateContent(dialog,undefined,"async")}sumAboveTeamTable(col_index){let n=vjs(this.table_element,`:scope > :not(:nth-child(-n+2)):not(:nth-last-child(-n+2)) > :nth-child(${col_index+1}):not(:empty)`,true)?.length;let cell=this.table_element.children.at(1)?.children[col_index];if(kh_js.isValid(cell)){cell.textContent=n;cell.setAttribute("data-sum-above",n.toString())}cell=this.table_element.children.at(-2)?.children[col_index];if(kh_js.isValid(cell)){cell.textContent=n;cell.setAttribute("data-sum-above",n.toString())}}static get page_id_(){delete TeamTable_UIContext.page_id_;return TeamTable_UIContext.page_id_=U`${"id.tab.page.teamlist"}`}}async function createTeamTable(table_element){try{await WriteRightsP;table_element=vjs(table_element)?.[0];if(!kh_js.isValid(table_element))throw new cs.Error("param-not-determined","table_element");let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let event_key=getEventKey();if(!kh_js.isValid(event_key))throw new cs.Error("param-not-determined","event_key");const tt_ui_context=new TeamTable_UIContext(table_element);const row_selector=TeamTable_UIContext.row_selector_;const col_selector=TeamTable_UIContext.col_selector_;let highest_boat_no=Math.max(40,...event_data.teams.map((team=>Number.parseInt(team.no))));let rows=[...Array(highest_boat_no+4)];let table=rows.map((row=>[...Array(event_data.categories["holded-competition"].length+3)]));table[0]=[cs.unzip("dbraw.basevoc.boat.no"),cs.unzip("dbraw.basevoc.team.name"),...event_data.categories["holded-competition"].map((hC=>cs.getCompetitionNameFromMask(event_data,hC))),new kh_cms.LVC({label:cs.unzip("dbraw.basevoc.start.due"),attributes:{tt:cs.unzip("dbraw.basevoc.start.due.tt")}})];const team_names=new Set;for(let i=0;i<highest_boat_no;++i){let row_no=i+2,team_no=i+1;let team_from_boat_no=event_data.teams.findByNo(team_no);table[row_no][0]=team_no.toString().padStart(3," ");if(team_from_boat_no){const team_name=team_from_boat_no.name();table[row_no][1]=team_name;if(!kh_js.isEmpty(team_name))team_names.add(team_name);table[row_no][table[row_no].length-1]=team_from_boat_no.pay_;for(let j=0;j<event_data.categories["holded-competition"].length;++j){const cat=event_data.categories["holded-competition"][j];let team_in_competition=team_from_boat_no.hasCat(cat);const alias=team_from_boat_no.aliases_?.[cat]||team_name;table[row_no][j+2]=new kh_cms.LVC({label:team_in_competition?"X":"",attributes:{tt:alias}});if(!kh_js.isEmpty(alias))team_names.add(alias)}}}table[table.length-1]=table[0];vjs.data(table_element,"kh-cms-cell-create",((row_index,col_index,cell,cell_data,row_element)=>{if(1==row_index||table.length-2==row_index){console.assert(table_element.children[row_index]==row_element,"check row_element");row_element.classList.add(U`${"class.hide.for.readers"}`);return""}let ret="";if(0==row_index||table.length-1==row_index){if(cell_data instanceof kh_cms.LVC){ret=kh_cms.createHtmlContent(cell_data.label);ret.setAttribute(kh_js.WindowArgs.title,cell_data.getAttribute(kh_js.WindowArgs.tooltip))}else ret=kh_cms.createHtmlContent(cell.innerHTML)}if(0==col_index){cell.classList.add(U`${"class.team.table.teamno.col"}`);if(!ret){cell.classList.add(`kh-hlayout`);ret=[vjs.create("span",{style:{textAlign:"center",flexBasis:"80%"},text:cell.textContent})];if(WriteRights())ret.push(vjs.create("span",{style:{flexBasis:"20%"},title:"@(dbraw.basevoc.alias.dialog.open.tt)"}))}}else if(1==col_index){cell.classList.add(U`${"class.team.table.teamname.col"}`);if(!ret){ret=vjs.create("input",{value:cell.textContent,style:{width:"100%"},dataReadonly:!WriteRights()})}}else if(table[row_index].length-1==col_index){cell.classList.add(U`${"class.team.table.payment.col"}`,U`${"class.hide.for.readers"}`);if(!ret){cell.classList.add(`kh-hlayout`,`kh-align-center`);ret=[vjs.create("input",{type:"number",value:"",min:"0.00",max:"1000.00",step:10,transactionCurrency:"€",style:"text-align:right;padding-right:0.1em;",dataReadonly:!WriteRights()}),vjs.create("p",{text:"€"})]}}else{vjs.data(cell,"cat",event_data.categories["holded-competition"][col_index-2]);if(!ret){cell.classList.add(cs.unzip("class.team.table.considered.col"));let tabindex=row_index*event_data.categories["holded-competition"].length+col_index-1;vjs.attr(cell,"tabindex",tabindex);vjs.style(cell,"text-align","center")}}return ret}));const ns=`${name}.teamlist`;vjs.off(`.${ns}`);vjs.onc(`change.${ns}`,(event=>tt_ui_context.on_team_name_change(event)),table_element,U`.${"class.team.table.teamname.col"} > input`);vjs.onc(`change.${ns}`,(event=>tt_ui_context.on_team_pay_change(event)),table_element,U`.${"class.team.table.payment.col"} > input`);vjs.onc(`keydown.${ns}`,(event=>tt_ui_context.on_cell_key(event)),table_element,U`.${"class.team.table.considered.col"}`);vjs.onc(`mousedown.${ns}`,(event=>event.target.focus({preventScroll:true})),table_element,U`.${"class.team.table.considered.col"}`);vjs.onc(`contextmenu.${ns}`,false,table_element,U`:not(.${"class.team.table.considered.col"})`);vjs.onc(`contextmenu.${ns}`,(event=>tt_ui_context.on_contextmenu_considered_col(event)),table_element,U`.${"class.team.table.considered.col"}`);vjs.onc(`pointerdown.${ns}`,(event=>tt_ui_context.on_teamno_col_click(event)),table_element,U`.${"class.team.table.teamno.col"}`);vjs.attr(table_element,"data-ncols",table[0].length);vjs.data(table_element,"ncols",table[0].length);kh_global.setTimeout((()=>{if(kh_js.isEmpty(vjs(table_element,`:scope ${col_selector}`))){kh_cms.processTemplateContent(vjs(table_element,`:scope ${row_selector}`))}[...Array(event_data.categories["holded-competition"].length)].map(((v,i)=>i+2)).forEach((v=>tt_ui_context.sumAboveTeamTable(v)));const id_data_list=U`${"id.datalist.select.teams"}`;const data_list=vjs(`#${id_data_list}`,false);if(kh_js.isValid(data_list)&&kh_js.isEmpty(data_list.children)){TeamNamesList.fromServer(data_list).then((teamlist=>{kh_log.debug?.(T9`successful receive teamlist => ${teamlist}`);vjs.attr(vjs(U`.${"class.team.table.teamname.col"} > input`,true),"list",id_data_list);kh_production_start_remove();if(!cs.uni_flag){kh_production_end_remove();if(WriteRights()){tt_ui_context.add_teams(...team_names.values())}kh_production_start_remove()}kh_production_end_remove()})).catch((error=>{kh_log.error?.(T9`error during request teamlist => ${error}`);cs.setStatus(error)}))}else{vjs.attr(U`.${"class.team.table.teamname.col"} > input`,"list",id_data_list)}if(WriteRights()){vjs(vjs(table_element,U`.${"class.team.table.teamname.col"} > input`,true).filter((elem=>!kh_js.isEmpty(elem.value))).map((elem=>elem.closest(row_selector))),U`.${"class.team.table.teamno.col"}`,true)?.forEach((elem=>elem.classList.add(U`${"class.icon.element"}`)))}}),500);return kh_cms.createRows(table_element,table)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}class TeamNamesList{constructor(jo={}){this.list_=jo;this.list_.teams=(this.list_.teams||[]).map(this._ensure_name).filter((tn=>!kh_js.isEmpty(tn)));this.list_.teams=new Set(this.list_.teams)}toJSON(){let ret={...this.list_};ret.teams=[...ret.teams];return ret}get teams(){return this.list_.teams}add(name){name=this._ensure_name(name);if(kh_js.isEmpty(name))return false;const tn_m=name.match(/([\w\s\d]+)\s*\d+/);if(!kh_js.isEmpty(tn_m))name=tn_m[1]||name;return this.list_.teams.size!=this.list_.teams.add(name).size}_ensure_name(name){return name?.trim().replace(/"/g,"ʺ").replace(/'/g,"´")}static async fromServer(dom_data_list){return kh_io.Util.fetchData(undefined,"/~data/teamlist",undefined,{get_json:true}).then((jo_data=>{jo_teamnames_list=new TeamNamesList(jo_data??undefined);TeamNamesList.assign2DOM(jo_teamnames_list,dom_data_list);return Promise.resolve(jo_teamnames_list)}))}static async toServer(team_list=jo_teamnames_list){return saveEventData("/~data/teamlist",false,team_list.toJSON())}static assign2DOM(team_list,dom_data_list){if(!kh_js.isValid(team_list)||!kh_js.isValid(dom_data_list))return;const content=[...team_list.teams].map((team_name=>vjs.create(`option`,{value:team_name,text:team_name})));vjs.data(dom_data_list,"content",content);vjs.attr(dom_data_list,"data-content","");kh_cms.processTemplateContent(dom_data_list)}}const frmtHeatNo=(prfx,no_forerun,no_heat)=>`${prfx}${(no_forerun+1)*100+no_heat+1}`;function createForerunTable(table_element){try{table_element=vjs(table_element)?.[0];if(!kh_js.isValid(table_element))throw new cs.Error("param-not-determined","table_element");let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let no_forerun=Number.parseInt(kh_cms.attribute(table_element,"data-series-no",true));event_data.foreruns||=[];event_data.foreruns[no_forerun]||=[];let cur_series=event_data.foreruns[no_forerun];return createHeatTable(table_element,frmtHeatNo.bind(null,"V",no_forerun))}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function createFinalrunTable(table_element){try{table_element=vjs(table_element)?.[0];if(!kh_js.isValid(table_element))throw new cs.Error("param-not-determined","table_element");let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let no_finalrun=Number.parseInt(kh_cms.attribute(table_element,"data-series-no",true));event_data.finalruns||=[];let cur_series=event_data.finalruns;const msg="drive_noop"!==event_data.paramz["double-race-order"]?U`${"dbraw.basevov.finalrun.track.apportion.some"}`:U`${"dbraw.basevov.finalrun.track.apportion.all"}`;const msg_div=vjs(vjs(table_element)?.[0].closest('[data-heat-type="finalrun"]'),U`#${"id.track.apportion.msg"}`);vjs.empty(msg_div);msg_div?.insertAdjacentElement("afterbegin",vjs.create("p",{style:{fontWeight:"bold"},text:msg}));return createHeatTable(table_element,frmtHeatNo.bind(null,"E",0))}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}class StartTime{constructor(event_data,heat_series_no){if(!event_data||!event_data.timetable)throw new cs.Error("param-not-determined","timetable");this.reset=()=>{let start_time=event_data.timetable[heat_series_no+1].start;start_time=start_time=start_time.split(":");this.start_t_=new Date(event_data["event-date"]);this.start_t_.setHours(start_time[0]);this.start_t_.setMinutes(start_time[1]);this.last_bk_=null};this.start_day_=event_data.timetable[heat_series_no+1].start;this.diff_with_change_=event_data.paramz["time-cost-change"].split(":").map((s=>Number.parseInt(s)));this.diff_without_change_=event_data.paramz["time-cost-without-change"].split(":").map((s=>Number.parseInt(s)));this.reset()}next(cat){let cur_bk=cs.getBoatMaskFromMask(cat);if(null!=this.last_bk_){let diff_time=this.last_bk_==cur_bk?this.diff_without_change_:this.diff_with_change_;this.start_t_=new Date(this.start_t_.valueOf()+diff_time[0]*60*1e3+diff_time[1]*1e3)}this.last_bk_=cur_bk;return this.formatted}get formatted(){return`${this.current.getHours().toString().padStart(2,"0")}:${this.current.getMinutes().toString().padStart(2,"0")}`}get current(){return this.start_t_}}class Heat_UIContext extends Table_UIContext{constructor(table_element,frmt_heat_no,cur_series){super(table_element);if(kh_js.isEmpty(cur_series))throw new cs.Error("param-not-determined","cur_series");this.is_finalrun_=!kh_js.string2bool(cs.unzipProp(kh_cms.attribute(this.table_element,"data-is-forerun",true),this.table_element));this.n_boats_per_race_=Number.parseInt(cs.unzipProp(kh_cms.attribute(this.table_element,"data-nboats-per-race",true),this.table_element));this.fix_cols_=!this.is_finalrun_?2:3;this.var_cols_=5;this.ncols_=this.n_boats_per_race_*this.var_cols_+this.fix_cols_;this.seriesno_=this.is_finalrun_?0:Number.parseInt(cs.unzipProp(kh_cms.attribute(this.table_element,"data-series-no",true),this.table_element));this.cur_series_=cur_series.paramz?this.is_finalrun_?cur_series.finalruns:cur_series.foreruns[this.seriesno_]:cur_series;this.selected_=[];this.frmt_heat_no_=frmt_heat_no}get is_finalrun(){return this.is_finalrun_}get n_boats_per_race(){return this.n_boats_per_race_}get fix_cols(){return this.fix_cols_}get var_cols(){return this.var_cols_}get ncols(){return this.ncols_}get SeriesNo(){return this.seriesno_}get cur_series(){return this.cur_series_}trackno(col_index){return(col_index-this.fix_cols)/this.var_cols>>>0}HeatNoFromRowIndex(row_index){if(kh_js.isNumber(row_index))return-1!=row_index?row_index-1>>>0:-1;if(kh_js.isEvent(row_index))return this.HeatNoFromRowIndex(vjs.index(row_index.target.closest(Heat_UIContext.row_selector_)));return-1}TrackNoFromColIndex(col_index){if(kh_js.isNumber(col_index))return-1!=col_index?(col_index-this.fix_cols_)/this.var_cols_>>>0:-1;if(kh_js.isEvent(col_index))return this.TrackNoFromColIndex(vjs.index(row_index.target.closest(Heat_UIContext.col_selector_)));return-1}checkSelected(){return!kh_js.isEmpty(this.selected_[0])&&kh_js.isNumber(this.selected_[0].heatno)&&kh_js.isNumber(this.selected_[0].trackno)&&!kh_js.isEmpty(this.selected_[1])&&kh_js.isNumber(this.selected_[1].heatno)&&kh_js.isNumber(this.selected_[0].trackno)}teamno_cell(pos){if(!kh_js.isValid(pos)||!kh_js.isValid(pos.heatno)||!kh_js.isValid(pos.trackno))return undefined;const ret=this.table_element.children[pos.heatno+1]?.children[this.fix_cols+this.var_cols*pos.trackno];return ret}teamno_cell_selected(sel_index){if(0!==sel_index&&1!==sel_index)return undefined;return this.teamno_cell(this.selected_[sel_index])}on_key(event,data){switch(event.key){case"x":case"X":{if(event.ctrlKey){if("function"===typeof data)data()}break}case"Escape":{[this.teamno_cell_selected(0),this.teamno_cell_selected(1)].forEach((cell=>cell?.classList.remove("selected")));this.selected_=[];this.handle_equal_teamno();this.handle_equal_cat();break}default:break}}on_teamno_cell_active(event){const ns="cell_active";if("focusin"===event.type){vjs.on(`wheel.${ns}`,false,event.target);vjs.on(`keydown.${ns}`,(event=>"ArrowUp"===event.key||"ArrowDown"===event.key?false:undefined),event.target)}else if("focusout"===event.type){vjs.off(`.${ns}`,undefined,event.target)}}on_swap_rows(){if(0==arguments.length){if(!this.checkSelected()||this.selected_[0].trackno!=this.selected_[1].trackno)return;const[heatno_0,trackno_0,heatno_1,trackno_1]=[...Object.values(this.selected_[0]),...Object.values(this.selected_[1])];const teamno_cell_0=this.teamno_cell_selected(0);const teamno_cell_1=this.teamno_cell_selected(1);if(![teamno_cell_0,teamno_cell_1].every((node=>node.classList.contains("selected"))))return;if(![teamno_cell_0,teamno_cell_1].every((node=>!node.classList.contains(U`${"class.heat.team.moved.forward"}`))))return;const heat_0=this.cur_series_[heatno_0][trackno_0];const heat_1=this.cur_series_[heatno_1][trackno_1];if(!kh_js.isValid(heat_0)&&!kh_js.isValid(heat_1))return;if(kh_js.isValid(heat_0)&&kh_js.isValid(heat_1)){if(cs.getBoatIndexFromMask(heat_0.cat)!=cs.getBoatIndexFromMask(heat_1.cat))return;if(heat_0.trackno!=heat_1.trackno)return}[this.cur_series_[heatno_0][trackno_0],this.cur_series_[heatno_1][trackno_1]]=[this.cur_series_[heatno_1][trackno_1],this.cur_series_[heatno_0][trackno_0]];if(!kh_js.isValid(this.cur_series_[heatno_0][trackno_0]))this.cur_series_[heatno_0].splice(trackno_0,1);if(!kh_js.isValid(this.cur_series_[heatno_1][trackno_1]))this.cur_series_[heatno_1].splice(trackno_1,1);setModified(true,true,undefined,getPanel(this.table_element)?.getAttribute("id"));[this.selected_[0],this.selected_[1]]=[this.selected_[1],this.selected_[0]];this.trigger_refresh()}else{const[heatno_0,heatno_1,trigger=true]=[...arguments];if(!kh_js.isValid(heatno_0)||!kh_js.isValid(heatno_1))return;[this.cur_series_[heatno_0],this.cur_series_[heatno_1]]=[this.cur_series_[heatno_1],this.cur_series_[heatno_0]];this.selected_=this.selected_.map((sel_entry=>{if(!kh_js.isValid(sel_entry))return sel_entry;if(sel_entry.heatno==heatno_0)sel_entry.heatno=heatno_1;else if(sel_entry.heatno==heatno_1)sel_entry.heatno=heatno_0;return sel_entry}));if(false!==trigger){setModified(true,true,undefined,getPanel(this.table_element)?.getAttribute("id"));this.trigger_refresh()}}}on_cat_change(event){const heatno=this.HeatNoFromRowIndex(event);const trackno=this.TrackNoFromColIndex(event);let heat_entry=this.cur_series_[heatno][trackno];const cat=event.target.value;heat_entry.cat=cat;setModified(true,true,undefined,getPanel(this.table_element)?.getAttribute("id"));this.trigger_refresh()}on_teamno_change(event,data){const heatno=this.HeatNoFromRowIndex(event);const trackno=this.TrackNoFromColIndex(event);let heat_entry=this.cur_series_[heatno][trackno];const teamno=Number.parseInt(event.target.value);const invalid=isNaN(teamno)||"function"===typeof data&&!data(event,teamno);if(invalid){if(heat_entry&&heat_entry.manual)delete this.cur_series_[heatno][trackno]}else{if(!kh_js.isValid(heat_entry))heat_entry=this.cur_series_[heatno][trackno]={time:new cs.RaceTime,manual:true};heat_entry.no=teamno;this.selected_=[{heatno,trackno}]}setModified(true,true,undefined,getPanel(this.table_element)?.getAttribute("id"));this.trigger_refresh()}on_teamno_click(event){const candidate={heatno:this.HeatNoFromRowIndex(event),trackno:this.TrackNoFromColIndex(event)};if(kh_js.isValid(this.selected_[0])&&this.selected_[0].equals(candidate))return;if(kh_js.isValid(this.selected_[1])){const cell=this.teamno_cell_selected(1);cell?.classList.remove("selected")}if(kh_js.isValid(this.selected_[0])&&this.selected_[0].trackno!=candidate.trackno){const cell=this.teamno_cell_selected(0);cell?.classList.remove("selected");this.selected_=[]}this.selected_[1]=this.selected_[0];this.selected_[0]=candidate;const cell=this.teamno_cell_selected(0);cell?.classList.add("selected");this.handle_equal_teamno();this.handle_equal_cat()}on_updown_click(event){const down=0!=vjs.index(event.target);let two_lines=true===event.ctrlKey;const heatno_0=vjs.index(event.target.closest(Heat_UIContext.row_selector_))-1;if(two_lines){if(down){if(0==heatno_0)two_lines=false;if(heatno_0+2>=this.cur_series_.length)two_lines=false}else{if(this.cur_series_.length-1==heatno_0)two_lines=false;if(heatno_0-2<0)two_lines=false}if(!this.is_finalrun){}}if(down){if(heatno_0+1>=this.cur_series_.length)return}else if(0==heatno_0)return;if(!this.is_finalrun){}if(two_lines){if(down){if(0<heatno_0)this.on_swap_rows(heatno_0-1,heatno_0+1,false)}else{if(heatno_0<this.cur_series_.length-1)this.on_swap_rows(heatno_0+1,heatno_0-1,false)}}if(down){this.on_swap_rows(heatno_0,heatno_0+(two_lines?2:1))}else{this.on_swap_rows(heatno_0,heatno_0-(two_lines?2:1))}}on_time_change(event){const time_input=event.target;let time_value=time_input.value;if(kh_js.isEmpty(time_value)||/^(?:(?:[0-5]?[0-9]:[0-5]?[0-9][,\.][0-9]{1,3})|(?:[0-9]{5,6})|DNS|DNF|DSQ)$/i.test(time_value)){time_input.setCustomValidity("");let rt=new cs.RaceTime(time_value);time_input.value=rt.toString(true);const heatno=this.HeatNoFromRowIndex(event);const trackno=this.TrackNoFromColIndex(event);const heat_entry=this.cur_series_[heatno][trackno];heat_entry.time=rt;const page=getPanel(this.table_element)?.getAttribute("id");let broadcast={page,selector:`#${page} #${time_input.closest(Heat_UIContext.row_selector_).getAttribute("id")} `+`#${time_input.closest(Heat_UIContext.col_selector_).getAttribute("id")} input`,value:rt.toString()};setModified(true,true,undefined,canSendFinalResults(this.is_finalrun)?broadcast:undefined)}else{time_input.setCustomValidity(cs.unzip("dbraw.basevoc.err.invalid.heat.time"))}}trigger_refresh(){this.cur_series_=this.is_finalrun_?cs.jo_cur_event.finalruns:cs.jo_cur_event.foreruns[this.seriesno_];const series_stem=this.is_finalrun?"finalruns":"foreruns";const elems_must_reset=vjs(this.table_element.parentNode,U`.${`class.reset.${series_stem}.change`}`,true);elems_must_reset?.forEach((elem=>vjs.data(elem,"kh-cms-processed")?.delete("create")));vjs.empty(elems_must_reset);kh_cms.processTemplateContent(elems_must_reset)}handle_selected(sel_index){if(!kh_js.isValid(sel_index))vjs(this.table_element,"div.selected",true)?.forEach((selected_div=>selected_div.classList.remove("selected")));this.selected_.forEach(((v,i)=>{if(!kh_js.isValid(v)||sel_index&&sel_index!=i)return;const cell=this.teamno_cell_selected(i);cell?.classList.add("selected")}));if(!kh_js.isValid(sel_index)){const cell=this.teamno_cell_selected(0);if(kh_js.isValid(cell))vjs(cell,":scope > input",false)?.focus()}}handle_equal_teamno(){vjs(this.table_element,"div.equal-no",true)?.forEach((elem_equ=>elem_equ.classList.remove("equal-no")));this.selected_.forEach(((v,i)=>{if(!kh_js.isValid(v))return;const cell=this.teamno_cell_selected(i);if(kh_js.isValid(cell)){const val=vjs(cell,"input",false)?.value;vjs(this.table_element,`input[value="${val}"]`,true)?.forEach((inp=>inp.parentNode.classList.add("equal-no")))}}))}handle_equal_cat(){vjs(this.table_element,"div.equal-cat",true)?.forEach((elem_equ=>elem_equ.classList.remove("equal-cat")));this.selected_.forEach(((v,i)=>{if(!kh_js.isValid(v)||0!=i)return;const cell=this.teamno_cell_selected(i);if(kh_js.isValid(cell)){let cell_cat=vjs.nextOne(cell,`.${Heat_UIContext.class_heat_cat_col_}`);if(!kh_js.isEmpty(cell_cat.children))cell_cat=cell_cat.children[0];if(!kh_js.isValid(cell_cat))return;const cur_cat="SELECT"==cell_cat.tagName?-1!=cell_cat.selectedIndex?cell_cat.options[cell_cat.selectedIndex].value:"":cell_cat.textContent;if(kh_js.isEmpty(cur_cat))return;const cells=vjs.contains(this.table_element,cur_cat)?.filter((cell=>cell.matches(`${Heat_UIContext.row_selector_} > .${Heat_UIContext.class_heat_cat_col_}`)));cells.forEach((cell=>cell.classList.add("equal-cat")))}}))}mark_narrow_starts(){[Heat_UIContext.class_double_starts_,Heat_UIContext.class_narrow_starts_].forEach((classz=>{vjs(this.table_element,`div.${classz}`)?.forEach((elem=>elem.classList.remove(`${classz}`)))}));this.cur_series_.forEach(((cur_heat,heatno)=>{let teams_in_heat=new Set;cur_heat.forEach(((team,trackno)=>{if(teams_in_heat.has(team.no)){cur_heat.forEach(((next_team,next_trackno)=>{if(next_team.no==team.no){let cell=this.teamno_cell({heatno,trackno:next_trackno});cell?.classList.add(Heat_UIContext.class_double_starts_)}}))}else teams_in_heat.add(team.no);const limit_narrow_start=3;const sub_series=this.cur_series_.slice(heatno+1,heatno+1+limit_narrow_start).forEach(((next_heat,next_heatno)=>{next_heat.forEach(((next_team,next_trackno)=>{if(team.no==next_team.no){let cell=this.teamno_cell({heatno,trackno});cell?.classList.add(Heat_UIContext.class_narrow_starts_);cell=this.teamno_cell({heatno:heatno+1+next_heatno,trackno:next_trackno});cell?.classList.add(Heat_UIContext.class_narrow_starts_)}}))}))}))}))}static get class_heat_cat_col_(){delete Heat_UIContext.class_heat_cat_col_;return Heat_UIContext.class_heat_cat_col_=cs.unzip("class.heat.cat.team.col")}static get class_heat_teamno_col_(){delete Heat_UIContext.class_heat_teamno_col_;return Heat_UIContext.class_heat_teamno_col_=U`${"class.heat.teamno.col"}`}static get class_double_starts_(){delete Heat_UIContext.class_double_starts_;return Heat_UIContext.class_double_starts_=U`${"class.double.starts"}`}static get class_narrow_starts_(){delete Heat_UIContext.class_narrow_starts_;return Heat_UIContext.class_narrow_starts_=U`${"class.narrow.starts"}`}static get class_starttime_(){delete Heat_UIContext.class_starttime_;return Heat_UIContext.class_starttime_=U`${"class.heat.starttime.col"}`}}async function createHeatTable(table_element,frmt_heat_no=(i=>(i+1).toString().padStart(3,"0"))){try{await WriteRightsP;table_element=vjs(table_element)?.[0];if(!kh_js.isValid(table_element))throw new cs.Error("param-not-determined","table_element");let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");const must_create_context=event_data["event-name"]!==vjs.data(table_element,"event-name")||!kh_js.isValid(vjs.data(table_element,"ui-context"));if(must_create_context)vjs.data(table_element,"ui-context",new Heat_UIContext(table_element,frmt_heat_no,event_data));const uic=vjs.data(table_element,"ui-context");vjs.data(table_element,"event-name",event_data["event-name"]);const can_change_teamno=WriteRights()&&(!uic.is_finalrun||true);const can_change_time=WriteRights();if(uic.n_boats_per_race!=(!uic.is_finalrun?event_data.paramz.n_boats_per_race:event_data.paramz.max_boats_per_race))throw new cs.Error("difference in data-nboats-per-race");if(cs.unzipProp(kh_cms.attribute(table_element,"data-add-cols",true),table_element)!=uic.fix_cols)throw new cs.Error("difference in data-add-cols");if(cs.unzipProp(kh_cms.attribute(table_element,"data-ncols",true),table_element)!=uic.ncols)throw new cs.Error("difference in data-ncols");let rows=[...Array(uic.cur_series.length+1)];let table=rows.map((row=>[...Array(uic.ncols)]));let fix_cols=[`${cs.unzip("dbraw.basevoc.heat")}<br>${cs.unzip("dbraw.basevoc.competition")}`,cs.unzip("dbraw.basevoc.fight.for"),cs.unzip("dbraw.basevoc.start.time")].filter(((v,i)=>uic.is_finalrun||1!=i));vjs.cssvar(table_element,"--heat-table-fix-cols",fix_cols.length);const track_add_keys=event_data.paramz["track-add-keys"]||[];table[0]=[...fix_cols,...[...Array(uic.n_boats_per_race)].map(((v,i)=>{let track_add=cs.unzip(`dbraw.basevoc.track.add.${track_add_keys[i]}`);if(!kh_js.isEmpty(track_add))track_add=` (${track_add})`;else track_add="";return[`${cs.unzip("dbraw.basevoc.track")} ${i+1}${track_add}<br>${cs.unzip("dbraw.basevoc.boat.no")}`,cs.unzip("dbraw.basevoc.team.name"),cs.unzip("dbraw.basevoc.heat.time"),cs.unzip("dbraw.basevoc.competition"),cs.unzip("dbraw.basevoc.flag")]})).flat()];let start_t=new StartTime(event_data,!uic.is_finalrun?uic.SeriesNo:event_data.foreruns.length+uic.SeriesNo);let all_cats_same=true;const cat_mapper=cat=>cat?.values?.().next().value||Array.isArray(cat)&&cat[0]||cat;for(let i=0;i<uic.cur_series.length;++i){const row_no=i+1;const cur_heat=uic.cur_series[i];const cat_0=cat_mapper(cur_heat[0].cat);const heat_all_cats_same=cur_heat.every((team=>cat_0==cat_mapper(team.cat)));if(all_cats_same)all_cats_same=heat_all_cats_same;const fight_for_string=!uic.is_finalrun?"":cur_heat.map((team=>team?.fight_for??"")).sort(((ff1,ff2)=>heat_all_cats_same?ff1-ff2:1)).join("/");fix_cols=[`${frmt_heat_no(i)}<br>${cs.getCompetitionNameFromMask(event_data,cat_0)}`,function(cell,cell_data,row_element){cell.classList.add("kh-vlayout");return!uic.is_finalrun?"":[vjs.create("span",{text:fight_for_string}),cur_heat[0].init_considered<=1?undefined:vjs.create("span",{text:`L ${cur_heat[0].init_considered-cur_heat[0].n_considered+1}/${cur_heat[0].init_considered}`})].filter(kh_js.isValid)},`${start_t.next(cat_0)}`].filter(((v,i)=>uic.is_finalrun||1!=i));table[row_no]=new kh_cms.LVC({label:fix_cols.slice(0,1)[0],value:fix_cols.slice(-1)[0],attributes:Object.assign({heat:cur_heat},uic.is_finalrun?{fight_for:fix_cols[1]}:{})});all_cats_same&&=heat_all_cats_same}let track_occupied=[...Array(uic.n_boats_per_race)].map(((v,i)=>false));const register_starts=WriteRights()?new kh_js.Map2Array:undefined;let was_modified_seriesno=false;if(WriteRights()&&!uic.is_finalrun){for(let i=0;i<uic.SeriesNo;++i){const forerun=event_data.foreruns[i];for(let heat of forerun){for(let track of heat){const key=`${track.no}-${track.cat}`;register_starts.add(key,track)}}}}vjs.data(table_element,"kh-cms-cell-create",((row_index,col_index,cell,cell_data,row_element)=>{let ret="";const fixl=fix_cols.length;if(col_index<fixl){if(0==col_index){cell.classList.add(U`${"class.heat.heatno.col"}`);const[heatno,competition_name]=cell_data.label?.split("<br>")??cell_data.split("<br>");cell.classList.add("kh-vlayout");ret=[vjs.create("span",{text:heatno}),vjs.create("span",{text:competition_name})]}if(fix_cols.length-1==col_index){cell.classList.add(U`${"class.heat.starttime.col"}`);if(0!=row_index)ret=cell_data.value}if(1==col_index&&uic.is_finalrun){cell.classList.add(U`${"class.heat.fightfor.col"}`);if(0!=row_index){let fight_for=cell_data.getAttribute("fight_for");if("function"==typeof fight_for){ret=fight_for}else ret=fight_for}}}const cur_heat=0!=row_index?cell_data.getAttribute("heat"):undefined;const dmy=0!=row_index?{no:0,name:()=>"",time:new cs.RaceTime}:undefined;const trackno=uic.trackno(col_index);let team_data=0!=row_index?cur_heat[trackno]||dmy:undefined;if(0==col_index){if(0==row_index)vjs.cssvar(row_element,"--heat-table-n-teams-in-heat",event_data.paramz.n_boats_per_race);else vjs.cssvar(row_element,"--heat-table-n-teams-in-heat",cur_heat.length)}if(0!=row_index&&0==(col_index-fixl)%5&&WriteRights()){const key=`${team_data.no}-${team_data.cat}`;const cur_length=register_starts.get(key)?.length??0;if(!uic.is_finalrun){if(dmy!=team_data&&team_data.seriesno!=cur_length){team_data.seriesno=cur_length;was_modified_seriesno=true}}else{if(dmy!=team_data&&1!==(team_data.init_considered||1)&&team_data.n_considered!=team_data.init_considered-cur_length){team_data.n_considered=team_data.init_considered-cur_length;vjs.data(row_element.children[1],"col-refresh")?.();was_modified_seriesno=true}}register_starts.add(key,team_data)}let is_moved_forward=0!=row_index&&!uic.is_finalrun&&kh_js.isValid(team_data.seriesno)?team_data.seriesno!=uic.SeriesNo:false;const team_name=0!=row_index?"function"===typeof team_data.name?team_data.name():event_data.teams.findByNo(team_data.no)&&event_data.teams.findByNo(team_data.no).name(team_data.cat):"";if(0==(col_index-fixl)%5){cell.classList.add(`${Heat_UIContext.class_heat_teamno_col_}`);if(0==row_index){const[row0,row1]=cell_data.split("<br>");cell.classList.add("kh-vlayout");ret=[vjs.create("span",{text:row0})];if(!kh_js.isEmpty(row1))ret.push(vjs.create("span",{text:row1}))}else{if(false==track_occupied[trackno]&&(team_data&&0!==team_data.no))track_occupied[trackno]=true;if(is_moved_forward){cell.classList.add(U`${"class.heat.team.moved.forward"}`)}ret=[vjs.create("span",{style:{minWidth:"1.5em",width:"50%"}}),vjs.create("input",{value:0!=team_data.no?team_data.no:"",type:"number",min:1,max:64,tabindex:0,style:"width:50%;",readonly:can_change_teamno?null:true,title:kh_js.isEmpty(team_name)?U`${"dbraw.basevoc.enter.valid.teamno"}`:team_name})];vjs.data(cell,"team-data",team_data)}}if(1==(col_index-fixl)%5){cell.classList.add(U`${"class.heat.teamname.col"}`);if(0!=row_index){if(is_moved_forward)cell.classList.add(U`${"class.heat.team.moved.forward"}`);ret="function"===typeof team_data.name?team_data.name():event_data.teams.findByNo(team_data.no).name(team_data.cat);cell.setAttribute("title",U`${kh_js.isEmpty(team_name)?"dbraw.basevoc.enter.valid.teamno":team_name}`)}}if(2==(col_index-fixl)%5){cell.classList.add(U`${"class.heat.heattime.col"}`,U`${"class.not4print"}`);if(0!=row_index){ret=vjs.create("input",{value:0!=team_data.no?team_data.time.toString(true):"",type:"text",tabindex:0,style:"width:90%;",readonly:can_change_time&&0!=team_data.no?null:"true"})}}if(3==(col_index-fixl)%5){cell.classList.add(U`${"class.heat.competition.team.col"}`);if(0!=row_index){ret=kh_js.isValid(team_data.cat)?cs.getCompetitionNameFromMask(event_data,cat_mapper(team_data.cat)):"";vjs.style(cell,{"font-size":"0.8em"})}}if(4==(col_index-fixl)%5){cell.classList.add(U`${Heat_UIContext.class_heat_cat_col_}`,U`${"class.hide.for.readers"}`,U`${"class.not4print"}`);if(0!=row_index){let cats=undefined;if(!kh_js.isValid(team_data.cat)&&0!=team_data.no||team_data.manual){const team_list=cs.Team.getTeamList(event_data,0,true);const team=team_list.findByNo(team_data.no);switch(team.cat.size){case 0:break;case 1:team_data.cat=cat_mapper(team.cat);break;default:cats=[...team.cat];break}}if(Array.isArray(cats)){let values=cats.map((cat=>new kh_cms.LVC({label:cs.getCompetitionNameFromMask(event_data,cat),value:cat})));ret=vjs.create("select",{class:"@(class.not4print)",tabindex:0,style:{width:"4em"},dataReadonly:!WriteRights(),dataValue:JSON.stringify(values),dataSelectedIndex:-1});const sel_index=cats.indexOf(team_data.cat);if(-1!=sel_index){vjs.onoff(cs.unzipProp("cms-event-ready-tc"),((event,canceler)=>{if(canceler(event))ret.selectedIndex=sel_index}),(event=>ret==event.data.node))}kh_cms.processTemplateContent(ret,undefined,"async")}else{ret=kh_js.isValid(team_data.cat)?cat_mapper(team_data.cat):""}}}if(0!=row_index){if(0==col_index)cell.classList.add(cs.unzip("class.up.element"));if(table[0].length-1==col_index){kh_global.setTimeout((()=>vjs.create("span",{class:U`${"class.down.element"}`,style:"width:0;padding:0;min-width:0;max-width:0;"},row_element)),20)}}return ret}));const ns="heat_table";vjs.off(`.${ns}`,undefined,table_element);vjs.data(table_element,"kh-cms-opt",table);table_element.classList.add(cs.unzip("class.updown.list"));vjs.attr(table_element,"tabindex",0);if(can_change_teamno){vjs.onc(`keydown.${ns}`,(event=>uic.on_key(event,(()=>uic.on_swap_rows()))),table_element,`.${Heat_UIContext.class_heat_teamno_col_} > input`);vjs.onc(`change.${ns}`,(event=>{uic.on_teamno_change(event,((e,no)=>{const team_list=cs.Team.getTeamList(event_data,0,true);const team=team_list.findByNo(no);kh_global.setTimeout((()=>e.target.value=""),100);return kh_js.isValid(team)&&team.considered}))}),table_element,`.${Heat_UIContext.class_heat_teamno_col_} > input`);vjs.onc(`pointerdown.${ns}`,(event=>{if(0==event.button)uic.on_teamno_click(event)}),table_element,`.${Heat_UIContext.class_heat_teamno_col_} > input`)}vjs.onc(`focusin.${ns} focusout.${ns}`,(e=>uic.on_teamno_cell_active(e)),table_element,`.${Heat_UIContext.class_heat_teamno_col_} > input`);if(can_change_teamno){vjs.onc(`pointerdown.${ns}`,(event=>{vjs.forwardEvent(event,vjs(event.target.closest(Heat_UIContext.row_selector_),`.${Heat_UIContext.class_heat_teamno_col_} > input`))}),table_element,U`${Heat_UIContext.row_selector_} > .${"class.heat.teamname.col"}`)}if(can_change_time)vjs.onc(`change.${ns}`,(event=>uic.on_time_change(event)),table_element,U`.${"class.heat.heattime.col"} > input`);if(WriteRights()){vjs.onc(`pointerdown.${ns}`,(event=>{if(0==event.button)uic.on_updown_click(event)}),table_element,U`${Heat_UIContext.row_selector_} > .${"class.up.element"}`);vjs.onc(`pointerdown.${ns}`,(event=>{if(0==event.button)uic.on_updown_click(event)}),table_element,U`${Heat_UIContext.row_selector_} > .${"class.down.element"}`);vjs.onc(`change.${ns}`,(event=>uic.on_cat_change(event)),table_element,`.${Heat_UIContext.class_heat_cat_col_} > select`)}kh_global.setTimeout((()=>{uic.handle_selected();uic.handle_equal_teamno();uic.handle_equal_cat();uic.mark_narrow_starts();if(WriteRights()&&was_modified_seriesno)setModified(true,true,undefined,getPanel(table_element)?.getAttribute("id"));const sum_unoccupied=track_occupied.reduce(((s,v)=>s+(false==v?1:0)),0);const min_width_std=3;const sum_track=3*min_width_std+5+8;const sum_cat=2*min_width_std;let min_width=6+uic.fix_cols*min_width_std+(uic.n_boats_per_race-sum_unoccupied)*sum_track-(all_cats_same?(uic.n_boats_per_race-1-sum_unoccupied)*sum_cat:0);vjs.style(table_element,{minWidth:`${min_width}em`});if(all_cats_same)table_element.classList.add(cs.unzip("class.all.cats.same"));track_occupied.forEach(((occupied,trackno)=>{if(!occupied){const teamno_cols=vjs(table_element,U`.${"class.heat.teamno.col"}`,true)?.filter((col=>trackno===uic.trackno(vjs.index(col))));if(!kh_js.isEmpty(teamno_cols)){const change_visibilty=visible=>{teamno_cols.forEach((col=>{const nextCols=[col,...vjs.nextUntil(col,U`.${"class.heat.teamno.col"}`)||[]].filter((elem=>"SPAN"!==elem.tagName));nextCols.forEach((elem=>true===visible?elem.classList.remove("hide-it-force"):elem.classList.add("hide-it-force")))}))};const teamno_col_head=teamno_cols[0];const col_prev=teamno_col_head.previousElementSibling;col_prev.classList.add(U`${"class.heat.cols.fade.in"}`);col_prev.setAttribute("title",U`${"dbraw.basevoc.heat.cols.fade.in"}`);vjs.on("pointerdown",(e=>change_visibilty(true)),col_prev);const next_cols_head=vjs.nextUntil(teamno_col_head,U`.${"class.heat.teamno.col"}`);const next_cols_head_last=next_cols_head.at(-1);next_cols_head_last.classList.add(U`${"class.heat.cols.fade.out"}`);next_cols_head_last.setAttribute("title",U`${"dbraw.basevoc.heat.cols.fade.out"}`);vjs.on("pointerdown",(e=>change_visibilty(false)),next_cols_head_last);change_visibilty(false)}}}))}),250);return kh_cms.createRows(table_element)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function fillHeatTime(event,race_time_generator=(()=>new cs.RaceTime)){let btn=event.target;let table_elem=vjs(getPanel(btn),`[class*="kh-table-nw"]`,false);const uic=vjs.data(table_elem,"ui-context");uic.cur_series.forEach(((cur_series$heatno,heatno)=>cur_series$heatno.forEach(((cur_series$heatno$trackno,trackno)=>{cur_series$heatno$trackno.time=race_time_generator()}))));setModified(true,true,undefined,vjs.attr(getPanel(uic.table_element),"id"));uic.trigger_refresh()}function createHoldedCompetitionTable(table_element){try{table_element=vjs(table_element);table_element=table_element?.[0];if(!kh_js.isValid(table_element))throw new cs.Error("param-not-determined","table_element");const categories=(()=>{const event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");event_data.categories||=[];event_data.categories.boat||=[];event_data.categories.league||=[];if(kh_js.isEmpty(event_data.categories.boat)||kh_js.isEmpty(event_data.categories.league))kh_log.warn?.(U`${"dbraw.possible.invalid.config"} -> [ 'boat', 'league' ]`);event_data.categories["holded-competition"]||=[];return()=>event_data.categories})();const holded_competition=()=>categories()["holded-competition"];let boats=categories().boat.filter((boat=>!kh_js.isEmpty(boat)));let leagues=categories().league.filter((league=>!kh_js.isEmpty(league)));let rows=[...Array(leagues.length+1)];let table=rows.map((row=>[...Array(boats.length+1)]));table[0]=["",...boats];for(let i=1;i<table.length;++i)table[i][0]=leagues[i-1];vjs.data(table_element,"kh-cms-cell-create",((row_index,col_index)=>{if(0==row_index||0==col_index)return"";let boat=boats[col_index-1];let boat_index=categories().boat.indexOf(boat);let league=leagues[row_index-1];let league_index=categories().league.indexOf(league);let imask=boat_index+1+(16<<league_index)>>>0;let smask=imask.toString(16);let checked=-1!=holded_competition().indexOf(smask);return vjs.create("input",{type:"checkbox",dataFlag:smask,dataChecked:checked,dataClass:"@(class.disable.for.readers)"})}));const onCheckCompetition=event=>{const check=event.target;let remove=!check.checked;let smask=check.dataset.flag;let add=remove?[]:[smask];holded_competition().splice(remove?holded_competition().indexOf(smask):holded_competition().length,remove?1:0,...add);vjs.trigger(cs.unzip("event.order.holded.competition.change"),cs.getMainWindow());kh_log.trace?.("beteiligte Events",holded_competition())};const ns="cHC";vjs.off(`.${ns}`,undefined,table_element);vjs.onc(`change.${ns}`,onCheckCompetition,table_element,"input");vjs.onc(`pointerdown.${ns}`,(e=>{if(!WriteRights()){e.stopImmediatePropagation();e.preventDefault()}}),table_element,"input");vjs.trigger(cs.unzip("event.order.holded.competition.change"),cs.getMainWindow(),true);vjs.data(table_element,"kh-cms-opt",table);return kh_cms.createRows(table_element)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function renewCompetitionOrderList(event){const fake=event.detail;let holded_competition=cs.jo_cur_event.categories["holded-competition"];let onUpOrDown=(e,do_up)=>{const idx=vjs.index(e.target.parentNode);let removed=holded_competition.splice(idx,1);holded_competition.splice(idx+(do_up?-1:+1),0,...removed);vjs.trigger(cs.unzip("event.order.holded.competition.change"),cs.getMainWindow())};let onAliasNameChange=e=>{if("focusout"==e.type)setModified("",true===setModified(null));else{const idx=vjs.index(e.target.parentNode);cs.setCompetitionAliasFromMask(undefined,holded_competition[idx],e.target.value);setModified(true,false)}};let Șcompetition_order_list=vjs(`#${cs.unzip("id.order.holded.competition")}`,false);vjs.empty(Șcompetition_order_list);let content=holded_competition.map(((cat_mask,idx)=>{let alias=cs.getCompetitionAliasFromMask(undefined,cat_mask)||"";let label=cs.getCompetitionNameFromMask(undefined,cat_mask);return new kh_cms.LVC({label,attributes:{ui_model:"competition-line",cat:cat_mask,alias}})}));vjs.onoff(cs.unzip("cms-event-children-tc"),((event,my_node_test)=>{if(my_node_test(event)){const ns=".c_o_l";vjs.off(ns,undefined,Șcompetition_order_list);vjs.onc(`click${ns}`,(e=>onUpOrDown(e,true)),Șcompetition_order_list,U`span.${"class.up.element"}`);vjs.onc(`click${ns}`,(e=>onUpOrDown(e,false)),Șcompetition_order_list,U`span.${"class.down.element"}`);vjs.onc(`change${ns} focusout${ns}`,(e=>onAliasNameChange(e)),Șcompetition_order_list,U`input`)}}),window,(event=>event.detail?.node?.equals(Șcompetition_order_list)));vjs.attr(Șcompetition_order_list,"data-content","");vjs.data(Șcompetition_order_list,"content",content);if(true!==fake)setModified(true,true,undefined,[U`${"id.tab.page.timetable"}`,U`${"id.tab.page.teamlist"}`]);const elems_must_reset=vjs(`.${cs.unzip("class.reset.order.hc.change")}`,true);elems_must_reset?.forEach((elem=>vjs.data(elem,"kh-cms-processed").delete("create")));vjs.empty(elems_must_reset);kh_cms.processTemplateContent(`.${cs.unzip("class.reset.order.hc.change")}`)}function onTimeCostChange(event){event=event.detail?.event??event;const input=event.target;if("blur"===event.type){setModified("",true===setModified(null))}else{let event_data=cs.jo_cur_event;let curTime=input.value;const key=U`${"id.time.cost.01"}`==input.getAttribute("id")?"time-cost-change":"time-cost-without-change";if(input.min<=curTime&&curTime<=input.max){event_data.paramz[key]=curTime;setModified(true,false)}else input.value=event_data.paramz[key]}}function onTimeTable(event){event=event.detail?.event??event;const input=event.target;if("blur"===event.type){setModified("",true===setModified(null))}else{const start_input=0==vjs.index(input);const event_data=cs.jo_cur_event;const index=vjs.index(input.parentNode);let set_data={[start_input?"start":"end"]:input.value};kh_cms.mergeData(event_data.timetable[index],set_data);setModified(true,false)}}function onMinPerCatChange(event){event=event.detail?.event??event;const input=event.target;const event_data=cs.jo_cur_event;event_data.paramz["min-per-cat"]=input.value;setModified(true,true)}function getDualListboxPrio(){const full_list=[new kh_cms.LVC({label:U`${"dbraw.basevoc.equal.boat.class"}`,value:cs.mergedCatOrders.mcoEqualBoatClass,attributes:{[kh_js.WindowArgs.tooltip]:U`${"dbraw.basevoc.equal.boat.class.tt"}`}}),new kh_cms.LVC({label:U`${"dbraw.basevoc.equal.league.class"}`,value:cs.mergedCatOrders.mcoEqualLeagueClass,attributes:{[kh_js.WindowArgs.tooltip]:U`${"dbraw.basevoc.equal.league.class.tt"}`}}),new kh_cms.LVC({label:U`${"dbraw.basevoc.visitors.boat"}`,value:cs.mergedCatOrders.mcoVisitorsBoat,attributes:{[kh_js.WindowArgs.tooltip]:U`${"dbraw.basevoc.visitors.boat.tt"}`}}),new kh_cms.LVC({label:U`${"dbraw.basevoc.additional.boat"}`,value:cs.mergedCatOrders.mcoThirdEye,attributes:{[kh_js.WindowArgs.tooltip]:U`${"dbraw.basevoc.additional.boat.tt"}`}}),new kh_cms.LVC({label:U`${"dbraw.basevoc.david.vs.goliath.class"}`,value:cs.mergedCatOrders.mcoDavidGoliath,attributes:{[kh_js.WindowArgs.tooltip]:U`${"dbraw.basevoc.david.vs.goliath.class.tt"}`}})];const event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))return undefined;const merged_cat_order=event_data.paramz["merged-cat-order"].map(cs.enforceNumber);const left_list=full_list.filter((entry=>-1==merged_cat_order.indexOf(entry.value)));const right_list=full_list.filter((entry=>-1!=merged_cat_order.indexOf(entry.value)));const ret=new kh_cms.LVC({attributes:{ui_model:"dual-listbox",accept_button:true,[kh_js.WindowArgs.tooltip]:U`${"dbraw.basevoc.prio.odd.n.teams.tt"}`,"data-argz":{left_label:U`${"dbraw.basevoc.not.consider.list"}`,right_label:U`${"dbraw.basevoc.consider.list"}`,left_command:U`${"event.prio.odd.n.teams.change"}-ignore-left`,right_command:U`${"event.prio.odd.n.teams.change"}`,right_list,left_list}}});const ns="DualListboxPrio";vjs.off(`.${ns}`,undefined,cs.getMainWindow());vjs.on(U`${"event.prio.odd.n.teams.change"}.${ns}`,(event=>{const div_consider=vjs(U`#${"id.prio.odd.n.teams"} div[class*="area-right"]`,false);const cur_right_list=kh_cms.attribute(div_consider,"each.value");const new_merged_cat_order=cur_right_list.map((entry=>{if(0>=entry.value)return entry.value.toString();else return entry.value.toString(16)}));kh_log.trace?.(T9`command triggered ${event} => ${new_merged_cat_order}`);event_data.paramz["merged-cat-order"]=new_merged_cat_order;setModified(true,true)}),cs.getMainWindow());return ret}function fillSelectCompetition(elem){try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let entries=(event_data.categories["holded-competition"]||[]).map((hC=>vjs.create("option",{value:hC,text:cs.getCompetitionNameFromMask(event_data,hC)})));if(!kh_js.isEmpty(entries)){entries.push(vjs.create("option",{value:-1,text:U`${"dbraw.basevoc.label.select.cat.all"}`}));event_data.categories.boat.forEach(((boat,boat_index)=>{const cat_for_boat=event_data.categories["holded-competition"].filter((hC=>boat_index==cs.getBoatIndexFromMask(hC)));if(!kh_js.isEmpty(cat_for_boat))entries.push(vjs.create("option",{value:JSON.stringify(cat_for_boat),text:U`${"dbraw.basevoc.label.select.boat.all"} ${cs.getBoatNameFromMask(event_data,cat_for_boat[0])}`}))}))}return entries}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function fillSelectSeries(elem){try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let ret=[];for(let i=0;i<event_data.paramz.n_forerun;++i)ret.push(new kh_cms.LVC({label:U`${"title.page.forerun"} ${i+1}`,value:[{v:i}],attributes:Object.fromEntries([[kh_js.WindowArgs.tooltip,U`${"dbraw.basevoc.label.select.series"} ${"title.page.forerun"} ${i+1}`]])}));if(1<event_data.paramz.n_forerun)ret.push(new kh_cms.LVC({label:U`${"title.page.forerun"} ${"dbraw.basevoc.over.all"}`,value:[{v:[...Array(event_data.paramz.n_forerun)].map(((v,i)=>i))}],attributes:Object.fromEntries([[kh_js.WindowArgs.tooltip,U`${"dbraw.basevoc.label.select.series"} ${"title.page.forerun"} ${"dbraw.basevoc.over.all"}`]])}));let n_finals=event_data.paramz.n_finals||1;for(let i=0;i<n_finals;++i)ret.push(new kh_cms.LVC({label:U`${"title.page.finalrun"}${1==n_finals?"":" "+(i+1)}`,value:[{f:i}],attributes:Object.fromEntries([[kh_js.WindowArgs.tooltip,U`${"dbraw.basevoc.label.select.series"} ${"title.page.finalrun"}${1==n_finals?"":" "+(i+1)}`]])}));if(1<n_finals){ret.push(new kh_cms.LVC({label:U`${"title.page.finalrun"} ${"dbraw.basevoc.over.all"}`,value:[{f:[...Array(n_finals)].map(((v,i)=>i))}],attributes:Object.fromEntries([[kh_js.WindowArgs.tooltip,U`${"dbraw.basevoc.label.select.series"} ${"title.page.finalrun"} ${"dbraw.basevoc.over.all"}`]])}))}if(!kh_js.isEmpty(ret)){let value_entries=[...Array(event_data.paramz.n_forerun)].map(((v,i)=>({v:i})));value_entries.push({v:[...Array(event_data.paramz.n_forerun)].map(((v,i)=>i))});value_entries.push(...[...Array(n_finals)].map(((v,i)=>({f:i}))));if(1<n_finals)value_entries.push({f:[...Array(n_finals)].map(((v,i)=>i))});ret.push(new kh_cms.LVC({label:U`${"dbraw.basevoc.label.select.series.all"}`,value:value_entries,attributes:{[kh_js.WindowArgs.tooltip]:U`${"dbraw.basevoc.label.select.series"} ${"dbraw.basevoc.over.all"}`}}))}return ret}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function fillSelectHeat(elem){try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let ret=event_data.foreruns.map(((forerun$seriesno,seriesno)=>{const frmt=frmtHeatNo.bind(null,"V",seriesno);return forerun$seriesno.map(((forerun$seriesno$heat,heatno)=>({text:frmt(heatno),value:forerun$seriesno$heat})))})).flatMap((v=>v));const frmt=frmtHeatNo.bind(null,"E",0);ret.splice(-1,0,...event_data.finalruns.map(((finalrun$heatno,heatno)=>({text:frmt(heatno),value:finalrun$heatno}))));kh_global.setTimeout((()=>kh_cms.doCommand(U`${"event.fill.handsout"}`,window.event,null,true)),100);return ret.map((heat=>`<option>${heat.text}</option>`))}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function onClearReport(event){let ori_argz=event.detail.argz;let activate=ori_argz[1];if(!activate){const table=vjs(U`#${"id.tab.page.report"} #${"id.report.table"}`);vjs.data(table,"content","");vjs.attr(table,"data-content","")}}function generateReport(event,{force_cat,force_series}={}){try{let page=getPanel(event.target);let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let cat_select_box=vjs(page,U`#${"id.report.select.cat"}`,false);let cat_selected=force_cat||cat_select_box.options[cat_select_box.selectedIndex].value;cat_selected="-1"===cat_selected?event_data.categories["holded-competition"]:[cat_selected];let series_select_box=vjs(page,U`#${"id.report.select.series"}`,false);let series_selected=force_series||JSON.parse(series_select_box.options[series_select_box.selectedIndex].value);let table_data_full=[];cat_selected.forEach((cat=>{try{const cat_arr=kh_js.isString(cat)&&JSON.parse(cat);if(Array.isArray(cat_arr))cat=cat_arr}catch(error){kh_log.info?.(T9`info/error in ${kh_js.currentFunctionName()} => ${error}`)}series_selected.forEach((series=>{const finals=kh_js.isValid(series["f"]);const seriesno=series[finals?"f":"v"];const team_list=cs.Team.getTeamList(event_data.teams,Array.isArray(cat)?0:cat,finals);const report_list=cs.getReportList(team_list,finals?event_data.finalruns:event_data.foreruns,seriesno,cat,"sum",finals&&!Array.isArray(cat)?"sort-heat":"sort-best");if(!kh_js.isEmpty(report_list)){let table_data=[],rank=0;kh_js.for_in(report_list,((k,entry)=>{const team=team_list.findByNo(entry.no);table_data.push(new kh_cms.LVC({label:++rank,value:team.name(Array.isArray(cat)?entry.cat:cat),attributes:{time:entry.res.ts,no:entry.no,full:kh_js.Class.toJSON2(entry,["res"]),info:entry.res.tt,team}}))}));let headline,tooltip,class_headline="kh-extra-head-dist-top";if(!Array.isArray(cat)){const competition_alias=cs.getCompetitionAliasFromMask(event_data,cat);if(!kh_js.isEmpty(competition_alias)){table_data_full.push(new kh_cms.LVC({label:competition_alias,value:"&nbsp;",attributes:{[kh_js.WindowArgs.classz]:class_headline,time:"&nbsp;"}}));class_headline="kh-extra-head"}headline=cs.getCompetitionNameFromMask(event_data,cat)}else{headline=U`${"dbraw.basevoc.label.select.boat.all.2"} ${cs.getBoatNameFromMask(event_data,cat[0])}`;tooltip=`(${cat.map((_cat=>cs.getCompetitionNameFromMask(event_data,_cat))).toString()})`}table_data_full.push(new kh_cms.LVC({label:headline,value:U`${finals?"title.page.finalrun":"title.page.forerun"} `+U`${Array.isArray(seriesno)?"dbraw.basevoc.over.all":finals?"":seriesno+1}`,attributes:{[kh_js.WindowArgs.classz]:class_headline,[kh_js.WindowArgs.tooltip]:tooltip,time:"&nbsp;"}}));table_data_full.push(new kh_cms.LVC({label:U`${"dbraw.basevoc.rank"}`,value:U`${"dbraw.basevoc.team.name"}`,attributes:{[kh_js.WindowArgs.classz]:"kh-extra-head-dist-bottom",time:U`${"dbraw.basevoc.heat.time"}`}}));table_data_full.push(...table_data)}}))}));setData4ReportList(table_data_full)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function generateCertificateList(even,data){try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let cat_selected=event_data.categories["holded-competition"];let table_data_full=[];cat_selected.forEach((cat=>{const team_list=cs.Team.getTeamList(event_data.teams);const report_list=cs.getReportList(team_list,event_data.foreruns,0,cat,"sum","sort-nop");if(!kh_js.isEmpty(report_list)){let table_data=[],rank=0;kh_js.for_in(report_list,((k,entry)=>table_data.push(new kh_cms.LVC({label:++rank,value:team_list.findByNo(entry.no).name(cat),attributes:{time:"&nbsp;"}}))));table_data_full.push(new kh_cms.LVC({label:cs.getCompetitionNameFromMask(event_data,cat),value:U`${"dbraw.basevoc.certificate.list"}`,attributes:{[kh_js.WindowArgs.classz]:"kh-extra-head-dist-top",time:"&nbsp;"}}));table_data_full.push(new kh_cms.LVC({label:U`${"dbraw.basevoc.rank"}`,value:U`${"dbraw.basevoc.team.name"}`,attributes:{[kh_js.WindowArgs.classz]:"kh-extra-head-dist-bottom",time:"&nbsp;"}}));table_data_full.push(...table_data)}}));setData4ReportList(table_data_full,true)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function generateDueList(even,data){try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let table_data_full=[];const team_list=cs.Team.getTeamList(event_data.teams);if(!kh_js.isEmpty(team_list)){table_data_full.push(new kh_cms.LVC({label:U`${"dbraw.basevoc.due.list"}`,value:"&nbsp",attributes:{[kh_js.WindowArgs.classz]:"kh-extra-head-dist-top",time:"&nbsp;"}}));table_data_full.push(new kh_cms.LVC({label:U`${"dbraw.basevoc.boat.no"}`,value:U`${"dbraw.basevoc.team.name"}`,attributes:{[kh_js.WindowArgs.classz]:"kh-extra-head-dist-bottom",time:U`${"dbraw.basevoc.amount"}`}}));table_data_full.push(...team_list.map(((team,idx)=>new kh_cms.LVC({label:idx+1,value:team.name(),attributes:{time:(team.pay_||350)+"€"}}))))}setData4ReportList(table_data_full,true)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function setData4ReportList(table_data,should_activate_tab=false){let col_3_with_content=false;function assignData4ReportList(){const table_element=vjs(U`#${"id.report.table"}`,false);vjs.data(table_element,"kh-cms-cell-create",((row_index,col_index,cell,cell_data,row_element)=>{const lvc=kh_cms.LVC.tryLVC(cell_data);if(lvc instanceof kh_cms.LVC){if(0==col_index)vjs.setContent(cell,lvc.label);else if(1==col_index){vjs.setContent(cell,lvc.value);vjs.attr(cell,{title:T9`${lvc.getAttribute(kh_js.WindowArgs.tooltip)||lvc.getAttribute("full")}`,dataInfo:T9`${lvc.getAttribute("team")?.company??""}`})}else if(2==col_index)vjs.setContent(cell,lvc.getAttribute("time").toString(true,10));else if(3==col_index){let info=lvc.getAttribute("info");if(!kh_js.isEmpty(info))col_3_with_content=true;else info="&nbsp;";vjs.setContent(cell,info)}const css_class=lvc.getAttribute(kh_js.WindowArgs.classz);if(!kh_js.isEmpty(css_class))row_element.classList.add(css_class)}return undefined}));vjs.data(table_element,"kh-cms-opt",table_data);vjs.data(table_element,"content",{[kh_js.WindowArgs.ui_model]:"table"});vjs.attr(table_element,"data-content","");kh_global.setTimeout((()=>{let add_class=U`${"class.not4print"}${!col_3_with_content?" hide-it":""}`;const elems=vjs(table_element,":scope > * > :nth-child(4)",true);elems?.forEach((elem=>elem.classList.add(...add_class.split(" "))))}),250)}if(true!==should_activate_tab)assignData4ReportList(table_data);else{activateTabPanel(U`#${"id.tab.page.report"}`);kh_global.setTimeout((()=>assignData4ReportList(table_data)),100)}}function onButtonClick(event){kh_log.trace?.(T9`event= ${event}`);const{event:ori_event,argz}=event.detail;if(ori_event.currentTarget&&ori_event.target&&ori_event.currentTarget!==ori_event.target){if(kh_js.isValid(ori_event.currentTarget.closest(U`.${"class.main.toolbar"}`))||"SPAN"==ori_event.target.tagName&&"BUTTON"==ori_event.currentTarget.tagName&&ori_event.target.parentNode==ori_event.currentTarget);else return}let target=ori_event.currentTarget||ori_event.target;if(cs.unzip("event.button.click")==event.type){if("BUTTON"==target.tagName||target.classList.contains("kh-button")){switch(target.name||target.getAttribute("name")){case"btn_forerun":generateForerun(vjs(target,"input",true)?.[0]?.value,vjs(target,"input",true)?.[1]?.checked);break;case"btn_finalrun":{const stable_sort=vjs(target,U`#${"id.create.finalrun.order.check"}`,false)?.checked;let double_race_order=vjs(target,U`#${"id.create.finalrun.nheats.check"}`,false)?.checked?cs.enumDoubleRaceOrder.drive_wait_full_:cs.enumDoubleRaceOrder.drive_noop_;if(cs.enumDoubleRaceOrder.drive_noop_!=double_race_order&&vjs(target,U`#${"id.create.finalrun.lenient.check"}`,false)?.checked){double_race_order=cs.enumDoubleRaceOrder.drive_lenient_}generateFinalrun(stable_sort,double_race_order);break}case"btn_filltime":fillHeatTime(ori_event,(()=>new cs.RaceTime(58e3+Math.random()*3e4)));break;case"btn_cleartime":fillHeatTime(ori_event);break;case"btn_report":generateReport(ori_event);break;case"btn_certlist":generateCertificateList(ori_event);break;case"btn_duelist":generateDueList(ori_event);break;case"btn_print":printCurrentPage(ori_event,argz);break;case"btn_save":saveCurrentData(ori_event,argz);break;case"btn_upload":uploadEventData(ori_event,argz);break;case"btn_info":vjs.trigger(U`${"event.show.dialog.lpc"}`,cs.getMainWindow(),U`${"dbraw.app.legal.link.name"}`);break;case"btn_help":showDocumentation(ori_event,argz);break}}else if("INPUT"==target.tagName){let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");switch(target.name){case"inp_eventdate":{let date_box=vjs("#"+cs.unzip("id.event.datebox"),false);if(kh_js.isValid(date_box?.value)){event_data["event-date"]=date_box.value;setModified(true,true)}break}}}else if("A"==target.tagName){const legal_privacy_copyright_names=U`${"dbraw.app.legal.link.name"} ${"dbraw.app.privacy.link.name"} ${"dbraw.app.copyright.link.name"}`.split(" ");const data_name=target.getAttribute("data-name");if(-1!=legal_privacy_copyright_names.indexOf(data_name)){vjs.trigger(U`${"event.show.dialog.lpc"}`,cs.getMainWindow(),data_name)}}}}function showDocumentation(event,data){globalThis.kh.storage.kh_js.open_doc("/app-doc")}function saveCurrentData(event,data){if(!WriteRights()){const report_page=getPanel(U`${"id.tab.page.report"}`);const cur_active_page=getPanel("active");const delay=cur_active_page==report_page?0:500;activateTabPanel(report_page);kh_global.setTimeout((()=>{const cat_select=vjs(report_page,U`#${"id.report.select.cat"}`,false);const cat_select_options=cat_select?.options;let series_select=vjs(report_page,U`#${"id.report.select.series"}`,false);const series_select_options=series_select?.options;if(!kh_js.isEmpty(cat_select_options)&&!kh_js.isEmpty(series_select_options)){const index_all_cats=[...cat_select_options].findIndex((entry=>-1==entry.value));if(-1!==index_all_cats)cat_select_options.selectedIndex=index_all_cats;const index_all_series=kh_js.indexOfMaxValue([...series_select_options],((cur_entry,cur_max_entry)=>{try{const length_cur=JSON.parse(cur_entry.value).length;const length_max=JSON.parse(cur_max_entry.value).length;return length_cur-length_max}catch(error){kh_log.warn?.(T9`possible incorrect entry in select boxes cat/series`)}}));if(-1!==index_all_series)series_select_options.selectedIndex=index_all_series;generateReport({target:report_page})}kh_global.setTimeout((()=>printCurrentPage()),500)}),delay)}else{return getEventData("/~data/events/selection").then((data=>getEventData("/~data/events/ALL_EVENTS/data").then((event_data=>{const data4dl={[`event-file-${data.selection.year}`]:event_data};kh_js.downloadContent2File({content:JSON.stringify(data4dl),filename:`${kh_js.getTimestamp4FileName()}-dbraw.json`})})))).catch((error=>{kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error)}))}}async function uploadEventData(event,data){kh_js.getFileContent4Upload().then((file_content=>{kh_log.trace?.(T9`${file_content}`);return kh_io.Util.fetchData("POST","~data/event-file",JSON.parse(file_content),{get_json:true})})).then((msg=>{const enumSocket=cs.enumSocket;const msg_type=enumSocket.valueOf(msg,enumSocket.attr_msg_type_);const msg_sub_type=enumSocket.valueOf(msg,enumSocket.attr_msg_sub_type_);const ok=enumSocket.mt_user_requ_==msg_type&&enumSocket.mt_should_override_==msg_sub_type;if(!ok);let stage_data=msg[enumSocket.attr_value_];if(kh_js.isString(stage_data))stage_data=JSON.parse(stage_data);const deferred=new kh_js.Deferred;const{promise,popup}=kh_dialog({options:{popup_class:U`${"class.upload.dialog"}`,action_text:U`${"button-yes"}`,cancel_text:U`${"button-no"}`},title:U`${"dbraw.basevoc.event.data.set"} ${"button-upload"}`,message:U`${"dbraw.basevoc.override.dialog.1"} «${stage_data.years}»`,logger:kh_log,async:true});promise.then((returnValue=>{deferred.resolve("ok"==returnValue?stage_data.years:[])}));return deferred})).then((years=>{debugger;if(kh_js.isString(years))years=JSON.parse(years);if(!Array.isArray(years))years=[years];return kh_io.Util.fetchData("POST","~data/event-file?stage=1",{years},{get_json:true})})).then((years=>{kh_log.info?.("successful upload data to server for following years",years)})).catch((error=>{if("cancel"!==error){kh_log.error?.(T9`error during upload: ${error}`);cs.setStatus(error)}}))}function showDialog_LPC(event){const legal_privacy_copyright_names=U`${"dbraw.app.legal.link.name"} ${"dbraw.app.privacy.link.name"} ${"dbraw.app.copyright.link.name"}`.split(" ");const lpc_flag=event.detail;if(-1!=legal_privacy_copyright_names.indexOf(lpc_flag)){if(U`${"dbraw.app.legal.link.name"}`==lpc_flag){return kh_dialog({options:{hide_icon:true,get_back:true,popup_class:lpc_flag,hide_cancel_button:true},message:vjs(U`#${"id.app.legal.notice.dlg"}`,false),title:U`${"legal-notice"}`})}if(U`${"dbraw.app.privacy.link.name"}`==lpc_flag){return kh_dialog({options:{hide_icon:true,get_back:true,popup_class:lpc_flag,hide_cancel_button:true},message:vjs(U`#${"id.app.privacy.policy.dlg"}`,false),title:U`${"privacy-policy"}`})}if(U`${"dbraw.app.copyright.link.name"}`==lpc_flag){return kh_copyright_dialog.vjsShow({mainWindow:cs.getMainWindow(),copyrightDialog:U`#${"id.app.copyright.dlg"}`,dialog_options:{popup_class:lpc_flag}})}}}function generateForerun(min_per_cat=1,random_list=false){try{if(!WriteRights())throw new cs.Error("invalid-access");let execute_local=true;let then_f=foreruns=>{cs.jo_cur_event["foreruns"]=foreruns;cs.prepareForerunData(cs.jo_cur_event);const forerun_tabs=[...Array(foreruns.length)].map(((v,i)=>U`${"id.tab.page.forerun"}_${i+1}`));setModified(true,true,undefined,forerun_tabs);refreshView(forerun_tabs,true);cs.setStatus(`${cs.unzip("dbraw.basevoc.btn.forerun")} ${cs.unzip("dbraw.basevoc.executed")}`,"inf")};try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let foreruns=cs.generateForerunList(event_data,min_per_cat,random_list);then_f(foreruns)}catch(error){execute_local=false;kh_io.Util.fetchData("PATCH",`/~data/events/CUR_EVENT/data/foreruns?${new URLSearchParams({min_per_cat,random_list}).toString()}`,undefined,{get_native:true}).then((response=>{if(!response.ok)return Promise.reject(new cs.Error({status:response.status,msg:"dbraw.error.execution.fails"}));else return response.json()})).then(then_f).catch((err=>{kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${err}`);cs.setStatus(err)}))}}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function generateFinalrun(stable_sort=true,double_race_order=cs.enumDoubleRaceOrder.drive_noop_,merged_cat_order){try{if(!WriteRights())throw new cs.Error("invalid-access");let execute_local=true;let then_f=finalruns=>{cs.jo_cur_event["finalruns"]=finalruns;cs.prepareFinalrunData(cs.jo_cur_event);const finalrun_tab=U`${"id.tab.page.finalrun"}`;setModified(true,true,undefined,finalrun_tab);refreshView(finalrun_tab,true);cs.setStatus(`${cs.unzip("dbraw.basevoc.btn.finalrun")} ${cs.unzip("dbraw.basevoc.executed")}`,"inf")};try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");let finalruns=cs.generateFinalrunList(event_data,stable_sort,double_race_order,merged_cat_order);then_f(finalruns)}catch(error){execute_local=false;kh_io.Util.fetchData("PATCH",`/~data/events/CUR_EVENT/data/finalruns?${new URLSearchParams({stable_sort,double_race_order,merged_cat_order}).toString()}`,undefined,{get_native:true}).then((response=>{if(!response.ok)return Promise.reject(new cs.Error({status:response.status,msg:"dbraw.error.execution.fails"}));else return response.json()})).then(then_f).catch((err=>{kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${err}`);cs.setStatus(err)}))}}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function seperatePostfixedIds(id_attr){if(!kh_js.isString(id_attr))return id_attr;let idm=/^([A-ZÄÖÜa-zäöüß_]+)_(\d+)/.exec(id_attr);return{id:idm?.[1]||id_attr,seriesno:Number.parseInt(idm?.[2])}}function printPage(page_index,event,argz){try{const print_as_pdf="pdf"==argz[2]^true==event?.shiftKey;kh_log.debug?.(T9`🖶🖶🖶🖶🖶🖶 print page ${page_index}, opt= ${argz} 🖶🖶🖶🖶🖶🖶, ${print_as_pdf}`);let page_to_print=getPanel(page_index);if(!kh_js.isValid(page_to_print))throw new cs.Error("param-not-determined","page 4 Print");let{id,seriesno}=seperatePostfixedIds(page_to_print.getAttribute("id"));vjs.data(U`.${"class.print.dialog"}`,"dialog")?.forEach((pops=>pops?.hidePopup()));let page4print=vjs.create("div",{class:U`${"class.page4print"}`});let title_and_logo=new TitleAndLogo;title_and_logo.connectedCallback();title_and_logo.direction="horizontal";title_and_logo.style.display="block";page4print.append(title_and_logo);const page_header=vjs.create("div",{data:{content:new kh_cms.LVC({label:page_to_print.getAttribute("title"),attributes:{[kh_js.WindowArgs.ui_model]:cs.unzip("templ.print.page.header")}})},dataContent:""},page4print);const page_footer=vjs.create("div",{data:{content:new kh_cms.LVC({attributes:{[kh_js.WindowArgs.ui_model]:cs.unzip("templ.print.page.footer")}})},dataContent:""},page4print);let landscape=false;let force_one_side=true;const id_stem_forerun=U`${"id.tab.page.forerun"}`;const id_stem_finalrun=U`${"id.tab.page.finalrun"}`;switch(id){case U`${"id.tab.page.timetable"}`:{const time_table=vjs(page_to_print,U`#${"id.time.table"}`,false)?.cloneNode(true);page4print.append(time_table);break}case U`${"id.tab.page.handsout"}`:{page4print.insertAdjacentHTML("beforeend",vjs(page_to_print,U`#${"id.handsout.paper"}`,false)?.innerHTML);break}case U`${"id.tab.page.teamlist"}`:{page4print.append(vjs(page_to_print,U`#${"id.team.table"}`,false).cloneNode(true));break}case id_stem_forerun:case id_stem_finalrun:{const apportion_msg=vjs(page_to_print,U`#${"id.track.apportion.msg"}`,false);if(kh_js.isValid(apportion_msg))page4print.append(apportion_msg.cloneNode(true));const selector=id_stem_forerun==id?U`#${"id.foreruns.table"}-${seriesno-1}`:U`[id^="${"id.finalruns.table"}"]`;page4print.append(vjs(page_to_print,selector,false)?.parentNode?.cloneNode(true));landscape=true;break}case U`${"id.tab.page.report"}`:{let cat_select=vjs(page_to_print,U`#${"id.report.select.cat"}`,false);let cat=cat_select.options[cat_select.selectedIndex].text;let series_select=vjs(page_to_print,U`#${"id.report.select.series"}`,false);let series=series_select.options[series_select.selectedIndex].text;const contentLVC=vjs.data(page_header,"content");if(kh_js.isValid(contentLVC))contentLVC.value=`${cat} --- ${series}`;const report_table=vjs(page_to_print,U`#${"id.report.table"}`,false).cloneNode(true);vjs.attr(report_table,"data-content",null);page4print.append(report_table);force_one_side=false;break}default:{throw new kh_js.Error(`invalid page id(${id}) for print`)}}if(true==event?.ctrlKey&&"P"!=event.key?.toUpperCase()){switch(id){case id_stem_forerun:case id_stem_finalrun:{vjs(page4print,U`:is(.${"class.heat.starttime.col"}, .${"class.heat.heattime.col"})`,true)?.forEach((col=>col.classList.toggle(U`${"class.not4print"}`)));break}}}vjs.style(page4print.children,{"padding-bottom":"1em"});vjs.attr(vjs(page4print,"[data-create]",true),"data-create",null);const options={position:"top-pos-left",popup_class:U`${"class.print.dialog"}${!print_as_pdf?" real-print":""}`,popup_stay:true,prevent_modal:!!kh_js.isChromium()};const print_popup=kh_info({options,message:page4print});const ns=`${mf}.${kh_js.getRandomArbitrary()|0}`;const promises=[kh_cms.processTemplateContent([title_and_logo,page_header,page_footer]),print_as_pdf?import("jsPDF"):Promise.resolve(true)];Promise.all(promises).then((async([_,jsPDF_module])=>{vjs(page4print,"input",true)?.forEach((inp=>{if(-1==inp.classList.value.indexOf("hide-it")){let span=vjs.create("span",{style:{minWidth:"5em",display:"inline-block",paddingRight:"0.5em",...vjs.style(inp)},class:inp.classList.value,text:inp.value});inp.parentNode.replaceChild(span,inp)}}));if(print_as_pdf){const jsPDF=jsPDF_module.default;page_header.setAttribute("data-html2canvas-ignore",true);page_footer.setAttribute("data-html2canvas-ignore",true);class paper{#paper_;static#papers_=new Map([["a5",{height:210,width:148.5}],["a4",{height:297,width:210}],["a3",{height:420,width:297}]].map((([k,v])=>[k,{...v,orientation:"portrait",format:k}])));constructor({height,width,format,orientation="portrait"}){if(1==arguments.length&&kh_js.isString(arguments[0]))format=arguments[0];const known_paper=paper.#papers_.get(format);if(!kh_js.isNumber(height)&&!kh_js.isNumber(width)){if(kh_js.isValid(known_paper)){this.#paper_={format,...known_paper};this.setOrientation(orientation)}else throw new kh_js.Error({msg:"param-invalid"})}else{if(kh_js.isValid(known_paper)){this.#paper_={format,...known_paper,height,width};this.setOrientation(orientation)}else{paper.#papers_.set(format,this.#paper_={height,width,format,orientation})}}}get orientation(){return this.#paper_.orientation}get height(){return+this.#paper_.height}get width(){return+this.#paper_.width}set orientation(orientation){this.#paper_.orientation=orientation}set height(height){this.#paper_.height=+height}set width(width){this.#paper_.width=+width}swap(){this.setOrientation("portrait"==this.orientation?"landscape":"portrait")}setOrientation(orientation="portrait"){if(this.orientation!==orientation){this.orientation=orientation;[this.width,this.height]=[this.height,this.width]}}}const cur_paper=new paper("a4");if(landscape)cur_paper.swap();const doc=new jsPDF({orientation:cur_paper.orientation,format:cur_paper.format});const margins={top:20,right:25,bottom:20,left:25};const filename=`${page_to_print.getAttribute("title")}.pdf`;const addHeaderFooter=doc=>{const pageCount=doc.internal.getNumberOfPages();doc.setFont("helvetica","italic");doc.setFontSize(8);for(let i=1;i<=pageCount;++i){doc.setPage(i);doc.text(page_header.innerText,10,10);doc.text(U`${"dbraw.basevoc.page"} ${i}/${pageCount}`,doc.internal.pageSize.width/2,cur_paper.height-10,{align:"center"});doc.text(page_footer.innerText,cur_paper.width-10,cur_paper.height-10,{align:"right"})}};const own_canvas=false;const ww=vjs.size(page4print);const canvas=own_canvas?vjs.create("canvas",{height:ww.height,width:ww.width},cs.getMainWindow()):undefined;page4print.classList.add(U`${"class.print.dialog"}`);const callback=doc=>{addHeaderFooter(doc);doc.save(filename);if(kh_js.isValid(canvas))page4print.insertAdjacentElement("afterend",canvas);print_popup.hidePopup();if(kh_js.isValid(kh_global["#Promise"]))kh_global.Promise=kh_js.Promise};if(force_one_side){const html2canvas=(await import("html2canvas")).default;const quality=1;html2canvas(page4print,{scale:quality,canvas}).then((canvas=>{let{height,width}=canvas;kh_log.trace?.(`Height/Width= ${height}/${width}`);const orientation=height>=width?"portrait":"landscape";cur_paper.setOrientation(orientation);const r_image=Math.max(height,width)/Math.min(height,width);({height,width}=cur_paper);height-=margins.top+margins.bottom;width-=margins.left+margins.right;const r_page=Math.max(height,width)/Math.min(height,width);if("portrait"==orientation){if(r_image<r_page)height=width*r_image;else width=height/r_image}else{if(r_image<r_page)width=height*r_image;else height=width/r_image}doc.addImage(canvas,"JPEG",margins.left,margins.top,width,height);callback(doc)}))}else{if(kh_js.isValid(kh_global["#Promise"]))kh_global.Promise=kh_global["#Promise"];doc.html(page4print,{callback,margin:Object.values(margins),autoPaging:"text",html2canvas:{},x:0,y:0,width:cur_paper.width-margins.left-margins.right,windowWidth:vjs.size(page4print).width})}}else{ms["kh-ws"].suspend();let suspended=true;const ap_listener=(event,action="close")=>{if(true==suspended){ms["kh-ws"].resume();suspended=false}switch(action){case"close":print_popup.hidePopup({async:true});break}};vjs.one(`afterprint.${ns}`,ap_listener,window);vjs.on(`close.${ns}`,(event=>{if(true==suspended){ap_listener(undefined,"off")}vjs.off(`.${ns}`)}),print_popup.Șdom);window.print()}})).catch((error=>{kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}))}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function printCurrentPage(event,argz){try{printPage(getPanel("active"),event,argz)}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function onFillHandsout(event){let ori_argz=event.detail.argz;let activate=ori_argz[1];if(false==activate)return;const no=Number.parseInt(ori_argz[2]);try{let event_data=cs.jo_cur_event;if(!kh_js.isValid(event_data))throw new cs.Error("param-not-determined","event_data");const cat_mapper=cat=>cat&&cat["values"]&&cat.values().next().value||Array.isArray(cat)&&cat[0]||cat;const handsout=vjs(U`#${"id.handsout.paper"}`,false);if(!kh_js.isValid(handsout))return;const indexes=kh_js.isNumber(no)&&!isNaN(no)?[no]:[...Array(handsout.children.length)].map(((v,i)=>i));indexes.forEach((idx=>{const handsout_block=handsout.children[idx];const inp_field=vjs(handsout_block,U`*[id^="${"id.handsout.select.heat"}"]`,false);if(!kh_js.isValid(inp_field))return;const heatno_s=inp_field?.value.trim();const tracks_block=vjs(handsout_block,U`*[id^="${"id.handsout.tracks"}"]`,false);vjs.empty(tracks_block);const competition_span=vjs(handsout_block,U`*[id^="${"id.handsout.competition"}"]`,false);vjs.empty(competition_span);const heatno_mirror_span=vjs(handsout_block,U`*[id^="${"id.handsout.mirror.heat"}"]`,false);vjs.empty(heatno_mirror_span);if(!/[E,V][1,2]\d\d/.test(heatno_s)){if(!kh_js.isEmpty(heatno_s))kh_log.warn?.("invalid input in field: ",heatno_s)}else{const finals="E"==heatno_s[0];const heatno=Number.parseInt(heatno_s.substring(1))>>>0;const series_no=finals?0:heatno/100-1>>>0;const series=finals?event_data.finalruns:event_data.foreruns[series_no];const cur_heat=series[heatno%100-1>>>0];const cat_0=cat_mapper(cur_heat[0].cat);const heat_all_cats_same=cur_heat.every((team=>cat_0==cat_mapper(team.cat)));const competition_names=new Set;competition_names.add(cs.getCompetitionNameFromMask(event_data,cat_0));cur_heat.forEach(((team,trackno)=>{if(!kh_js.isValid(team.no))return;const Ștrack_div=vjs.NodeFromTemplate("handsout-track-block");vjs.data(Ștrack_div,"data-track",trackno);const Șspans=vjs(Ștrack_div,"span",true);if(0<Șspans?.length)Șspans[0].textContent=U`${"dbraw.basevoc.number"} ${team.no.toString().padStart(2," ")} ${event_data.teams.findByNo(team.no).name(team.cat)}`;if(1<Șspans?.length)Șspans[1].textContent=team.time.toString();tracks_block.append(...Ștrack_div);if(!heat_all_cats_same)competition_names.add(cs.getCompetitionNameFromMask(event_data,cat_mapper(team.cat)))}));competition_span.insertAdjacentHTML("afterbegin",[...competition_names.values()].join(" / "));heatno_mirror_span.insertAdjacentHTML("afterbegin",U`${"dbraw.basevoc.heat"} ${heatno_s}: `)}}))}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}function switchStatusLED(event){const connected=event.detail;const status_led=vjs(U`.${"class.status.led"}`,false);if(kh_js.isValid(status_led)){status_led.classList.remove(U`${`class.status.led${connected?".not":""}.connected`}`,U`${"class.status.led.writer"}`);status_led.classList.add(U`${`class.status.led${connected?"":".not"}.connected`}`);if(connected&&WriteRights())status_led.classList.add(U`${"class.status.led.writer"}`);return true}}function open_socket(ws_url){return kh_io.WebSocket.create_and_open(ws_url,{msg:{open:{[cs.enumSocket.attr_msg_type_]:cs.enumSocket.mt_socket_status_,[cs.enumSocket.attr_value_]:"accepted"},unload:{[cs.enumSocket.attr_msg_type_]:cs.enumSocket.mt_socket_status_,[cs.enumSocket.attr_msg_value_]:"closed"},suspend:{[cs.enumSocket.attr_msg_type_]:cs.enumSocket.mt_socket_status_,[cs.enumSocket.attr_msg_sub_type_]:cs.enumSocket.mt_watchdog_,[cs.enumSocket.attr_value_]:"suspend"},resume:{[cs.enumSocket.attr_msg_type_]:cs.enumSocket.mt_socket_status_,[cs.enumSocket.attr_msg_sub_type_]:cs.enumSocket.mt_watchdog_,[cs.enumSocket.attr_value_]:"resume"}},pong_sender:true}).then((data=>{const ws=data.socket;ms["kh-ws"]=ws;ws.addEventListener("error",(e=>{vjs.trigger(U`${"event.switch.led"}`,cs.getMainWindow(),false)}));ws.addEventListener("close",(e=>{vjs.trigger(U`${"event.switch.led"}`,cs.getMainWindow(),false);{kh_log.info?.(T9`try reconnect to websocket server`);const urlParams=new URLSearchParams(window.location.search);const selected_event=getEventSelector()?.selectedIndex??0;const Șpanels=vjs(ms.panels_selector,true);const panelsParent=Șpanels[0].parentNode;const tabs_component=Tabs.glue(panelsParent,Tabs);const tab_index=tabs_component.active()??0;urlParams.set("event",selected_event);urlParams.set("tabno",tab_index);kh_js.defer(5e3).then((()=>window.location.search=urlParams.toString()))}}));ws.addEventListener("message",on_ws_message.bind(undefined,ws));return Promise.resolve(ws)}))}function connect_to_server(){try{let ws_url_obj=kh_io.WebSocketUtil.name_builder_simple({room:"db"});let ws_url=ws_url_obj.url;open_socket(ws_url).then((ws=>{const pos_last_slash=ws_url.lastIndexOf("/");ws["uuid"]=ws_url_obj.room}))}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);cs.setStatus(error);return false}}let WriteRights=()=>false;const WriteRightsP=new kh_js.Deferred(15e3,undefined,"server timeout");function on_ws_message(ws,message_event){try{kh_log.trace?.(T9`ws message on ${ws.shortName()} => ${message_event.data}`);const enumSocket=cs.enumSocket;let msgs=JSON.parse(message_event.data);if(!Array.isArray(msgs))msgs=[msgs];msgs.forEach((msg=>{if(kh_js.isString(msg)){if("ping"===msg||"pong"===msg)return;if("pp"===msg)return}let msg_type=enumSocket.valueOf(msg,enumSocket.attr_msg_type_);let msg_sub_type=enumSocket.valueOf(msg,enumSocket.attr_msg_sub_type_);switch(msg_type){case enumSocket.mt_socket_status_:{break}case enumSocket.mt_app_status_:{switch(msg_sub_type){case enumSocket.mt_user_right_:{const write_rights=kh_js.string2bool(msg[enumSocket.attr_value_]);WriteRights=()=>write_rights;WriteRightsP.resolve(write_rights);vjs.body.setAttribute("data-access",write_rights?"write":"user");if(write_rights){const overlay_childs=vjs(U`.${"class.overlay.full"}`,false).children;vjs.empty(overlay_childs);vjs.attr(overlay_childs,"data-content",null)}const intv_f=n_call=>{const status_led=vjs(U`.${"class.status.led"}`,false);if(kh_js.isValid(status_led)){vjs.trigger(U`${"event.switch.led"}`,cs.getMainWindow(),true);return true}return 15<n_call};const intv_f2=(()=>{let z=0;return()=>{kh_log.debug?.(z,vjs(U`.${"class.status.led"}`,true)?.length);if(false==intv_f(++z))kh_global.setTimeout(intv_f2,500+2**z/10)}})();kh_global.setTimeout(intv_f2,500);kh_log.info?.("You have write rights?",WriteRights());break}case enumSocket.mt_app_settings_:{cs.app_settings=(()=>{if(kh_js.isObject(msg[enumSocket.attr_value_]))return msg[enumSocket.attr_value_];try{return JSON.parse(msg[enumSocket.attr_value_])}catch(ee){return{}}})();ws.heartbeatIntervall=(Number.parseInt(cs.app_settings.watchdog_itervall)||3e4)>>>0;cs.app_settings.force_auto_save||=cs.uni_flag;respect_enabled_tabs();break}case enumSocket.mt_refresh_view_:{refreshView(msg[enumSocket.attr_value_]);break}}break}case enumSocket.mt_broadcast_:{kh_log.debug?.("Broadcastmessage empfangen");break}default:break}}))}catch(error){if("ping"==message_event.data||"pong"==message_event.data)return;if("pp"===message_event.data)return;kh_log.info?.(T9`unexpected error or ws message with unknown data format / ${message_event.data} / ${error}`)}}async function refreshView(what,internal=false){try{if("full"===what){return window.location.reload()}else{const event_key=getEventKey();if(!kh_js.isValid(event_key))throw new cs.Error("param-not-determined","event_key");const filename="/~data/events/CUR_EVENT/data";return(internal?Promise.resolve(true):getEventData(filename).then((async json=>{if(true!==json)cs.jo_cur_event=cs.jo_all_events["events"][event_key]=json;return true}))).then((async result=>{kh_log.trace?.(`request für tab page(s) refresh «${what}»`);let value=what;if(kh_js.isObject(value)&&kh_js.isValid(value.page)){const panel=vjs(`#${value.page}`,false);if(true==vjs.data(panel,"dbraw-panel-was-activated")){const cell=vjs(value.selector,false);if(kh_js.isValid(cell))cell.value=value.value}}else{if(!Array.isArray(value))value=[value];value=value.map((val=>`#${val}`));const Șpanels=vjs(value.join(","),true);Șpanels.forEach((panel=>{if(true===vjs.data(panel,"dbraw-panel-was-activated")){let{id,seriens_no}=seperatePostfixedIds(panel.getAttribute("id"));switch(id){case U`${"id.tab.page.timetable"}`:{const elems_must_reset=vjs(panel,"[data-create]",true);elems_must_reset?.forEach((elem=>vjs.data(elem,"kh-cms-processed").delete("create")));vjs.empty(elems_must_reset);kh_cms.processTemplateContent(panel,undefined,"async");break}case U`${"id.tab.page.teamlist"}`:{const elems_must_reset=vjs(panel,U`.${"class.reset.order.hc.change"}`,true);elems_must_reset?.forEach((elem=>vjs.data(elem,"kh-cms-processed").delete("create")));vjs.empty(elems_must_reset);kh_cms.processTemplateContent(panel,undefined,"async");break}case U`${"id.tab.page.finalrun"}`:case U`${"id.tab.page.forerun"}`:{let table_elem=vjs(panel,`:scope [class*="kh-table-nw"]`,false);const uic=vjs.data(table_elem,"ui-context");uic?.trigger_refresh();break}}}}))}return value})).catch((async error=>{kh_log.error?.("Error request data",error);throw error}))}}catch(error){kh_log.error?.(T9`error in ${kh_js.currentFunctionName()} => ${error}`);throw error}}class TitleAndLogo extends HTMLElement{constructor(){super();this.showDate=true}static get observedAttributes(){return["direction"]}set direction(d){let new_direction_class=kh_cb.class_from_orient(kh_js.isValid(d)?d:"horizontal");d=kh_cb.orient_from_class(new_direction_class);const first_child=this.children[0];console.assert(first_child==vjs(this,":scope > :nth-child(1)",false),"check vjs()");if(kh_js.isValid(first_child)){if(this.cur_direction_class_!==new_direction_class){first_child.classList.remove(this.cur_direction_class_);first_child.classList.add(this.cur_direction_class_=new_direction_class);if(!this.attributes.direction||this.attributes.direction.nodeValue!==d)this.setAttribute("direction",d)}first_child.classList.add("kh-not-grow","kh-align-start")}}set showDate(show){if(!kh_js.isValid(show))return;const date_elem=vjs(this,":scope > :nth-child(1) > :nth-child(3)",false);if(kh_js.string2bool(show))date_elem?.classList.remove("hide-it");else date_elem?.classList.add("hide-it")}connectedCallback(){if(!kh_js.isEmpty(this.children))return;this.prepend(...vjs.NodeFromTemplate("title-and-logo"));this.direction=this.getAttribute("direction");this.showDate=this.getAttribute("show-date")}attributeChangedCallback(name,oldValue,newValue){}}window.customElements.define("title-and-logo",TitleAndLogo);Object.assign(cs,{inlineEditing,createTeamTable,createForerunTable,createFinalrunTable,createHoldedCompetitionTable,getEventTitle,getDualListboxPrio,fillSelectCompetition,fillSelectSeries,fillSelectHeat});kh_global.LoadedScripts.get(mf).resolve(ms);